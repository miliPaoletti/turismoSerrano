"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[16],{19:function(e,t,n){n.d(t,{IO:function(){return lc},JU:function(){return Eu},Jm:function(){return _u},UQ:function(){return bc},Xo:function(){return mc},ad:function(){return Su},ar:function(){return dc},b9:function(){return pc},fH:function(){return Nu},hJ:function(){return Iu},nP:function(){return Dc},r7:function(){return Sc},zN:function(){return Tc}});var s=n(5816),r=n(8463),i=n(3333),o=n(4444),a=n(3510),u=n(3454);const c="@firebase/firestore";class l{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}l.UNAUTHENTICATED=new l(null),l.GOOGLE_CREDENTIALS=new l("google-credentials-uid"),l.FIRST_PARTY=new l("first-party-uid"),l.MOCK_USER=new l("mock-user");let h="9.9.2";const d=new i.Yd("@firebase/firestore");function f(){return d.logLevel}function m(e,...t){if(d.logLevel<=i.in.DEBUG){const n=t.map(y);d.debug(`Firestore (${h}): ${e}`,...n)}}function g(e,...t){if(d.logLevel<=i.in.ERROR){const n=t.map(y);d.error(`Firestore (${h}): ${e}`,...n)}}function p(e,...t){if(d.logLevel<=i.in.WARN){const n=t.map(y);d.warn(`Firestore (${h}): ${e}`,...n)}}function y(e){if("string"==typeof e)return e;try{return t=e,JSON.stringify(t)}catch(t){return e}var t}function w(e="Unexpected state"){const t=`FIRESTORE (${h}) INTERNAL ASSERTION FAILED: `+e;throw g(t),new Error(t)}function v(e,t){e||w()}function I(e,t){return e}const E={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class b extends o.ZR{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class T{constructor(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class S{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class x{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable((()=>t(l.UNAUTHENTICATED)))}shutdown(){}}class D{constructor(e){this.t=e,this.currentUser=l.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){let n=this.i;const s=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve();let r=new T;this.o=()=>{this.i++,this.currentUser=this.u(),r.resolve(),r=new T,e.enqueueRetryable((()=>s(this.currentUser)))};const i=()=>{const t=r;e.enqueueRetryable((async()=>{await t.promise,await s(this.currentUser)}))},o=e=>{m("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((e=>o(e))),setTimeout((()=>{if(!this.auth){const e=this.t.getImmediate({optional:!0});e?o(e):(m("FirebaseAuthCredentialsProvider","Auth not yet detected"),r.resolve(),r=new T)}}),0),i()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then((t=>this.i!==e?(m("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(v("string"==typeof t.accessToken),new S(t.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const e=this.auth&&this.auth.getUid();return v(null===e||"string"==typeof e),new l(e)}}class N{constructor(e,t,n){this.type="FirstParty",this.user=l.FIRST_PARTY,this.headers=new Map,this.headers.set("X-Goog-AuthUser",t);const s=e.auth.getAuthHeaderValueForFirstParty([]);s&&this.headers.set("Authorization",s),n&&this.headers.set("X-Goog-Iam-Authorization-Token",n)}}class A{constructor(e,t,n){this.h=e,this.l=t,this.m=n}getToken(){return Promise.resolve(new N(this.h,this.l,this.m))}start(e,t){e.enqueueRetryable((()=>t(l.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class C{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class k{constructor(e){this.g=e,this.forceRefresh=!1,this.appCheck=null,this.p=null}start(e,t){const n=e=>{null!=e.error&&m("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);const n=e.token!==this.p;return this.p=e.token,m("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable((()=>n(t)))};const s=e=>{m("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.g.onInit((e=>s(e))),setTimeout((()=>{if(!this.appCheck){const e=this.g.getImmediate({optional:!0});e?s(e):m("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then((e=>e?(v("string"==typeof e.token),this.p=e.token,new C(e.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}function _(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let s=0;s<e;s++)n[s]=Math.floor(256*Math.random());return n}class V{static I(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=Math.floor(256/e.length)*e.length;let n="";for(;n.length<20;){const s=_(40);for(let r=0;r<s.length;++r)n.length<20&&s[r]<t&&(n+=e.charAt(s[r]%e.length))}return n}}function M(e,t){return e<t?-1:e>t?1:0}function R(e,t,n){return e.length===t.length&&e.every(((e,s)=>n(e,t[s])))}function O(e){return e+"\0"}class L{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new b(E.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new b(E.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new b(E.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new b(E.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return L.fromMillis(Date.now())}static fromDate(e){return L.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new L(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?M(this.nanoseconds,e.nanoseconds):M(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class F{constructor(e){this.timestamp=e}static fromTimestamp(e){return new F(e)}static min(){return new F(new L(0,0))}static max(){return new F(new L(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class P{constructor(e,t,n){void 0===t?t=0:t>e.length&&w(),void 0===n?n=e.length-t:n>e.length-t&&w(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===P.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof P?e.forEach((e=>{t.push(e)})):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let s=0;s<n;s++){const n=e.get(s),r=t.get(s);if(n<r)return-1;if(n>r)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class U extends P{construct(e,t,n){return new U(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(n.indexOf("//")>=0)throw new b(E.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter((e=>e.length>0)))}return new U(t)}static emptyPath(){return new U([])}}const B=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class q extends P{construct(e,t,n){return new q(e,t,n)}static isValidIdentifier(e){return B.test(e)}canonicalString(){return this.toArray().map((e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),q.isValidIdentifier(e)||(e="`"+e+"`"),e))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new q(["__name__"])}static fromServerFormat(e){const t=[];let n="",s=0;const r=()=>{if(0===n.length)throw new b(E.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;s<e.length;){const t=e[s];if("\\"===t){if(s+1===e.length)throw new b(E.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[s+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new b(E.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,s+=2}else"`"===t?(i=!i,s++):"."!==t||i?(n+=t,s++):(r(),s++)}if(r(),i)throw new b(E.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new q(t)}static emptyPath(){return new q([])}}class K{constructor(e){this.path=e}static fromPath(e){return new K(U.fromString(e))}static fromName(e){return new K(U.fromString(e).popFirst(5))}static empty(){return new K(U.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===U.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return U.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new K(new U(e.slice()))}}class G{constructor(e,t,n,s){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=s}}function $(e){return e.fields.find((e=>2===e.kind))}function z(e){return e.fields.filter((e=>2!==e.kind))}G.UNKNOWN_ID=-1;class j{constructor(e,t){this.fieldPath=e,this.kind=t}}class Q{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new Q(0,J.min())}}function H(e,t){const n=e.toTimestamp().seconds,s=e.toTimestamp().nanoseconds+1,r=F.fromTimestamp(1e9===s?new L(n+1,0):new L(n,s));return new J(r,K.empty(),t)}function W(e){return new J(e.readTime,e.key,-1)}class J{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new J(F.min(),K.empty(),-1)}static max(){return new J(F.max(),K.empty(),-1)}}function Y(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=K.comparator(e.documentKey,t.documentKey),0!==n?n:M(e.largestBatchId,t.largestBatchId))}const X="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class Z{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((e=>e()))}}async function ee(e){if(e.code!==E.FAILED_PRECONDITION||e.message!==X)throw e;m("LocalStore","Unexpectedly lost primary lease")}class te{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e((e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)}),(e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)}))}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&w(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new te(((n,s)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,s)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,s)}}))}toPromise(){return new Promise(((e,t)=>{this.next(e,t)}))}wrapUserFunction(e){try{const t=e();return t instanceof te?t:te.resolve(t)}catch(e){return te.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction((()=>e(t))):te.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction((()=>e(t))):te.reject(t)}static resolve(e){return new te(((t,n)=>{t(e)}))}static reject(e){return new te(((t,n)=>{n(e)}))}static waitFor(e){return new te(((t,n)=>{let s=0,r=0,i=!1;e.forEach((e=>{++s,e.next((()=>{++r,i&&r===s&&t()}),(e=>n(e)))})),i=!0,r===s&&t()}))}static or(e){let t=te.resolve(!1);for(const n of e)t=t.next((e=>e?te.resolve(e):n()));return t}static forEach(e,t){const n=[];return e.forEach(((e,s)=>{n.push(t.call(this,e,s))})),this.waitFor(n)}static mapArray(e,t){return new te(((n,s)=>{const r=e.length,i=new Array(r);let o=0;for(let a=0;a<r;a++){const u=a;t(e[u]).next((e=>{i[u]=e,++o,o===r&&n(i)}),(e=>s(e)))}}))}static doWhile(e,t){return new te(((n,s)=>{const r=()=>{!0===e()?t().next((()=>{r()}),s):n()};r()}))}}class ne{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.T=new T,this.transaction.oncomplete=()=>{this.T.resolve()},this.transaction.onabort=()=>{t.error?this.T.reject(new ie(e,t.error)):this.T.resolve()},this.transaction.onerror=t=>{const n=le(t.target.error);this.T.reject(new ie(e,n))}}static open(e,t,n,s){try{return new ne(t,e.transaction(s,n))}catch(e){throw new ie(t,e)}}get A(){return this.T.promise}abort(e){e&&this.T.reject(e),this.aborted||(m("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}R(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){const t=this.transaction.objectStore(e);return new ae(t)}}class se{constructor(e,t,n){this.name=e,this.version=t,this.P=n,12.2===se.v((0,o.z$)())&&g("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return m("SimpleDb","Removing database:",e),ue(window.indexedDB.deleteDatabase(e)).toPromise()}static V(){if(!(0,o.hl)())return!1;if(se.S())return!0;const e=(0,o.z$)(),t=se.v(e),n=0<t&&t<10,s=se.D(e),r=0<s&&s<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||n||r)}static S(){var e;return"undefined"!=typeof u&&"YES"===(null===(e=u.env)||void 0===e?void 0:e.C)}static N(e,t){return e.store(t)}static v(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static D(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async k(e){return this.db||(m("SimpleDb","Opening database:",this.name),this.db=await new Promise(((t,n)=>{const s=indexedDB.open(this.name,this.version);s.onsuccess=e=>{const n=e.target.result;t(n)},s.onblocked=()=>{n(new ie(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},s.onerror=t=>{const s=t.target.error;"VersionError"===s.name?n(new b(E.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===s.name?n(new b(E.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+s)):n(new ie(e,s))},s.onupgradeneeded=e=>{m("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);const t=e.target.result;this.P.M(t,s.transaction,e.oldVersion,this.version).next((()=>{m("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.O&&(this.db.onversionchange=e=>this.O(e)),this.db}F(e){this.O=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,s){const r="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.k(e);const t=ne.open(this.db,e,r?"readonly":"readwrite",n),i=s(t).next((e=>(t.R(),e))).catch((e=>(t.abort(e),te.reject(e)))).toPromise();return i.catch((()=>{})),await t.A,i}catch(e){const t=e,n="FirebaseError"!==t.name&&i<3;if(m("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class re{constructor(e){this.$=e,this.B=!1,this.L=null}get isDone(){return this.B}get U(){return this.L}set cursor(e){this.$=e}done(){this.B=!0}q(e){this.L=e}delete(){return ue(this.$.delete())}}class ie extends b{constructor(e,t){super(E.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function oe(e){return"IndexedDbTransactionError"===e.name}class ae{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(m("SimpleDb","PUT",this.store.name,e,t),n=this.store.put(t,e)):(m("SimpleDb","PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),ue(n)}add(e){return m("SimpleDb","ADD",this.store.name,e,e),ue(this.store.add(e))}get(e){return ue(this.store.get(e)).next((t=>(void 0===t&&(t=null),m("SimpleDb","GET",this.store.name,e,t),t)))}delete(e){return m("SimpleDb","DELETE",this.store.name,e),ue(this.store.delete(e))}count(){return m("SimpleDb","COUNT",this.store.name),ue(this.store.count())}K(e,t){const n=this.options(e,t);if(n.index||"function"!=typeof this.store.getAll){const e=this.cursor(n),t=[];return this.G(e,((e,n)=>{t.push(n)})).next((()=>t))}{const e=this.store.getAll(n.range);return new te(((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}}))}}j(e,t){const n=this.store.getAll(e,null===t?void 0:t);return new te(((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}}))}W(e,t){m("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.H=!1;const s=this.cursor(n);return this.G(s,((e,t,n)=>n.delete()))}J(e,t){let n;t?n=e:(n={},t=e);const s=this.cursor(n);return this.G(s,t)}Y(e){const t=this.cursor({});return new te(((n,s)=>{t.onerror=e=>{const t=le(e.target.error);s(t)},t.onsuccess=t=>{const s=t.target.result;s?e(s.primaryKey,s.value).next((e=>{e?s.continue():n()})):n()}}))}G(e,t){const n=[];return new te(((s,r)=>{e.onerror=e=>{r(e.target.error)},e.onsuccess=e=>{const r=e.target.result;if(!r)return void s();const i=new re(r),o=t(r.primaryKey,r.value,i);if(o instanceof te){const e=o.catch((e=>(i.done(),te.reject(e))));n.push(e)}i.isDone?s():null===i.U?r.continue():r.continue(i.U)}})).next((()=>te.waitFor(n)))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.H?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function ue(e){return new te(((t,n)=>{e.onsuccess=e=>{const n=e.target.result;t(n)},e.onerror=e=>{const t=le(e.target.error);n(t)}}))}let ce=!1;function le(e){const t=se.v((0,o.z$)());if(t>=12.2&&t<13){const t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){const e=new b("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return ce||(ce=!0,setTimeout((()=>{throw e}),0)),e}}return e}class he{constructor(e,t){this.asyncQueue=e,this.X=t,this.task=null}start(){this.Z(15)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}Z(e){m("IndexBackiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,(async()=>{this.task=null;try{m("IndexBackiller",`Documents written: ${await this.X.tt()}`)}catch(e){oe(e)?m("IndexBackiller","Ignoring IndexedDB error during index backfill: ",e):await ee(e)}await this.Z(1)}))}}class de{constructor(e,t){this.localStore=e,this.persistence=t}async tt(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(t=>this.et(t,e)))}et(e,t){const n=new Set;let s=t,r=!0;return te.doWhile((()=>!0===r&&s>0),(()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next((t=>{if(null!==t&&!n.has(t))return m("IndexBackiller",`Processing collection: ${t}`),this.nt(e,t,s).next((e=>{s-=e,n.add(t)}));r=!1})))).next((()=>t-s))}nt(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next((s=>this.localStore.localDocuments.getNextDocuments(e,t,s,n).next((n=>{const r=n.changes;return this.localStore.indexManager.updateIndexEntries(e,r).next((()=>this.st(s,n))).next((n=>(m("IndexBackiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n)))).next((()=>r.size))}))))}st(e,t){let n=e;return t.changes.forEach(((e,t)=>{const s=W(t);Y(s,n)>0&&(n=s)})),new J(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class fe{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.it(e),this.rt=e=>t.writeSequenceNumber(e))}it(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this.rt&&this.rt(e),e}}function me(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function ge(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function pe(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}fe.ot=-1;class ye{constructor(e,t){this.comparator=e,this.root=t||ve.EMPTY}insert(e,t){return new ye(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,ve.BLACK,null,null))}remove(e){return new ye(this.comparator,this.root.remove(e,this.comparator).copy(null,null,ve.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){const s=this.comparator(e,n.key);if(0===s)return t+n.left.size;s<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal(((t,n)=>(e(t,n),!1)))}toString(){const e=[];return this.inorderTraversal(((t,n)=>(e.push(`${t}:${n}`),!1))),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new we(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new we(this.root,e,this.comparator,!1)}getReverseIterator(){return new we(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new we(this.root,e,this.comparator,!0)}}class we{constructor(e,t,n,s){this.isReverse=s,this.nodeStack=[];let r=1;for(;!e.isEmpty();)if(r=t?n(e.key,t):1,t&&s&&(r*=-1),r<0)e=this.isReverse?e.left:e.right;else{if(0===r){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class ve{constructor(e,t,n,s,r){this.key=e,this.value=t,this.color=null!=n?n:ve.RED,this.left=null!=s?s:ve.EMPTY,this.right=null!=r?r:ve.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,s,r){return new ve(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=s?s:this.left,null!=r?r:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let s=this;const r=n(e,s.key);return s=r<0?s.copy(null,null,null,s.left.insert(e,t,n),null):0===r?s.copy(null,t,null,null,null):s.copy(null,null,null,null,s.right.insert(e,t,n)),s.fixUp()}removeMin(){if(this.left.isEmpty())return ve.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,s=this;if(t(e,s.key)<0)s.left.isEmpty()||s.left.isRed()||s.left.left.isRed()||(s=s.moveRedLeft()),s=s.copy(null,null,null,s.left.remove(e,t),null);else{if(s.left.isRed()&&(s=s.rotateRight()),s.right.isEmpty()||s.right.isRed()||s.right.left.isRed()||(s=s.moveRedRight()),0===t(e,s.key)){if(s.right.isEmpty())return ve.EMPTY;n=s.right.min(),s=s.copy(n.key,n.value,null,null,s.right.removeMin())}s=s.copy(null,null,null,null,s.right.remove(e,t))}return s.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,ve.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,ve.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw w();if(this.right.isRed())throw w();const e=this.left.check();if(e!==this.right.check())throw w();return e+(this.isRed()?0:1)}}ve.EMPTY=null,ve.RED=!0,ve.BLACK=!1,ve.EMPTY=new class{constructor(){this.size=0}get key(){throw w()}get value(){throw w()}get color(){throw w()}get left(){throw w()}get right(){throw w()}copy(e,t,n,s,r){return this}insert(e,t,n){return new ve(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Ie{constructor(e){this.comparator=e,this.data=new ye(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal(((t,n)=>(e(t),!1)))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){const s=n.getNext();if(this.comparator(s.key,e[1])>=0)return;t(s.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new Ee(this.data.getIterator())}getIteratorFrom(e){return new Ee(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach((e=>{t=t.add(e)})),t}isEqual(e){if(!(e instanceof Ie))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,s=n.getNext().key;if(0!==this.comparator(e,s))return!1}return!0}toArray(){const e=[];return this.forEach((t=>{e.push(t)})),e}toString(){const e=[];return this.forEach((t=>e.push(t))),"SortedSet("+e.toString()+")"}copy(e){const t=new Ie(this.comparator);return t.data=e,t}}class Ee{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function be(e){return e.hasNext()?e.getNext():void 0}class Te{constructor(e){this.fields=e,e.sort(q.comparator)}static empty(){return new Te([])}unionWith(e){let t=new Ie(q.comparator);for(const n of this.fields)t=t.add(n);for(const n of e)t=t.add(n);return new Te(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return R(this.fields,e.fields,((e,t)=>e.isEqual(t)))}}class Se{constructor(e){this.binaryString=e}static fromBase64String(e){const t=atob(e);return new Se(t)}static fromUint8Array(e){const t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new Se(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return M(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}Se.EMPTY_BYTE_STRING=new Se("");const xe=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function De(e){if(v(!!e),"string"==typeof e){let t=0;const n=xe.exec(e);if(v(!!n),n[1]){let e=n[1];e=(e+"000000000").substr(0,9),t=Number(e)}const s=new Date(e);return{seconds:Math.floor(s.getTime()/1e3),nanos:t}}return{seconds:Ne(e.seconds),nanos:Ne(e.nanos)}}function Ne(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function Ae(e){return"string"==typeof e?Se.fromBase64String(e):Se.fromUint8Array(e)}function Ce(e){var t,n;return"server_timestamp"===(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function ke(e){const t=e.mapValue.fields.__previous_value__;return Ce(t)?ke(t):t}function _e(e){const t=De(e.mapValue.fields.__local_write_time__.timestampValue);return new L(t.seconds,t.nanos)}class Ve{constructor(e,t,n,s,r,i,o,a){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=s,this.ssl=r,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class Me{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new Me("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof Me&&e.projectId===this.projectId&&e.database===this.database}}function Re(e){return null==e}function Oe(e){return 0===e&&1/e==-1/0}function Le(e){return"number"==typeof e&&Number.isInteger(e)&&!Oe(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}const Fe={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Pe={nullValue:"NULL_VALUE"};function Ue(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?Ce(e)?4:Ze(e)?9007199254740991:10:w()}function Be(e,t){if(e===t)return!0;const n=Ue(e);if(n!==Ue(t))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return _e(e).isEqual(_e(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;const n=De(e.timestampValue),s=De(t.timestampValue);return n.seconds===s.seconds&&n.nanos===s.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return function(e,t){return Ae(e.bytesValue).isEqual(Ae(t.bytesValue))}(e,t);case 7:return e.referenceValue===t.referenceValue;case 8:return function(e,t){return Ne(e.geoPointValue.latitude)===Ne(t.geoPointValue.latitude)&&Ne(e.geoPointValue.longitude)===Ne(t.geoPointValue.longitude)}(e,t);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return Ne(e.integerValue)===Ne(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){const n=Ne(e.doubleValue),s=Ne(t.doubleValue);return n===s?Oe(n)===Oe(s):isNaN(n)&&isNaN(s)}return!1}(e,t);case 9:return R(e.arrayValue.values||[],t.arrayValue.values||[],Be);case 10:return function(e,t){const n=e.mapValue.fields||{},s=t.mapValue.fields||{};if(me(n)!==me(s))return!1;for(const r in n)if(n.hasOwnProperty(r)&&(void 0===s[r]||!Be(n[r],s[r])))return!1;return!0}(e,t);default:return w()}}function qe(e,t){return void 0!==(e.values||[]).find((e=>Be(e,t)))}function Ke(e,t){if(e===t)return 0;const n=Ue(e),s=Ue(t);if(n!==s)return M(n,s);switch(n){case 0:case 9007199254740991:return 0;case 1:return M(e.booleanValue,t.booleanValue);case 2:return function(e,t){const n=Ne(e.integerValue||e.doubleValue),s=Ne(t.integerValue||t.doubleValue);return n<s?-1:n>s?1:n===s?0:isNaN(n)?isNaN(s)?0:-1:1}(e,t);case 3:return Ge(e.timestampValue,t.timestampValue);case 4:return Ge(_e(e),_e(t));case 5:return M(e.stringValue,t.stringValue);case 6:return function(e,t){const n=Ae(e),s=Ae(t);return n.compareTo(s)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){const n=e.split("/"),s=t.split("/");for(let r=0;r<n.length&&r<s.length;r++){const e=M(n[r],s[r]);if(0!==e)return e}return M(n.length,s.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){const n=M(Ne(e.latitude),Ne(t.latitude));return 0!==n?n:M(Ne(e.longitude),Ne(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return function(e,t){const n=e.values||[],s=t.values||[];for(let r=0;r<n.length&&r<s.length;++r){const e=Ke(n[r],s[r]);if(e)return e}return M(n.length,s.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===Fe.mapValue&&t===Fe.mapValue)return 0;if(e===Fe.mapValue)return 1;if(t===Fe.mapValue)return-1;const n=e.fields||{},s=Object.keys(n),r=t.fields||{},i=Object.keys(r);s.sort(),i.sort();for(let o=0;o<s.length&&o<i.length;++o){const e=M(s[o],i[o]);if(0!==e)return e;const t=Ke(n[s[o]],r[i[o]]);if(0!==t)return t}return M(s.length,i.length)}(e.mapValue,t.mapValue);default:throw w()}}function Ge(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return M(e,t);const n=De(e),s=De(t),r=M(n.seconds,s.seconds);return 0!==r?r:M(n.nanos,s.nanos)}function $e(e){return ze(e)}function ze(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=De(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?Ae(e.bytesValue).toBase64():"referenceValue"in e?(n=e.referenceValue,K.fromName(n).toString()):"geoPointValue"in e?`geo(${(t=e.geoPointValue).latitude},${t.longitude})`:"arrayValue"in e?function(e){let t="[",n=!0;for(const s of e.values||[])n?n=!1:t+=",",t+=ze(s);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",s=!0;for(const r of t)s?s=!1:n+=",",n+=`${r}:${ze(e.fields[r])}`;return n+"}"}(e.mapValue):w();var t,n}function je(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function Qe(e){return!!e&&"integerValue"in e}function He(e){return!!e&&"arrayValue"in e}function We(e){return!!e&&"nullValue"in e}function Je(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function Ye(e){return!!e&&"mapValue"in e}function Xe(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const t={mapValue:{fields:{}}};return ge(e.mapValue.fields,((e,n)=>t.mapValue.fields[e]=Xe(n))),t}if(e.arrayValue){const t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=Xe(e.arrayValue.values[n]);return t}return Object.assign({},e)}function Ze(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function et(e){return"nullValue"in e?Pe:"booleanValue"in e?{booleanValue:!1}:"integerValue"in e||"doubleValue"in e?{doubleValue:NaN}:"timestampValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in e?{stringValue:""}:"bytesValue"in e?{bytesValue:""}:"referenceValue"in e?je(Me.empty(),K.empty()):"geoPointValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in e?{arrayValue:{}}:"mapValue"in e?{mapValue:{}}:w()}function tt(e){return"nullValue"in e?{booleanValue:!1}:"booleanValue"in e?{doubleValue:NaN}:"integerValue"in e||"doubleValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in e?{stringValue:""}:"stringValue"in e?{bytesValue:""}:"bytesValue"in e?je(Me.empty(),K.empty()):"referenceValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in e?{arrayValue:{}}:"arrayValue"in e?{mapValue:{}}:"mapValue"in e?Fe:w()}function nt(e,t){const n=Ke(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function st(e,t){const n=Ke(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class rt{constructor(e){this.value=e}static empty(){return new rt({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!Ye(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=Xe(t)}setAll(e){let t=q.emptyPath(),n={},s=[];e.forEach(((e,r)=>{if(!t.isImmediateParentOf(r)){const e=this.getFieldsMap(t);this.applyChanges(e,n,s),n={},s=[],t=r.popLast()}e?n[r.lastSegment()]=Xe(e):s.push(r.lastSegment())}));const r=this.getFieldsMap(t);this.applyChanges(r,n,s)}delete(e){const t=this.field(e.popLast());Ye(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return Be(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let s=t.mapValue.fields[e.get(n)];Ye(s)&&s.mapValue.fields||(s={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=s),t=s}return t.mapValue.fields}applyChanges(e,t,n){ge(t,((t,n)=>e[t]=n));for(const s of n)delete e[s]}clone(){return new rt(Xe(this.value))}}function it(e){const t=[];return ge(e.fields,((e,n)=>{const s=new q([e]);if(Ye(n)){const e=it(n.mapValue).fields;if(0===e.length)t.push(s);else for(const n of e)t.push(s.child(n))}else t.push(s)})),new Te(t)}class ot{constructor(e,t,n,s,r,i){this.key=e,this.documentType=t,this.version=n,this.readTime=s,this.data=r,this.documentState=i}static newInvalidDocument(e){return new ot(e,0,F.min(),F.min(),rt.empty(),0)}static newFoundDocument(e,t,n){return new ot(e,1,t,F.min(),n,0)}static newNoDocument(e,t){return new ot(e,2,t,F.min(),rt.empty(),0)}static newUnknownDocument(e,t){return new ot(e,3,t,F.min(),rt.empty(),2)}convertToFoundDocument(e,t){return this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=rt.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=rt.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=F.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof ot&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new ot(this.key,this.documentType,this.version,this.readTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class at{constructor(e,t=null,n=[],s=[],r=null,i=null,o=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=s,this.limit=r,this.startAt=i,this.endAt=o,this.ut=null}}function ut(e,t=null,n=[],s=[],r=null,i=null,o=null){return new at(e,t,n,s,r,i,o)}function ct(e){const t=I(e);if(null===t.ut){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map((e=>{return(t=e).field.canonicalString()+t.op.toString()+$e(t.value);var t})).join(","),e+="|ob:",e+=t.orderBy.map((e=>function(e){return e.field.canonicalString()+e.dir}(e))).join(","),Re(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((e=>$e(e))).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((e=>$e(e))).join(",")),t.ut=e}return t.ut}function lt(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let r=0;r<e.orderBy.length;r++)if(!Dt(e.orderBy[r],t.orderBy[r]))return!1;if(e.filters.length!==t.filters.length)return!1;for(let r=0;r<e.filters.length;r++)if(n=e.filters[r],s=t.filters[r],n.op!==s.op||!n.field.isEqual(s.field)||!Be(n.value,s.value))return!1;var n,s;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!At(e.startAt,t.startAt)&&At(e.endAt,t.endAt)}function ht(e){return K.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function dt(e,t){return e.filters.filter((e=>e instanceof gt&&e.field.isEqual(t)))}function ft(e,t,n){let s=Pe,r=!0;for(const i of dt(e,t)){let e=Pe,t=!0;switch(i.op){case"<":case"<=":e=et(i.value);break;case"==":case"in":case">=":e=i.value;break;case">":e=i.value,t=!1;break;case"!=":case"not-in":e=Pe}nt({value:s,inclusive:r},{value:e,inclusive:t})<0&&(s=e,r=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];nt({value:s,inclusive:r},{value:e,inclusive:n.inclusive})<0&&(s=e,r=n.inclusive);break}return{value:s,inclusive:r}}function mt(e,t,n){let s=Fe,r=!0;for(const i of dt(e,t)){let e=Fe,t=!0;switch(i.op){case">=":case">":e=tt(i.value),t=!1;break;case"==":case"in":case"<=":e=i.value;break;case"<":e=i.value,t=!1;break;case"!=":case"not-in":e=Fe}st({value:s,inclusive:r},{value:e,inclusive:t})>0&&(s=e,r=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];st({value:s,inclusive:r},{value:e,inclusive:n.inclusive})>0&&(s=e,r=n.inclusive);break}return{value:s,inclusive:r}}class gt extends class{}{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.ct(e,t,n):new pt(e,t,n):"array-contains"===t?new It(e,n):"in"===t?new Et(e,n):"not-in"===t?new bt(e,n):"array-contains-any"===t?new Tt(e,n):new gt(e,t,n)}static ct(e,t,n){return"in"===t?new yt(e,n):new wt(e,n)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&this.at(Ke(t,this.value)):null!==t&&Ue(this.value)===Ue(t)&&this.at(Ke(t,this.value))}at(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return w()}}ht(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}}class pt extends gt{constructor(e,t,n){super(e,t,n),this.key=K.fromName(n.referenceValue)}matches(e){const t=K.comparator(e.key,this.key);return this.at(t)}}class yt extends gt{constructor(e,t){super(e,"in",t),this.keys=vt("in",t)}matches(e){return this.keys.some((t=>t.isEqual(e.key)))}}class wt extends gt{constructor(e,t){super(e,"not-in",t),this.keys=vt("not-in",t)}matches(e){return!this.keys.some((t=>t.isEqual(e.key)))}}function vt(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map((e=>K.fromName(e.referenceValue)))}class It extends gt{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return He(t)&&qe(t.arrayValue,this.value)}}class Et extends gt{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&qe(this.value.arrayValue,t)}}class bt extends gt{constructor(e,t){super(e,"not-in",t)}matches(e){if(qe(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&!qe(this.value.arrayValue,t)}}class Tt extends gt{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!He(t)||!t.arrayValue.values)&&t.arrayValue.values.some((e=>qe(this.value.arrayValue,e)))}}class St{constructor(e,t){this.position=e,this.inclusive=t}}class xt{constructor(e,t="asc"){this.field=e,this.dir=t}}function Dt(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}function Nt(e,t,n){let s=0;for(let r=0;r<e.position.length;r++){const i=t[r],o=e.position[r];if(s=i.field.isKeyField()?K.comparator(K.fromName(o.referenceValue),n.key):Ke(o,n.data.field(i.field)),"desc"===i.dir&&(s*=-1),0!==s)break}return s}function At(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!Be(e.position[n],t.position[n]))return!1;return!0}class Ct{constructor(e,t=null,n=[],s=[],r=null,i="F",o=null,a=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=s,this.limit=r,this.limitType=i,this.startAt=o,this.endAt=a,this.lt=null,this.ft=null,this.startAt,this.endAt}}function kt(e,t,n,s,r,i,o,a){return new Ct(e,t,n,s,r,i,o,a)}function _t(e){return new Ct(e)}function Vt(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function Mt(e){return e.explicitOrderBy.length>0?e.explicitOrderBy[0].field:null}function Rt(e){for(const t of e.filters)if(t.ht())return t.field;return null}function Ot(e){return null!==e.collectionGroup}function Lt(e){const t=I(e);if(null===t.lt){t.lt=[];const e=Rt(t),n=Mt(t);if(null!==e&&null===n)e.isKeyField()||t.lt.push(new xt(e)),t.lt.push(new xt(q.keyField(),"asc"));else{let e=!1;for(const n of t.explicitOrderBy)t.lt.push(n),n.field.isKeyField()&&(e=!0);if(!e){const e=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";t.lt.push(new xt(q.keyField(),e))}}}return t.lt}function Ft(e){const t=I(e);if(!t.ft)if("F"===t.limitType)t.ft=ut(t.path,t.collectionGroup,Lt(t),t.filters,t.limit,t.startAt,t.endAt);else{const e=[];for(const r of Lt(t)){const t="desc"===r.dir?"asc":"desc";e.push(new xt(r.field,t))}const n=t.endAt?new St(t.endAt.position,t.endAt.inclusive):null,s=t.startAt?new St(t.startAt.position,t.startAt.inclusive):null;t.ft=ut(t.path,t.collectionGroup,e,t.filters,t.limit,n,s)}return t.ft}function Pt(e,t,n){return new Ct(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function Ut(e,t){return lt(Ft(e),Ft(t))&&e.limitType===t.limitType}function Bt(e){return`${ct(Ft(e))}|lt:${e.limitType}`}function qt(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(t+=`, filters: [${e.filters.map((e=>{return`${(t=e).field.canonicalString()} ${t.op} ${$e(t.value)}`;var t})).join(", ")}]`),Re(e.limit)||(t+=", limit: "+e.limit),e.orderBy.length>0&&(t+=`, orderBy: [${e.orderBy.map((e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e))).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((e=>$e(e))).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((e=>$e(e))).join(",")),`Target(${t})`}(Ft(e))}; limitType=${e.limitType})`}function Kt(e,t){return t.isFoundDocument()&&function(e,t){const n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):K.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(const n of e.explicitOrderBy)if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&function(e,t){return!(e.startAt&&!function(e,t,n){const s=Nt(e,t,n);return e.inclusive?s<=0:s<0}(e.startAt,Lt(e),t))&&!(e.endAt&&!function(e,t,n){const s=Nt(e,t,n);return e.inclusive?s>=0:s>0}(e.endAt,Lt(e),t))}(e,t)}function Gt(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function $t(e){return(t,n)=>{let s=!1;for(const r of Lt(e)){const e=zt(r,t,n);if(0!==e)return e;s=s||r.field.isKeyField()}return 0}}function zt(e,t,n){const s=e.field.isKeyField()?K.comparator(t.key,n.key):function(e,t,n){const s=t.data.field(e),r=n.data.field(e);return null!==s&&null!==r?Ke(s,r):w()}(e.field,t,n);switch(e.dir){case"asc":return s;case"desc":return-1*s;default:return w()}}function jt(e,t){if(e.dt){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Oe(t)?"-0":t}}function Qt(e){return{integerValue:""+e}}function Ht(e,t){return Le(t)?Qt(t):jt(e,t)}class Wt{constructor(){this._=void 0}}function Jt(e,t,n){return e instanceof Zt?function(e,t){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&(n.fields.__previous_value__=t),{mapValue:n}}(n,t):e instanceof en?tn(e,t):e instanceof nn?sn(e,t):function(e,t){const n=Xt(e,t),s=on(n)+on(e._t);return Qe(n)&&Qe(e._t)?Qt(s):jt(e.wt,s)}(e,t)}function Yt(e,t,n){return e instanceof en?tn(e,t):e instanceof nn?sn(e,t):n}function Xt(e,t){return e instanceof rn?Qe(n=t)||function(e){return!!e&&"doubleValue"in e}(n)?t:{integerValue:0}:null;var n}class Zt extends Wt{}class en extends Wt{constructor(e){super(),this.elements=e}}function tn(e,t){const n=an(t);for(const s of e.elements)n.some((e=>Be(e,s)))||n.push(s);return{arrayValue:{values:n}}}class nn extends Wt{constructor(e){super(),this.elements=e}}function sn(e,t){let n=an(t);for(const s of e.elements)n=n.filter((e=>!Be(e,s)));return{arrayValue:{values:n}}}class rn extends Wt{constructor(e,t){super(),this.wt=e,this._t=t}}function on(e){return Ne(e.integerValue||e.doubleValue)}function an(e){return He(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class un{constructor(e,t){this.field=e,this.transform=t}}class cn{constructor(e,t){this.version=e,this.transformResults=t}}class ln{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new ln}static exists(e){return new ln(void 0,e)}static updateTime(e){return new ln(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function hn(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class dn{}function fn(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new Tn(e.key,ln.none()):new wn(e.key,e.data,ln.none());{const n=e.data,s=rt.empty();let r=new Ie(q.comparator);for(let e of t.fields)if(!r.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?s.delete(e):s.set(e,t),r=r.add(e)}return new vn(e.key,s,new Te(r.toArray()),ln.none())}}function mn(e,t,n){e instanceof wn?function(e,t,n){const s=e.value.clone(),r=En(e.fieldTransforms,t,n.transformResults);s.setAll(r),t.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(e,t,n):e instanceof vn?function(e,t,n){if(!hn(e.precondition,t))return void t.convertToUnknownDocument(n.version);const s=En(e.fieldTransforms,t,n.transformResults),r=t.data;r.setAll(In(e)),r.setAll(s),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,t,n)}function gn(e,t,n,s){return e instanceof wn?function(e,t,n,s){if(!hn(e.precondition,t))return n;const r=e.value.clone(),i=bn(e.fieldTransforms,s,t);return r.setAll(i),t.convertToFoundDocument(t.version,r).setHasLocalMutations(),null}(e,t,n,s):e instanceof vn?function(e,t,n,s){if(!hn(e.precondition,t))return n;const r=bn(e.fieldTransforms,s,t),i=t.data;return i.setAll(In(e)),i.setAll(r),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map((e=>e.field)))}(e,t,n,s):function(e,t,n){return hn(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}(e,t,n)}function pn(e,t){let n=null;for(const s of e.fieldTransforms){const e=t.data.field(s.field),r=Xt(s.transform,e||null);null!=r&&(null===n&&(n=rt.empty()),n.set(s.field,r))}return n||null}function yn(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&!!function(e,t){return void 0===e&&void 0===t||!(!e||!t)&&R(e,t,((e,t)=>function(e,t){return e.field.isEqual(t.field)&&function(e,t){return e instanceof en&&t instanceof en||e instanceof nn&&t instanceof nn?R(e.elements,t.elements,Be):e instanceof rn&&t instanceof rn?Be(e._t,t._t):e instanceof Zt&&t instanceof Zt}(e.transform,t.transform)}(e,t)))}(e.fieldTransforms,t.fieldTransforms)&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class wn extends dn{constructor(e,t,n,s=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=s,this.type=0}getFieldMask(){return null}}class vn extends dn{constructor(e,t,n,s,r=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=s,this.fieldTransforms=r,this.type=1}getFieldMask(){return this.fieldMask}}function In(e){const t=new Map;return e.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const s=e.data.field(n);t.set(n,s)}})),t}function En(e,t,n){const s=new Map;v(e.length===n.length);for(let r=0;r<n.length;r++){const i=e[r],o=i.transform,a=t.data.field(i.field);s.set(i.field,Yt(o,a,n[r]))}return s}function bn(e,t,n){const s=new Map;for(const r of e){const e=r.transform,i=n.data.field(r.field);s.set(r.field,Jt(e,i,t))}return s}class Tn extends dn{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Sn extends dn{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class xn{constructor(e){this.count=e}}var Dn,Nn;function An(e){switch(e){default:return w();case E.CANCELLED:case E.UNKNOWN:case E.DEADLINE_EXCEEDED:case E.RESOURCE_EXHAUSTED:case E.INTERNAL:case E.UNAVAILABLE:case E.UNAUTHENTICATED:return!1;case E.INVALID_ARGUMENT:case E.NOT_FOUND:case E.ALREADY_EXISTS:case E.PERMISSION_DENIED:case E.FAILED_PRECONDITION:case E.ABORTED:case E.OUT_OF_RANGE:case E.UNIMPLEMENTED:case E.DATA_LOSS:return!0}}function Cn(e){if(void 0===e)return g("GRPC error has no .code"),E.UNKNOWN;switch(e){case Dn.OK:return E.OK;case Dn.CANCELLED:return E.CANCELLED;case Dn.UNKNOWN:return E.UNKNOWN;case Dn.DEADLINE_EXCEEDED:return E.DEADLINE_EXCEEDED;case Dn.RESOURCE_EXHAUSTED:return E.RESOURCE_EXHAUSTED;case Dn.INTERNAL:return E.INTERNAL;case Dn.UNAVAILABLE:return E.UNAVAILABLE;case Dn.UNAUTHENTICATED:return E.UNAUTHENTICATED;case Dn.INVALID_ARGUMENT:return E.INVALID_ARGUMENT;case Dn.NOT_FOUND:return E.NOT_FOUND;case Dn.ALREADY_EXISTS:return E.ALREADY_EXISTS;case Dn.PERMISSION_DENIED:return E.PERMISSION_DENIED;case Dn.FAILED_PRECONDITION:return E.FAILED_PRECONDITION;case Dn.ABORTED:return E.ABORTED;case Dn.OUT_OF_RANGE:return E.OUT_OF_RANGE;case Dn.UNIMPLEMENTED:return E.UNIMPLEMENTED;case Dn.DATA_LOSS:return E.DATA_LOSS;default:return w()}}(Nn=Dn||(Dn={}))[Nn.OK=0]="OK",Nn[Nn.CANCELLED=1]="CANCELLED",Nn[Nn.UNKNOWN=2]="UNKNOWN",Nn[Nn.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Nn[Nn.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Nn[Nn.NOT_FOUND=5]="NOT_FOUND",Nn[Nn.ALREADY_EXISTS=6]="ALREADY_EXISTS",Nn[Nn.PERMISSION_DENIED=7]="PERMISSION_DENIED",Nn[Nn.UNAUTHENTICATED=16]="UNAUTHENTICATED",Nn[Nn.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Nn[Nn.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Nn[Nn.ABORTED=10]="ABORTED",Nn[Nn.OUT_OF_RANGE=11]="OUT_OF_RANGE",Nn[Nn.UNIMPLEMENTED=12]="UNIMPLEMENTED",Nn[Nn.INTERNAL=13]="INTERNAL",Nn[Nn.UNAVAILABLE=14]="UNAVAILABLE",Nn[Nn.DATA_LOSS=15]="DATA_LOSS";class kn{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[s,r]of n)if(this.equalsFn(s,e))return r}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),s=this.inner[n];if(void 0===s)return this.inner[n]=[[e,t]],void this.innerSize++;for(let r=0;r<s.length;r++)if(this.equalsFn(s[r][0],e))return void(s[r]=[e,t]);s.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let s=0;s<n.length;s++)if(this.equalsFn(n[s][0],e))return 1===n.length?delete this.inner[t]:n.splice(s,1),this.innerSize--,!0;return!1}forEach(e){ge(this.inner,((t,n)=>{for(const[s,r]of n)e(s,r)}))}isEmpty(){return pe(this.inner)}size(){return this.innerSize}}const _n=new ye(K.comparator);function Vn(){return _n}const Mn=new ye(K.comparator);function Rn(...e){let t=Mn;for(const n of e)t=t.insert(n.key,n);return t}function On(e){let t=Mn;return e.forEach(((e,n)=>t=t.insert(e,n.overlayedDocument))),t}function Ln(){return Pn()}function Fn(){return Pn()}function Pn(){return new kn((e=>e.toString()),((e,t)=>e.isEqual(t)))}const Un=new ye(K.comparator),Bn=new Ie(K.comparator);function qn(...e){let t=Bn;for(const n of e)t=t.add(n);return t}const Kn=new Ie(M);function Gn(){return Kn}class $n{constructor(e,t,n,s,r){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=s,this.resolvedLimboDocuments=r}static createSynthesizedRemoteEventForCurrentChange(e,t){const n=new Map;return n.set(e,zn.createSynthesizedTargetChangeForCurrentChange(e,t)),new $n(F.min(),n,Gn(),Vn(),qn())}}class zn{constructor(e,t,n,s,r){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=s,this.removedDocuments=r}static createSynthesizedTargetChangeForCurrentChange(e,t){return new zn(Se.EMPTY_BYTE_STRING,t,qn(),qn(),qn())}}class jn{constructor(e,t,n,s){this.gt=e,this.removedTargetIds=t,this.key=n,this.yt=s}}class Qn{constructor(e,t){this.targetId=e,this.It=t}}class Hn{constructor(e,t,n=Se.EMPTY_BYTE_STRING,s=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=s}}class Wn{constructor(){this.Tt=0,this.Et=Xn(),this.At=Se.EMPTY_BYTE_STRING,this.Rt=!1,this.bt=!0}get current(){return this.Rt}get resumeToken(){return this.At}get Pt(){return 0!==this.Tt}get vt(){return this.bt}Vt(e){e.approximateByteSize()>0&&(this.bt=!0,this.At=e)}St(){let e=qn(),t=qn(),n=qn();return this.Et.forEach(((s,r)=>{switch(r){case 0:e=e.add(s);break;case 2:t=t.add(s);break;case 1:n=n.add(s);break;default:w()}})),new zn(this.At,this.Rt,e,t,n)}Dt(){this.bt=!1,this.Et=Xn()}Ct(e,t){this.bt=!0,this.Et=this.Et.insert(e,t)}xt(e){this.bt=!0,this.Et=this.Et.remove(e)}Nt(){this.Tt+=1}kt(){this.Tt-=1}Mt(){this.bt=!0,this.Rt=!0}}class Jn{constructor(e){this.Ot=e,this.Ft=new Map,this.$t=Vn(),this.Bt=Yn(),this.Lt=new Ie(M)}Ut(e){for(const t of e.gt)e.yt&&e.yt.isFoundDocument()?this.qt(t,e.yt):this.Kt(t,e.key,e.yt);for(const t of e.removedTargetIds)this.Kt(t,e.key,e.yt)}Gt(e){this.forEachTarget(e,(t=>{const n=this.Qt(t);switch(e.state){case 0:this.jt(t)&&n.Vt(e.resumeToken);break;case 1:n.kt(),n.Pt||n.Dt(),n.Vt(e.resumeToken);break;case 2:n.kt(),n.Pt||this.removeTarget(t);break;case 3:this.jt(t)&&(n.Mt(),n.Vt(e.resumeToken));break;case 4:this.jt(t)&&(this.Wt(t),n.Vt(e.resumeToken));break;default:w()}}))}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.Ft.forEach(((e,n)=>{this.jt(n)&&t(n)}))}zt(e){const t=e.targetId,n=e.It.count,s=this.Ht(t);if(s){const e=s.target;if(ht(e))if(0===n){const n=new K(e.path);this.Kt(t,n,ot.newNoDocument(n,F.min()))}else v(1===n);else this.Jt(t)!==n&&(this.Wt(t),this.Lt=this.Lt.add(t))}}Yt(e){const t=new Map;this.Ft.forEach(((n,s)=>{const r=this.Ht(s);if(r){if(n.current&&ht(r.target)){const t=new K(r.target.path);null!==this.$t.get(t)||this.Xt(s,t)||this.Kt(s,t,ot.newNoDocument(t,e))}n.vt&&(t.set(s,n.St()),n.Dt())}}));let n=qn();this.Bt.forEach(((e,t)=>{let s=!0;t.forEachWhile((e=>{const t=this.Ht(e);return!t||2===t.purpose||(s=!1,!1)})),s&&(n=n.add(e))})),this.$t.forEach(((t,n)=>n.setReadTime(e)));const s=new $n(e,t,this.Lt,this.$t,n);return this.$t=Vn(),this.Bt=Yn(),this.Lt=new Ie(M),s}qt(e,t){if(!this.jt(e))return;const n=this.Xt(e,t.key)?2:0;this.Qt(e).Ct(t.key,n),this.$t=this.$t.insert(t.key,t),this.Bt=this.Bt.insert(t.key,this.Zt(t.key).add(e))}Kt(e,t,n){if(!this.jt(e))return;const s=this.Qt(e);this.Xt(e,t)?s.Ct(t,1):s.xt(t),this.Bt=this.Bt.insert(t,this.Zt(t).delete(e)),n&&(this.$t=this.$t.insert(t,n))}removeTarget(e){this.Ft.delete(e)}Jt(e){const t=this.Qt(e).St();return this.Ot.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Nt(e){this.Qt(e).Nt()}Qt(e){let t=this.Ft.get(e);return t||(t=new Wn,this.Ft.set(e,t)),t}Zt(e){let t=this.Bt.get(e);return t||(t=new Ie(M),this.Bt=this.Bt.insert(e,t)),t}jt(e){const t=null!==this.Ht(e);return t||m("WatchChangeAggregator","Detected inactive target",e),t}Ht(e){const t=this.Ft.get(e);return t&&t.Pt?null:this.Ot.te(e)}Wt(e){this.Ft.set(e,new Wn),this.Ot.getRemoteKeysForTarget(e).forEach((t=>{this.Kt(e,t,null)}))}Xt(e,t){return this.Ot.getRemoteKeysForTarget(e).has(t)}}function Yn(){return new ye(K.comparator)}function Xn(){return new ye(K.comparator)}const Zn={asc:"ASCENDING",desc:"DESCENDING"},es={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class ts{constructor(e,t){this.databaseId=e,this.dt=t}}function ns(e,t){return e.dt?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function ss(e,t){return e.dt?t.toBase64():t.toUint8Array()}function rs(e,t){return ns(e,t.toTimestamp())}function is(e){return v(!!e),F.fromTimestamp(function(e){const t=De(e);return new L(t.seconds,t.nanos)}(e))}function os(e,t){return function(e){return new U(["projects",e.projectId,"databases",e.database])}(e).child("documents").child(t).canonicalString()}function as(e){const t=U.fromString(e);return v(Cs(t)),t}function us(e,t){return os(e.databaseId,t.path)}function cs(e,t){const n=as(t);if(n.get(1)!==e.databaseId.projectId)throw new b(E.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new b(E.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new K(fs(n))}function ls(e,t){return os(e.databaseId,t)}function hs(e){const t=as(e);return 4===t.length?U.emptyPath():fs(t)}function ds(e){return new U(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function fs(e){return v(e.length>4&&"documents"===e.get(4)),e.popFirst(5)}function ms(e,t,n){return{name:us(e,t),fields:n.value.mapValue.fields}}function gs(e,t,n){const s=cs(e,t.name),r=is(t.updateTime),i=new rt({mapValue:{fields:t.fields}}),o=ot.newFoundDocument(s,r,i);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function ps(e,t){let n;if(t instanceof wn)n={update:ms(e,t.key,t.value)};else if(t instanceof Tn)n={delete:us(e,t.key)};else if(t instanceof vn)n={update:ms(e,t.key,t.data),updateMask:As(t.fieldMask)};else{if(!(t instanceof Sn))return w();n={verify:us(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map((e=>function(e,t){const n=t.transform;if(n instanceof Zt)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof en)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof nn)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof rn)return{fieldPath:t.field.canonicalString(),increment:n._t};throw w()}(0,e)))),t.precondition.isNone||(n.currentDocument=function(e,t){return void 0!==t.updateTime?{updateTime:rs(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:w()}(e,t.precondition)),n}function ys(e,t){const n=t.currentDocument?function(e){return void 0!==e.updateTime?ln.updateTime(is(e.updateTime)):void 0!==e.exists?ln.exists(e.exists):ln.none()}(t.currentDocument):ln.none(),s=t.updateTransforms?t.updateTransforms.map((t=>function(e,t){let n=null;if("setToServerValue"in t)v("REQUEST_TIME"===t.setToServerValue),n=new Zt;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new en(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new nn(e)}else"increment"in t?n=new rn(e,t.increment):w();const s=q.fromServerFormat(t.fieldPath);return new un(s,n)}(e,t))):[];if(t.update){t.update.name;const r=cs(e,t.update.name),i=new rt({mapValue:{fields:t.update.fields}});if(t.updateMask){const e=function(e){const t=e.fieldPaths||[];return new Te(t.map((e=>q.fromServerFormat(e))))}(t.updateMask);return new vn(r,i,e,n,s)}return new wn(r,i,n,s)}if(t.delete){const s=cs(e,t.delete);return new Tn(s,n)}if(t.verify){const s=cs(e,t.verify);return new Sn(s,n)}return w()}function ws(e,t){return{documents:[ls(e,t.path)]}}function vs(e,t){const n={structuredQuery:{}},s=t.path;null!==t.collectionGroup?(n.parent=ls(e,s),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=ls(e,s.popLast()),n.structuredQuery.from=[{collectionId:s.lastSegment()}]);const r=function(e){if(0===e.length)return;const t=e.map((e=>function(e){if("=="===e.op){if(Je(e.value))return{unaryFilter:{field:Ss(e.field),op:"IS_NAN"}};if(We(e.value))return{unaryFilter:{field:Ss(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(Je(e.value))return{unaryFilter:{field:Ss(e.field),op:"IS_NOT_NAN"}};if(We(e.value))return{unaryFilter:{field:Ss(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Ss(e.field),op:Ts(e.op),value:e.value}}}(e)));return 1===t.length?t[0]:{compositeFilter:{op:"AND",filters:t}}}(t.filters);r&&(n.structuredQuery.where=r);const i=function(e){if(0!==e.length)return e.map((e=>function(e){return{field:Ss(e.field),direction:bs(e.dir)}}(e)))}(t.orderBy);i&&(n.structuredQuery.orderBy=i);const o=function(e,t){return e.dt||Re(t)?t:{value:t}}(e,t.limit);var a;return null!==o&&(n.structuredQuery.limit=o),t.startAt&&(n.structuredQuery.startAt={before:(a=t.startAt).inclusive,values:a.position}),t.endAt&&(n.structuredQuery.endAt=function(e){return{before:!e.inclusive,values:e.position}}(t.endAt)),n}function Is(e){let t=hs(e.parent);const n=e.structuredQuery,s=n.from?n.from.length:0;let r=null;if(s>0){v(1===s);const e=n.from[0];e.allDescendants?r=e.collectionId:t=t.child(e.collectionId)}let i=[];n.where&&(i=Es(n.where));let o=[];n.orderBy&&(o=n.orderBy.map((e=>function(e){return new xt(xs(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e))));let a=null;n.limit&&(a=function(e){let t;return t="object"==typeof e?e.value:e,Re(t)?null:t}(n.limit));let u=null;n.startAt&&(u=function(e){const t=!!e.before,n=e.values||[];return new St(n,t)}(n.startAt));let c=null;return n.endAt&&(c=function(e){const t=!e.before,n=e.values||[];return new St(n,t)}(n.endAt)),kt(t,r,o,i,a,"F",u,c)}function Es(e){return e?void 0!==e.unaryFilter?[Ns(e)]:void 0!==e.fieldFilter?[Ds(e)]:void 0!==e.compositeFilter?e.compositeFilter.filters.map((e=>Es(e))).reduce(((e,t)=>e.concat(t))):w():[]}function bs(e){return Zn[e]}function Ts(e){return es[e]}function Ss(e){return{fieldPath:e.canonicalString()}}function xs(e){return q.fromServerFormat(e.fieldPath)}function Ds(e){return gt.create(xs(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return w()}}(e.fieldFilter.op),e.fieldFilter.value)}function Ns(e){switch(e.unaryFilter.op){case"IS_NAN":const t=xs(e.unaryFilter.field);return gt.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=xs(e.unaryFilter.field);return gt.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const s=xs(e.unaryFilter.field);return gt.create(s,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const r=xs(e.unaryFilter.field);return gt.create(r,"!=",{nullValue:"NULL_VALUE"});default:return w()}}function As(e){const t=[];return e.fields.forEach((e=>t.push(e.canonicalString()))),{fieldPaths:t}}function Cs(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}function ks(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t=Vs(t)),t=_s(e.get(n),t);return Vs(t)}function _s(e,t){let n=t;const s=e.length;for(let r=0;r<s;r++){const t=e.charAt(r);switch(t){case"\0":n+="\x01\x10";break;case"\x01":n+="\x01\x11";break;default:n+=t}}return n}function Vs(e){return e+"\x01\x01"}function Ms(e){const t=e.length;if(v(t>=2),2===t)return v("\x01"===e.charAt(0)&&"\x01"===e.charAt(1)),U.emptyPath();const n=t-2,s=[];let r="";for(let i=0;i<t;){const t=e.indexOf("\x01",i);switch((t<0||t>n)&&w(),e.charAt(t+1)){case"\x01":const n=e.substring(i,t);let o;0===r.length?o=n:(r+=n,o=r,r=""),s.push(o);break;case"\x10":r+=e.substring(i,t),r+="\0";break;case"\x11":r+=e.substring(i,t+1);break;default:w()}i=t+2}return new U(s)}const Rs=["userId","batchId"];function Os(e,t){return[e,ks(t)]}function Ls(e,t,n){return[e,ks(t),n]}const Fs={},Ps=["prefixPath","collectionGroup","readTime","documentId"],Us=["prefixPath","collectionGroup","documentId"],Bs=["collectionGroup","readTime","prefixPath","documentId"],qs=["canonicalId","targetId"],Ks=["targetId","path"],Gs=["path","targetId"],$s=["collectionId","parent"],zs=["indexId","uid"],js=["uid","sequenceNumber"],Qs=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],Hs=["indexId","uid","orderedDocumentKey"],Ws=["userId","collectionPath","documentId"],Js=["userId","collectionPath","largestBatchId"],Ys=["userId","collectionGroup","largestBatchId"],Xs=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],Zs=[...Xs,"documentOverlays"],er=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],tr=er,nr=[...tr,"indexConfiguration","indexState","indexEntries"];class sr extends Z{constructor(e,t){super(),this.ee=e,this.currentSequenceNumber=t}}function rr(e,t){const n=I(e);return se.N(n.ee,t)}class ir{constructor(e,t,n,s){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=s}applyToRemoteDocument(e,t){const n=t.mutationResults;for(let s=0;s<this.mutations.length;s++){const t=this.mutations[s];t.key.isEqual(e.key)&&mn(t,e,n[s])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=gn(n,e,t,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(e.key)&&(t=gn(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const n=Fn();return this.mutations.forEach((s=>{const r=e.get(s.key),i=r.overlayedDocument;let o=this.applyToLocalView(i,r.mutatedFields);o=t.has(s.key)?null:o;const a=fn(i,o);null!==a&&n.set(s.key,a),i.isValidDocument()||i.convertToNoDocument(F.min())})),n}keys(){return this.mutations.reduce(((e,t)=>e.add(t.key)),qn())}isEqual(e){return this.batchId===e.batchId&&R(this.mutations,e.mutations,((e,t)=>yn(e,t)))&&R(this.baseMutations,e.baseMutations,((e,t)=>yn(e,t)))}}class or{constructor(e,t,n,s){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=s}static from(e,t,n){v(e.mutations.length===n.length);let s=Un;const r=e.mutations;for(let i=0;i<r.length;i++)s=s.insert(r[i].key,n[i].version);return new or(e,t,n,s)}}class ar{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class ur{constructor(e,t,n,s,r=F.min(),i=F.min(),o=Se.EMPTY_BYTE_STRING){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=s,this.snapshotVersion=r,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o}withSequenceNumber(e){return new ur(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(e,t){return new ur(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e)}withLastLimboFreeSnapshotVersion(e){return new ur(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken)}}class cr{constructor(e){this.ne=e}}function lr(e,t){const n=t.key,s={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:hr(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())s.document=function(e,t){return{name:us(e,t.key),fields:t.data.value.mapValue.fields,updateTime:ns(e,t.version.toTimestamp())}}(e.ne,t);else if(t.isNoDocument())s.noDocument={path:n.path.toArray(),readTime:dr(t.version)};else{if(!t.isUnknownDocument())return w();s.unknownDocument={path:n.path.toArray(),version:dr(t.version)}}return s}function hr(e){const t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function dr(e){const t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function fr(e){const t=new L(e.seconds,e.nanoseconds);return F.fromTimestamp(t)}function mr(e,t){const n=(t.baseMutations||[]).map((t=>ys(e.ne,t)));for(let i=0;i<t.mutations.length-1;++i){const e=t.mutations[i];if(i+1<t.mutations.length&&void 0!==t.mutations[i+1].transform){const n=t.mutations[i+1];e.updateTransforms=n.transform.fieldTransforms,t.mutations.splice(i+1,1),++i}}const s=t.mutations.map((t=>ys(e.ne,t))),r=L.fromMillis(t.localWriteTimeMs);return new ir(t.batchId,r,n,s)}function gr(e){const t=fr(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?fr(e.lastLimboFreeSnapshotVersion):F.min();let s;var r;return void 0!==e.query.documents?(v(1===(r=e.query).documents.length),s=Ft(_t(hs(r.documents[0])))):s=function(e){return Ft(Is(e))}(e.query),new ur(s,e.targetId,0,e.lastListenSequenceNumber,t,n,Se.fromBase64String(e.resumeToken))}function pr(e,t){const n=dr(t.snapshotVersion),s=dr(t.lastLimboFreeSnapshotVersion);let r;r=ht(t.target)?ws(e.ne,t.target):vs(e.ne,t.target);const i=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:ct(t.target),readTime:n,resumeToken:i,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:s,query:r}}function yr(e){const t=Is({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Pt(t,t.limit,"L"):t}function wr(e,t){return new ar(t.largestBatchId,ys(e.ne,t.overlayMutation))}function vr(e,t){const n=t.path.lastSegment();return[e,ks(t.path.popLast()),n]}function Ir(e,t,n,s){return{indexId:e,uid:t.uid||"",sequenceNumber:n,readTime:dr(s.readTime),documentKey:ks(s.documentKey.path),largestBatchId:s.largestBatchId}}class Er{getBundleMetadata(e,t){return br(e).get(t).next((e=>{if(e)return{id:(t=e).bundleId,createTime:fr(t.createTime),version:t.version};var t}))}saveBundleMetadata(e,t){return br(e).put({bundleId:(n=t).id,createTime:dr(is(n.createTime)),version:n.version});var n}getNamedQuery(e,t){return Tr(e).get(t).next((e=>{if(e)return{name:(t=e).name,query:yr(t.bundledQuery),readTime:fr(t.readTime)};var t}))}saveNamedQuery(e,t){return Tr(e).put(function(e){return{name:e.name,readTime:dr(is(e.readTime)),bundledQuery:e.bundledQuery}}(t))}}function br(e){return rr(e,"bundles")}function Tr(e){return rr(e,"namedQueries")}class Sr{constructor(e,t){this.wt=e,this.userId=t}static se(e,t){const n=t.uid||"";return new Sr(e,n)}getOverlay(e,t){return xr(e).get(vr(this.userId,t)).next((e=>e?wr(this.wt,e):null))}getOverlays(e,t){const n=Ln();return te.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){const s=[];return n.forEach(((n,r)=>{const i=new ar(t,r);s.push(this.ie(e,i))})),te.waitFor(s)}removeOverlaysForBatchId(e,t,n){const s=new Set;t.forEach((e=>s.add(ks(e.getCollectionPath()))));const r=[];return s.forEach((t=>{const s=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);r.push(xr(e).W("collectionPathOverlayIndex",s))})),te.waitFor(r)}getOverlaysForCollection(e,t,n){const s=Ln(),r=ks(t),i=IDBKeyRange.bound([this.userId,r,n],[this.userId,r,Number.POSITIVE_INFINITY],!0);return xr(e).K("collectionPathOverlayIndex",i).next((e=>{for(const t of e){const e=wr(this.wt,t);s.set(e.getKey(),e)}return s}))}getOverlaysForCollectionGroup(e,t,n,s){const r=Ln();let i;const o=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return xr(e).J({index:"collectionGroupOverlayIndex",range:o},((e,t,n)=>{const o=wr(this.wt,t);r.size()<s||o.largestBatchId===i?(r.set(o.getKey(),o),i=o.largestBatchId):n.done()})).next((()=>r))}ie(e,t){return xr(e).put(function(e,t,n){const[s,r,i]=vr(t,n.mutation.key);return{userId:t,collectionPath:r,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:ps(e.ne,n.mutation)}}(this.wt,this.userId,t))}}function xr(e){return rr(e,"documentOverlays")}class Dr{constructor(){}re(e,t){this.oe(e,t),t.ue()}oe(e,t){if("nullValue"in e)this.ce(t,5);else if("booleanValue"in e)this.ce(t,10),t.ae(e.booleanValue?1:0);else if("integerValue"in e)this.ce(t,15),t.ae(Ne(e.integerValue));else if("doubleValue"in e){const n=Ne(e.doubleValue);isNaN(n)?this.ce(t,13):(this.ce(t,15),Oe(n)?t.ae(0):t.ae(n))}else if("timestampValue"in e){const n=e.timestampValue;this.ce(t,20),"string"==typeof n?t.he(n):(t.he(`${n.seconds||""}`),t.ae(n.nanos||0))}else if("stringValue"in e)this.le(e.stringValue,t),this.fe(t);else if("bytesValue"in e)this.ce(t,30),t.de(Ae(e.bytesValue)),this.fe(t);else if("referenceValue"in e)this._e(e.referenceValue,t);else if("geoPointValue"in e){const n=e.geoPointValue;this.ce(t,45),t.ae(n.latitude||0),t.ae(n.longitude||0)}else"mapValue"in e?Ze(e)?this.ce(t,Number.MAX_SAFE_INTEGER):(this.we(e.mapValue,t),this.fe(t)):"arrayValue"in e?(this.me(e.arrayValue,t),this.fe(t)):w()}le(e,t){this.ce(t,25),this.ge(e,t)}ge(e,t){t.he(e)}we(e,t){const n=e.fields||{};this.ce(t,55);for(const s of Object.keys(n))this.le(s,t),this.oe(n[s],t)}me(e,t){const n=e.values||[];this.ce(t,50);for(const s of n)this.oe(s,t)}_e(e,t){this.ce(t,37),K.fromName(e).path.forEach((e=>{this.ce(t,60),this.ge(e,t)}))}ce(e,t){e.ae(t)}fe(e){e.ae(2)}}function Nr(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}function Ar(e){const t=64-function(e){let t=0;for(let n=0;n<8;++n){const s=Nr(255&e[n]);if(t+=s,8!==s)break}return t}(e);return Math.ceil(t/8)}Dr.ye=new Dr;class Cr{constructor(){this.buffer=new Uint8Array(1024),this.position=0}pe(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ie(n.value),n=t.next();this.Te()}Ee(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ae(n.value),n=t.next();this.Re()}be(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ie(e);else if(e<2048)this.Ie(960|e>>>6),this.Ie(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ie(480|e>>>12),this.Ie(128|63&e>>>6),this.Ie(128|63&e);else{const e=t.codePointAt(0);this.Ie(240|e>>>18),this.Ie(128|63&e>>>12),this.Ie(128|63&e>>>6),this.Ie(128|63&e)}}this.Te()}Pe(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ae(e);else if(e<2048)this.Ae(960|e>>>6),this.Ae(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ae(480|e>>>12),this.Ae(128|63&e>>>6),this.Ae(128|63&e);else{const e=t.codePointAt(0);this.Ae(240|e>>>18),this.Ae(128|63&e>>>12),this.Ae(128|63&e>>>6),this.Ae(128|63&e)}}this.Re()}ve(e){const t=this.Ve(e),n=Ar(t);this.Se(1+n),this.buffer[this.position++]=255&n;for(let s=t.length-n;s<t.length;++s)this.buffer[this.position++]=255&t[s]}De(e){const t=this.Ve(e),n=Ar(t);this.Se(1+n),this.buffer[this.position++]=~(255&n);for(let s=t.length-n;s<t.length;++s)this.buffer[this.position++]=~(255&t[s])}Ce(){this.xe(255),this.xe(255)}Ne(){this.ke(255),this.ke(255)}reset(){this.position=0}seed(e){this.Se(e.length),this.buffer.set(e,this.position),this.position+=e.length}Me(){return this.buffer.slice(0,this.position)}Ve(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=0!=(128&t[0]);t[0]^=n?255:128;for(let s=1;s<t.length;++s)t[s]^=n?255:0;return t}Ie(e){const t=255&e;0===t?(this.xe(0),this.xe(255)):255===t?(this.xe(255),this.xe(0)):this.xe(t)}Ae(e){const t=255&e;0===t?(this.ke(0),this.ke(255)):255===t?(this.ke(255),this.ke(0)):this.ke(e)}Te(){this.xe(0),this.xe(1)}Re(){this.ke(0),this.ke(1)}xe(e){this.Se(1),this.buffer[this.position++]=e}ke(e){this.Se(1),this.buffer[this.position++]=~e}Se(e){const t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);const s=new Uint8Array(n);s.set(this.buffer),this.buffer=s}}class kr{constructor(e){this.Oe=e}de(e){this.Oe.pe(e)}he(e){this.Oe.be(e)}ae(e){this.Oe.ve(e)}ue(){this.Oe.Ce()}}class _r{constructor(e){this.Oe=e}de(e){this.Oe.Ee(e)}he(e){this.Oe.Pe(e)}ae(e){this.Oe.De(e)}ue(){this.Oe.Ne()}}class Vr{constructor(){this.Oe=new Cr,this.Fe=new kr(this.Oe),this.$e=new _r(this.Oe)}seed(e){this.Oe.seed(e)}Be(e){return 0===e?this.Fe:this.$e}Me(){return this.Oe.Me()}reset(){this.Oe.reset()}}class Mr{constructor(e,t,n,s){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=s}Le(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new Mr(this.indexId,this.documentKey,this.arrayValue,n)}}function Rr(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=Or(e.arrayValue,t.arrayValue),0!==n?n:(n=Or(e.directionalValue,t.directionalValue),0!==n?n:K.comparator(e.documentKey,t.documentKey)))}function Or(e,t){for(let n=0;n<e.length&&n<t.length;++n){const s=e[n]-t[n];if(0!==s)return s}return e.length-t.length}class Lr{constructor(e){this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Ue=e.orderBy,this.qe=[];for(const t of e.filters){const e=t;e.ht()?this.Ke=e:this.qe.push(e)}}Ge(e){const t=$(e);if(void 0!==t&&!this.Qe(t))return!1;const n=z(e);let s=0,r=0;for(;s<n.length&&this.Qe(n[s]);++s);if(s===n.length)return!0;if(void 0!==this.Ke){const e=n[s];if(!this.je(this.Ke,e)||!this.We(this.Ue[r++],e))return!1;++s}for(;s<n.length;++s){const e=n[s];if(r>=this.Ue.length||!this.We(this.Ue[r++],e))return!1}return!0}Qe(e){for(const t of this.qe)if(this.je(t,e))return!0;return!1}je(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;const n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}We(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}class Fr{constructor(){this.ze=new Pr}addToCollectionParentIndex(e,t){return this.ze.add(t),te.resolve()}getCollectionParents(e,t){return te.resolve(this.ze.getEntries(t))}addFieldIndex(e,t){return te.resolve()}deleteFieldIndex(e,t){return te.resolve()}getDocumentsMatchingTarget(e,t){return te.resolve(null)}getIndexType(e,t){return te.resolve(0)}getFieldIndexes(e,t){return te.resolve([])}getNextCollectionGroupToUpdate(e){return te.resolve(null)}getMinOffset(e,t){return te.resolve(J.min())}getMinOffsetFromCollectionGroup(e,t){return te.resolve(J.min())}updateCollectionGroup(e,t,n){return te.resolve()}updateIndexEntries(e,t){return te.resolve()}}class Pr{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),s=this.index[t]||new Ie(U.comparator),r=!s.has(n);return this.index[t]=s.add(n),r}has(e){const t=e.lastSegment(),n=e.popLast(),s=this.index[t];return s&&s.has(n)}getEntries(e){return(this.index[e]||new Ie(U.comparator)).toArray()}}const Ur=new Uint8Array(0);class Br{constructor(e,t){this.user=e,this.databaseId=t,this.He=new Pr,this.Je=new kn((e=>ct(e)),((e,t)=>lt(e,t))),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.He.has(t)){const n=t.lastSegment(),s=t.popLast();e.addOnCommittedListener((()=>{this.He.add(t)}));const r={collectionId:n,parent:ks(s)};return qr(e).put(r)}return te.resolve()}getCollectionParents(e,t){const n=[],s=IDBKeyRange.bound([t,""],[O(t),""],!1,!0);return qr(e).K(s).next((e=>{for(const s of e){if(s.collectionId!==t)break;n.push(Ms(s.parent))}return n}))}addFieldIndex(e,t){const n=Gr(e),s=function(e){return{indexId:e.indexId,collectionGroup:e.collectionGroup,fields:e.fields.map((e=>[e.fieldPath.canonicalString(),e.kind]))}}(t);delete s.indexId;const r=n.add(s);if(t.indexState){const n=$r(e);return r.next((e=>{n.put(Ir(e,this.user,t.indexState.sequenceNumber,t.indexState.offset))}))}return r.next()}deleteFieldIndex(e,t){const n=Gr(e),s=$r(e),r=Kr(e);return n.delete(t.indexId).next((()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))).next((()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))))}getDocumentsMatchingTarget(e,t){const n=Kr(e);let s=!0;const r=new Map;return te.forEach(this.Ye(t),(t=>this.Xe(e,t).next((e=>{s&&(s=!!e),r.set(t,e)})))).next((()=>{if(s){let e=qn();const s=[];return te.forEach(r,((r,i)=>{var o;m("IndexedDbIndexManager",`Using index ${o=r,`id=${o.indexId}|cg=${o.collectionGroup}|f=${o.fields.map((e=>`${e.fieldPath}:${e.kind}`)).join(",")}`} to execute ${ct(t)}`);const a=function(e,t){const n=$(t);if(void 0===n)return null;for(const s of dt(e,n.fieldPath))switch(s.op){case"array-contains-any":return s.value.arrayValue.values||[];case"array-contains":return[s.value]}return null}(i,r),u=function(e,t){const n=new Map;for(const s of z(t))for(const t of dt(e,s.fieldPath))switch(t.op){case"==":case"in":n.set(s.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(s.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(i,r),c=function(e,t){const n=[];let s=!0;for(const r of z(t)){const t=0===r.kind?ft(e,r.fieldPath,e.startAt):mt(e,r.fieldPath,e.startAt);n.push(t.value),s&&(s=t.inclusive)}return new St(n,s)}(i,r),l=function(e,t){const n=[];let s=!0;for(const r of z(t)){const t=0===r.kind?mt(e,r.fieldPath,e.endAt):ft(e,r.fieldPath,e.endAt);n.push(t.value),s&&(s=t.inclusive)}return new St(n,s)}(i,r),h=this.Ze(r,i,c),d=this.Ze(r,i,l),f=this.tn(r,i,u),g=this.en(r.indexId,a,h,c.inclusive,d,l.inclusive,f);return te.forEach(g,(r=>n.j(r,t.limit).next((t=>{t.forEach((t=>{const n=K.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),s.push(n))}))}))))})).next((()=>s))}return te.resolve(null)}))}Ye(e){let t=this.Je.get(e);return t||(t=[e],this.Je.set(e,t),t)}en(e,t,n,s,r,i,o){const a=(null!=t?t.length:1)*Math.max(n.length,r.length),u=a/(null!=t?t.length:1),c=[];for(let l=0;l<a;++l){const a=t?this.nn(t[l/u]):Ur,h=this.sn(e,a,n[l%u],s),d=this.rn(e,a,r[l%u],i),f=o.map((t=>this.sn(e,a,t,!0)));c.push(...this.createRange(h,d,f))}return c}sn(e,t,n,s){const r=new Mr(e,K.empty(),t,n);return s?r:r.Le()}rn(e,t,n,s){const r=new Mr(e,K.empty(),t,n);return s?r.Le():r}Xe(e,t){const n=new Lr(t),s=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,s).next((e=>{let t=null;for(const s of e)n.Ge(s)&&(!t||s.fields.length>t.fields.length)&&(t=s);return t}))}getIndexType(e,t){let n=2;return te.forEach(this.Ye(t),(t=>this.Xe(e,t).next((e=>{e?0!==n&&e.fields.length<function(e){let t=new Ie(q.comparator),n=!1;for(const s of e.filters){const e=s;e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field))}for(const s of e.orderBy)s.field.isKeyField()||(t=t.add(s.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})))).next((()=>n))}on(e,t){const n=new Vr;for(const s of z(e)){const e=t.data.field(s.fieldPath);if(null==e)return null;const r=n.Be(s.kind);Dr.ye.re(e,r)}return n.Me()}nn(e){const t=new Vr;return Dr.ye.re(e,t.Be(0)),t.Me()}un(e,t){const n=new Vr;return Dr.ye.re(je(this.databaseId,t),n.Be(function(e){const t=z(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.Me()}tn(e,t,n){if(null===n)return[];let s=[];s.push(new Vr);let r=0;for(const i of z(e)){const e=n[r++];for(const n of s)if(this.cn(t,i.fieldPath)&&He(e))s=this.an(s,i,e);else{const t=n.Be(i.kind);Dr.ye.re(e,t)}}return this.hn(s)}Ze(e,t,n){return this.tn(e,t,n.position)}hn(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].Me();return t}an(e,t,n){const s=[...e],r=[];for(const i of n.arrayValue.values||[])for(const e of s){const n=new Vr;n.seed(e.Me()),Dr.ye.re(i,n.Be(t.kind)),r.push(n)}return r}cn(e,t){return!!e.filters.find((e=>e instanceof gt&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op)))}getFieldIndexes(e,t){const n=Gr(e),s=$r(e);return(t?n.K("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.K()).next((e=>{const t=[];return te.forEach(e,(e=>s.get([e.indexId,this.uid]).next((n=>{t.push(function(e,t){const n=t?new Q(t.sequenceNumber,new J(fr(t.readTime),new K(Ms(t.documentKey)),t.largestBatchId)):Q.empty(),s=e.fields.map((([e,t])=>new j(q.fromServerFormat(e),t)));return new G(e.indexId,e.collectionGroup,s,n)}(e,n))})))).next((()=>t))}))}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next((e=>0===e.length?null:(e.sort(((e,t)=>{const n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:M(e.collectionGroup,t.collectionGroup)})),e[0].collectionGroup)))}updateCollectionGroup(e,t,n){const s=Gr(e),r=$r(e);return this.ln(e).next((e=>s.K("collectionGroupIndex",IDBKeyRange.bound(t,t)).next((t=>te.forEach(t,(t=>r.put(Ir(t.indexId,this.user,e,n))))))))}updateIndexEntries(e,t){const n=new Map;return te.forEach(t,((t,s)=>{const r=n.get(t.collectionGroup);return(r?te.resolve(r):this.getFieldIndexes(e,t.collectionGroup)).next((r=>(n.set(t.collectionGroup,r),te.forEach(r,(n=>this.fn(e,t,n).next((t=>{const r=this.dn(s,n);return t.isEqual(r)?te.resolve():this._n(e,s,n,t,r)})))))))}))}wn(e,t,n,s){return Kr(e).put({indexId:s.indexId,uid:this.uid,arrayValue:s.arrayValue,directionalValue:s.directionalValue,orderedDocumentKey:this.un(n,t.key),documentKey:t.key.path.toArray()})}mn(e,t,n,s){return Kr(e).delete([s.indexId,this.uid,s.arrayValue,s.directionalValue,this.un(n,t.key),t.key.path.toArray()])}fn(e,t,n){const s=Kr(e);let r=new Ie(Rr);return s.J({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.un(n,t)])},((e,s)=>{r=r.add(new Mr(n.indexId,t,s.arrayValue,s.directionalValue))})).next((()=>r))}dn(e,t){let n=new Ie(Rr);const s=this.on(t,e);if(null==s)return n;const r=$(t);if(null!=r){const i=e.data.field(r.fieldPath);if(He(i))for(const r of i.arrayValue.values||[])n=n.add(new Mr(t.indexId,e.key,this.nn(r),s))}else n=n.add(new Mr(t.indexId,e.key,Ur,s));return n}_n(e,t,n,s,r){m("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);const i=[];return function(e,t,n,s,r){const i=e.getIterator(),o=t.getIterator();let a=be(i),u=be(o);for(;a||u;){let e=!1,t=!1;if(a&&u){const s=n(a,u);s<0?t=!0:s>0&&(e=!0)}else null!=a?t=!0:e=!0;e?(s(u),u=be(o)):t?(r(a),a=be(i)):(a=be(i),u=be(o))}}(s,r,Rr,(s=>{i.push(this.wn(e,t,n,s))}),(s=>{i.push(this.mn(e,t,n,s))})),te.waitFor(i)}ln(e){let t=1;return $r(e).J({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((e,n,s)=>{s.done(),t=n.sequenceNumber+1})).next((()=>t))}createRange(e,t,n){n=n.sort(((e,t)=>Rr(e,t))).filter(((e,t,n)=>!t||0!==Rr(e,n[t-1])));const s=[];s.push(e);for(const i of n){const n=Rr(i,e),r=Rr(i,t);if(0===n)s[0]=e.Le();else if(n>0&&r<0)s.push(i),s.push(i.Le());else if(r>0)break}s.push(t);const r=[];for(let i=0;i<s.length;i+=2)r.push(IDBKeyRange.bound([s[i].indexId,this.uid,s[i].arrayValue,s[i].directionalValue,Ur,[]],[s[i+1].indexId,this.uid,s[i+1].arrayValue,s[i+1].directionalValue,Ur,[]]));return r}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(zr)}getMinOffset(e,t){return te.mapArray(this.Ye(t),(t=>this.Xe(e,t).next((e=>e||w())))).next(zr)}}function qr(e){return rr(e,"collectionParents")}function Kr(e){return rr(e,"indexEntries")}function Gr(e){return rr(e,"indexConfiguration")}function $r(e){return rr(e,"indexState")}function zr(e){v(0!==e.length);let t=e[0].indexState.offset,n=t.largestBatchId;for(let s=1;s<e.length;s++){const r=e[s].indexState.offset;Y(r,t)<0&&(t=r),n<r.largestBatchId&&(n=r.largestBatchId)}return new J(t.readTime,t.documentKey,n)}const jr={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Qr{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new Qr(e,Qr.DEFAULT_COLLECTION_PERCENTILE,Qr.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function Hr(e,t,n){const s=e.store("mutations"),r=e.store("documentMutations"),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const u=s.J({range:o},((e,t,n)=>(a++,n.delete())));i.push(u.next((()=>{v(1===a)})));const c=[];for(const l of n.mutations){const e=Ls(t,l.key.path,n.batchId);i.push(r.delete(e)),c.push(l.key)}return te.waitFor(i).next((()=>c))}function Wr(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw w();t=e.noDocument}return JSON.stringify(t).length}Qr.DEFAULT_COLLECTION_PERCENTILE=10,Qr.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Qr.DEFAULT=new Qr(41943040,Qr.DEFAULT_COLLECTION_PERCENTILE,Qr.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Qr.DISABLED=new Qr(-1,0,0);class Jr{constructor(e,t,n,s){this.userId=e,this.wt=t,this.indexManager=n,this.referenceDelegate=s,this.gn={}}static se(e,t,n,s){v(""!==e.uid);const r=e.isAuthenticated()?e.uid:"";return new Jr(r,t,n,s)}checkEmpty(e){let t=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Xr(e).J({index:"userMutationsIndex",range:n},((e,n,s)=>{t=!1,s.done()})).next((()=>t))}addMutationBatch(e,t,n,s){const r=Zr(e),i=Xr(e);return i.add({}).next((o=>{v("number"==typeof o);const a=new ir(o,t,n,s),u=function(e,t,n){const s=n.baseMutations.map((t=>ps(e.ne,t))),r=n.mutations.map((t=>ps(e.ne,t)));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:s,mutations:r}}(this.wt,this.userId,a),c=[];let l=new Ie(((e,t)=>M(e.canonicalString(),t.canonicalString())));for(const e of s){const t=Ls(this.userId,e.key.path,o);l=l.add(e.key.path.popLast()),c.push(i.put(u)),c.push(r.put(t,Fs))}return l.forEach((t=>{c.push(this.indexManager.addToCollectionParentIndex(e,t))})),e.addOnCommittedListener((()=>{this.gn[o]=a.keys()})),te.waitFor(c).next((()=>a))}))}lookupMutationBatch(e,t){return Xr(e).get(t).next((e=>e?(v(e.userId===this.userId),mr(this.wt,e)):null))}yn(e,t){return this.gn[t]?te.resolve(this.gn[t]):this.lookupMutationBatch(e,t).next((e=>{if(e){const n=e.keys();return this.gn[t]=n,n}return null}))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,s=IDBKeyRange.lowerBound([this.userId,n]);let r=null;return Xr(e).J({index:"userMutationsIndex",range:s},((e,t,s)=>{t.userId===this.userId&&(v(t.batchId>=n),r=mr(this.wt,t)),s.done()})).next((()=>r))}getHighestUnacknowledgedBatchId(e){const t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return Xr(e).J({index:"userMutationsIndex",range:t,reverse:!0},((e,t,s)=>{n=t.batchId,s.done()})).next((()=>n))}getAllMutationBatches(e){const t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Xr(e).K("userMutationsIndex",t).next((e=>e.map((e=>mr(this.wt,e)))))}getAllMutationBatchesAffectingDocumentKey(e,t){const n=Os(this.userId,t.path),s=IDBKeyRange.lowerBound(n),r=[];return Zr(e).J({range:s},((n,s,i)=>{const[o,a,u]=n,c=Ms(a);if(o===this.userId&&t.path.isEqual(c))return Xr(e).get(u).next((e=>{if(!e)throw w();v(e.userId===this.userId),r.push(mr(this.wt,e))}));i.done()})).next((()=>r))}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new Ie(M);const s=[];return t.forEach((t=>{const r=Os(this.userId,t.path),i=IDBKeyRange.lowerBound(r),o=Zr(e).J({range:i},((e,s,r)=>{const[i,o,a]=e,u=Ms(o);i===this.userId&&t.path.isEqual(u)?n=n.add(a):r.done()}));s.push(o)})),te.waitFor(s).next((()=>this.pn(e,n)))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,s=n.length+1,r=Os(this.userId,n),i=IDBKeyRange.lowerBound(r);let o=new Ie(M);return Zr(e).J({range:i},((e,t,r)=>{const[i,a,u]=e,c=Ms(a);i===this.userId&&n.isPrefixOf(c)?c.length===s&&(o=o.add(u)):r.done()})).next((()=>this.pn(e,o)))}pn(e,t){const n=[],s=[];return t.forEach((t=>{s.push(Xr(e).get(t).next((e=>{if(null===e)throw w();v(e.userId===this.userId),n.push(mr(this.wt,e))})))})),te.waitFor(s).next((()=>n))}removeMutationBatch(e,t){return Hr(e.ee,this.userId,t).next((n=>(e.addOnCommittedListener((()=>{this.In(t.batchId)})),te.forEach(n,(t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))))}In(e){delete this.gn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next((t=>{if(!t)return te.resolve();const n=IDBKeyRange.lowerBound([this.userId]),s=[];return Zr(e).J({range:n},((e,t,n)=>{if(e[0]===this.userId){const t=Ms(e[1]);s.push(t)}else n.done()})).next((()=>{v(0===s.length)}))}))}containsKey(e,t){return Yr(e,this.userId,t)}Tn(e){return ei(e).get(this.userId).next((e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}))}}function Yr(e,t,n){const s=Os(t,n.path),r=s[1],i=IDBKeyRange.lowerBound(s);let o=!1;return Zr(e).J({range:i,H:!0},((e,n,s)=>{const[i,a,u]=e;i===t&&a===r&&(o=!0),s.done()})).next((()=>o))}function Xr(e){return rr(e,"mutations")}function Zr(e){return rr(e,"documentMutations")}function ei(e){return rr(e,"mutationQueues")}class ti{constructor(e){this.En=e}next(){return this.En+=2,this.En}static An(){return new ti(0)}static Rn(){return new ti(-1)}}class ni{constructor(e,t){this.referenceDelegate=e,this.wt=t}allocateTargetId(e){return this.bn(e).next((t=>{const n=new ti(t.highestTargetId);return t.highestTargetId=n.next(),this.Pn(e,t).next((()=>t.highestTargetId))}))}getLastRemoteSnapshotVersion(e){return this.bn(e).next((e=>F.fromTimestamp(new L(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(e){return this.bn(e).next((e=>e.highestListenSequenceNumber))}setTargetsMetadata(e,t,n){return this.bn(e).next((s=>(s.highestListenSequenceNumber=t,n&&(s.lastRemoteSnapshotVersion=n.toTimestamp()),t>s.highestListenSequenceNumber&&(s.highestListenSequenceNumber=t),this.Pn(e,s))))}addTargetData(e,t){return this.vn(e,t).next((()=>this.bn(e).next((n=>(n.targetCount+=1,this.Vn(t,n),this.Pn(e,n))))))}updateTargetData(e,t){return this.vn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next((()=>si(e).delete(t.targetId))).next((()=>this.bn(e))).next((t=>(v(t.targetCount>0),t.targetCount-=1,this.Pn(e,t))))}removeTargets(e,t,n){let s=0;const r=[];return si(e).J(((i,o)=>{const a=gr(o);a.sequenceNumber<=t&&null===n.get(a.targetId)&&(s++,r.push(this.removeTargetData(e,a)))})).next((()=>te.waitFor(r))).next((()=>s))}forEachTarget(e,t){return si(e).J(((e,n)=>{const s=gr(n);t(s)}))}bn(e){return ri(e).get("targetGlobalKey").next((e=>(v(null!==e),e)))}Pn(e,t){return ri(e).put("targetGlobalKey",t)}vn(e,t){return si(e).put(pr(this.wt,t))}Vn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.bn(e).next((e=>e.targetCount))}getTargetData(e,t){const n=ct(t),s=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let r=null;return si(e).J({range:s,index:"queryTargetsIndex"},((e,n,s)=>{const i=gr(n);lt(t,i.target)&&(r=i,s.done())})).next((()=>r))}addMatchingKeys(e,t,n){const s=[],r=ii(e);return t.forEach((t=>{const i=ks(t.path);s.push(r.put({targetId:n,path:i})),s.push(this.referenceDelegate.addReference(e,n,t))})),te.waitFor(s)}removeMatchingKeys(e,t,n){const s=ii(e);return te.forEach(t,(t=>{const r=ks(t.path);return te.waitFor([s.delete([n,r]),this.referenceDelegate.removeReference(e,n,t)])}))}removeMatchingKeysForTargetId(e,t){const n=ii(e),s=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(s)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),s=ii(e);let r=qn();return s.J({range:n,H:!0},((e,t,n)=>{const s=Ms(e[1]),i=new K(s);r=r.add(i)})).next((()=>r))}containsKey(e,t){const n=ks(t.path),s=IDBKeyRange.bound([n],[O(n)],!1,!0);let r=0;return ii(e).J({index:"documentTargetsIndex",H:!0,range:s},(([e,t],n,s)=>{0!==e&&(r++,s.done())})).next((()=>r>0))}te(e,t){return si(e).get(t).next((e=>e?gr(e):null))}}function si(e){return rr(e,"targets")}function ri(e){return rr(e,"targetGlobal")}function ii(e){return rr(e,"targetDocuments")}function oi([e,t],[n,s]){const r=M(e,n);return 0===r?M(t,s):r}class ai{constructor(e){this.Sn=e,this.buffer=new Ie(oi),this.Dn=0}Cn(){return++this.Dn}xn(e){const t=[e,this.Cn()];if(this.buffer.size<this.Sn)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();oi(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class ui{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Nn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.kn(6e4)}stop(){this.Nn&&(this.Nn.cancel(),this.Nn=null)}get started(){return null!==this.Nn}kn(e){m("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.Nn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,(async()=>{this.Nn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){oe(e)?m("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await ee(e)}await this.kn(3e5)}))}}class ci{constructor(e,t){this.Mn=e,this.params=t}calculateTargetCount(e,t){return this.Mn.On(e).next((e=>Math.floor(t/100*e)))}nthSequenceNumber(e,t){if(0===t)return te.resolve(fe.ot);const n=new ai(t);return this.Mn.forEachTarget(e,(e=>n.xn(e.sequenceNumber))).next((()=>this.Mn.Fn(e,(e=>n.xn(e))))).next((()=>n.maxValue))}removeTargets(e,t,n){return this.Mn.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.Mn.removeOrphanedDocuments(e,t)}collect(e,t){return-1===this.params.cacheSizeCollectionThreshold?(m("LruGarbageCollector","Garbage collection skipped; disabled"),te.resolve(jr)):this.getCacheSize(e).next((n=>n<this.params.cacheSizeCollectionThreshold?(m("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),jr):this.$n(e,t)))}getCacheSize(e){return this.Mn.getCacheSize(e)}$n(e,t){let n,s,r,o,a,u,c;const l=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next((t=>(t>this.params.maximumSequenceNumbersToCollect?(m("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),s=this.params.maximumSequenceNumbersToCollect):s=t,o=Date.now(),this.nthSequenceNumber(e,s)))).next((s=>(n=s,a=Date.now(),this.removeTargets(e,n,t)))).next((t=>(r=t,u=Date.now(),this.removeOrphanedDocuments(e,n)))).next((e=>(c=Date.now(),f()<=i.in.DEBUG&&m("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${o-l}ms\n\tDetermined least recently used ${s} in `+(a-o)+"ms\n"+`\tRemoved ${r} targets in `+(u-a)+"ms\n"+`\tRemoved ${e} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-l}ms`),te.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:r,documentsRemoved:e}))))}}class li{constructor(e,t){this.db=e,this.garbageCollector=function(e,t){return new ci(e,t)}(this,t)}On(e){const t=this.Bn(e);return this.db.getTargetCache().getTargetCount(e).next((e=>t.next((t=>e+t))))}Bn(e){let t=0;return this.Fn(e,(e=>{t++})).next((()=>t))}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Fn(e,t){return this.Ln(e,((e,n)=>t(n)))}addReference(e,t,n){return hi(e,n)}removeReference(e,t,n){return hi(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return hi(e,t)}Un(e,t){return function(e,t){let n=!1;return ei(e).Y((s=>Yr(e,s,t).next((e=>(e&&(n=!0),te.resolve(!e)))))).next((()=>n))}(e,t)}removeOrphanedDocuments(e,t){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),s=[];let r=0;return this.Ln(e,((i,o)=>{if(o<=t){const t=this.Un(e,i).next((t=>{if(!t)return r++,n.getEntry(e,i).next((()=>(n.removeEntry(i,F.min()),ii(e).delete([0,ks(i.path)]))))}));s.push(t)}})).next((()=>te.waitFor(s))).next((()=>n.apply(e))).next((()=>r))}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return hi(e,t)}Ln(e,t){const n=ii(e);let s,r=fe.ot;return n.J({index:"documentTargetsIndex"},(([e,n],{path:i,sequenceNumber:o})=>{0===e?(r!==fe.ot&&t(new K(Ms(s)),r),r=o,s=i):r=fe.ot})).next((()=>{r!==fe.ot&&t(new K(Ms(s)),r)}))}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function hi(e,t){return ii(e).put(function(e,t){return{targetId:0,path:ks(e.path),sequenceNumber:t}}(t,e.currentSequenceNumber))}class di{constructor(){this.changes=new kn((e=>e.toString()),((e,t)=>e.isEqual(t))),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,ot.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const n=this.changes.get(t);return void 0!==n?te.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class fi{constructor(e){this.wt=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return yi(e).put(n)}removeEntry(e,t,n){return yi(e).delete(function(e,t){const n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],hr(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next((n=>(n.byteSize+=t,this.qn(e,n))))}getEntry(e,t){let n=ot.newInvalidDocument(t);return yi(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(wi(t))},((e,s)=>{n=this.Kn(t,s)})).next((()=>n))}Gn(e,t){let n={size:0,document:ot.newInvalidDocument(t)};return yi(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(wi(t))},((e,s)=>{n={document:this.Kn(t,s),size:Wr(s)}})).next((()=>n))}getEntries(e,t){let n=Vn();return this.Qn(e,t,((e,t)=>{const s=this.Kn(e,t);n=n.insert(e,s)})).next((()=>n))}jn(e,t){let n=Vn(),s=new ye(K.comparator);return this.Qn(e,t,((e,t)=>{const r=this.Kn(e,t);n=n.insert(e,r),s=s.insert(e,Wr(t))})).next((()=>({documents:n,Wn:s})))}Qn(e,t,n){if(t.isEmpty())return te.resolve();let s=new Ie(Ii);t.forEach((e=>s=s.add(e)));const r=IDBKeyRange.bound(wi(s.first()),wi(s.last())),i=s.getIterator();let o=i.getNext();return yi(e).J({index:"documentKeyIndex",range:r},((e,t,s)=>{const r=K.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;o&&Ii(o,r)<0;)n(o,null),o=i.getNext();o&&o.isEqual(r)&&(n(o,t),o=i.hasNext()?i.getNext():null),o?s.q(wi(o)):s.done()})).next((()=>{for(;o;)n(o,null),o=i.hasNext()?i.getNext():null}))}getAllFromCollection(e,t,n){const s=[t.popLast().toArray(),t.lastSegment(),hr(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],r=[t.popLast().toArray(),t.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return yi(e).K(IDBKeyRange.bound(s,r,!0)).next((e=>{let t=Vn();for(const n of e){const e=this.Kn(K.fromSegments(n.prefixPath.concat(n.collectionGroup,n.documentId)),n);t=t.insert(e.key,e)}return t}))}getAllFromCollectionGroup(e,t,n,s){let r=Vn();const i=vi(t,n),o=vi(t,J.max());return yi(e).J({index:"collectionGroupIndex",range:IDBKeyRange.bound(i,o,!0)},((e,t,n)=>{const i=this.Kn(K.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);r=r.insert(i.key,i),r.size===s&&n.done()})).next((()=>r))}newChangeBuffer(e){return new gi(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next((e=>e.byteSize))}getMetadata(e){return pi(e).get("remoteDocumentGlobalKey").next((e=>(v(!!e),e)))}qn(e,t){return pi(e).put("remoteDocumentGlobalKey",t)}Kn(e,t){if(t){const e=function(e,t){let n;if(t.document)n=gs(e.ne,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=K.fromSegments(t.noDocument.path),s=fr(t.noDocument.readTime);n=ot.newNoDocument(e,s),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return w();{const e=K.fromSegments(t.unknownDocument.path),s=fr(t.unknownDocument.version);n=ot.newUnknownDocument(e,s)}}return t.readTime&&n.setReadTime(function(e){const t=new L(e[0],e[1]);return F.fromTimestamp(t)}(t.readTime)),n}(this.wt,t);if(!e.isNoDocument()||!e.version.isEqual(F.min()))return e}return ot.newInvalidDocument(e)}}function mi(e){return new fi(e)}class gi extends di{constructor(e,t){super(),this.zn=e,this.trackRemovals=t,this.Hn=new kn((e=>e.toString()),((e,t)=>e.isEqual(t)))}applyChanges(e){const t=[];let n=0,s=new Ie(((e,t)=>M(e.canonicalString(),t.canonicalString())));return this.changes.forEach(((r,i)=>{const o=this.Hn.get(r);if(t.push(this.zn.removeEntry(e,r,o.readTime)),i.isValidDocument()){const a=lr(this.zn.wt,i);s=s.add(r.path.popLast());const u=Wr(a);n+=u-o.size,t.push(this.zn.addEntry(e,r,a))}else if(n-=o.size,this.trackRemovals){const n=lr(this.zn.wt,i.convertToNoDocument(F.min()));t.push(this.zn.addEntry(e,r,n))}})),s.forEach((n=>{t.push(this.zn.indexManager.addToCollectionParentIndex(e,n))})),t.push(this.zn.updateMetadata(e,n)),te.waitFor(t)}getFromCache(e,t){return this.zn.Gn(e,t).next((e=>(this.Hn.set(t,{size:e.size,readTime:e.document.readTime}),e.document)))}getAllFromCache(e,t){return this.zn.jn(e,t).next((({documents:e,Wn:t})=>(t.forEach(((t,n)=>{this.Hn.set(t,{size:n,readTime:e.get(t).readTime})})),e)))}}function pi(e){return rr(e,"remoteDocumentGlobal")}function yi(e){return rr(e,"remoteDocumentsV14")}function wi(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function vi(e,t){const n=t.documentKey.path.toArray();return[e,hr(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function Ii(e,t){const n=e.path.toArray(),s=t.path.toArray();let r=0;for(let i=0;i<n.length-2&&i<s.length-2;++i)if(r=M(n[i],s[i]),r)return r;return r=M(n.length,s.length),r||(r=M(n[n.length-2],s[s.length-2]),r||M(n[n.length-1],s[s.length-1]))}class Ei{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class bi{constructor(e,t,n,s){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=s}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next((s=>(n=s,this.getBaseDocument(e,t,n)))).next((e=>(null!==n&&gn(n.mutation,e,Te.empty(),L.now()),e)))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.getLocalViewOfDocuments(e,t,qn()).next((()=>t))))}getLocalViewOfDocuments(e,t,n=qn()){const s=Ln();return this.populateOverlays(e,s,t).next((()=>this.computeViews(e,t,s,n).next((e=>{let t=Rn();return e.forEach(((e,n)=>{t=t.insert(e,n.overlayedDocument)})),t}))))}getOverlayedDocuments(e,t){const n=Ln();return this.populateOverlays(e,n,t).next((()=>this.computeViews(e,t,n,qn())))}populateOverlays(e,t,n){const s=[];return n.forEach((e=>{t.has(e)||s.push(e)})),this.documentOverlayCache.getOverlays(e,s).next((e=>{e.forEach(((e,n)=>{t.set(e,n)}))}))}computeViews(e,t,n,s){let r=Vn();const i=Pn(),o=Pn();return t.forEach(((e,t)=>{const o=n.get(t.key);s.has(t.key)&&(void 0===o||o.mutation instanceof vn)?r=r.insert(t.key,t):void 0!==o&&(i.set(t.key,o.mutation.getFieldMask()),gn(o.mutation,t,o.mutation.getFieldMask(),L.now()))})),this.recalculateAndSaveOverlays(e,r).next((e=>(e.forEach(((e,t)=>i.set(e,t))),t.forEach(((e,t)=>{var n;return o.set(e,new Ei(t,null!==(n=i.get(e))&&void 0!==n?n:null))})),o)))}recalculateAndSaveOverlays(e,t){const n=Pn();let s=new ye(((e,t)=>e-t)),r=qn();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next((e=>{for(const r of e)r.keys().forEach((e=>{const i=t.get(e);if(null===i)return;let o=n.get(e)||Te.empty();o=r.applyToLocalView(i,o),n.set(e,o);const a=(s.get(r.batchId)||qn()).add(e);s=s.insert(r.batchId,a)}))})).next((()=>{const i=[],o=s.getReverseIterator();for(;o.hasNext();){const s=o.getNext(),a=s.key,u=s.value,c=Fn();u.forEach((e=>{if(!r.has(e)){const s=fn(t.get(e),n.get(e));null!==s&&c.set(e,s),r=r.add(e)}})),i.push(this.documentOverlayCache.saveOverlays(e,a,c))}return te.waitFor(i)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.recalculateAndSaveOverlays(e,t)))}getDocumentsMatchingQuery(e,t,n){return function(e){return K.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):Ot(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n):this.getDocumentsMatchingCollectionQuery(e,t,n)}getNextDocuments(e,t,n,s){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,s).next((r=>{const i=s-r.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,s-r.size):te.resolve(Ln());let o=-1,a=r;return i.next((t=>te.forEach(t,((t,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),r.get(t)?te.resolve():this.getBaseDocument(e,t,n).next((e=>{a=a.insert(t,e)}))))).next((()=>this.populateOverlays(e,t,r))).next((()=>this.computeViews(e,a,t,qn()))).next((e=>({batchId:o,changes:On(e)})))))}))}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new K(t)).next((e=>{let t=Rn();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t}))}getDocumentsMatchingCollectionGroupQuery(e,t,n){const s=t.collectionGroup;let r=Rn();return this.indexManager.getCollectionParents(e,s).next((i=>te.forEach(i,(i=>{const o=function(e,t){return new Ct(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(t,i.child(s));return this.getDocumentsMatchingCollectionQuery(e,o,n).next((e=>{e.forEach(((e,t)=>{r=r.insert(e,t)}))}))})).next((()=>r))))}getDocumentsMatchingCollectionQuery(e,t,n){let s;return this.remoteDocumentCache.getAllFromCollection(e,t.path,n).next((r=>(s=r,this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId)))).next((e=>{e.forEach(((e,t)=>{const n=t.getKey();null===s.get(n)&&(s=s.insert(n,ot.newInvalidDocument(n)))}));let n=Rn();return s.forEach(((s,r)=>{const i=e.get(s);void 0!==i&&gn(i.mutation,r,Te.empty(),L.now()),Kt(t,r)&&(n=n.insert(s,r))})),n}))}getBaseDocument(e,t,n){return null===n||1===n.mutation.type?this.remoteDocumentCache.getEntry(e,t):te.resolve(ot.newInvalidDocument(t))}}class Ti{constructor(e){this.wt=e,this.Jn=new Map,this.Yn=new Map}getBundleMetadata(e,t){return te.resolve(this.Jn.get(t))}saveBundleMetadata(e,t){var n;return this.Jn.set(t.id,{id:(n=t).id,version:n.version,createTime:is(n.createTime)}),te.resolve()}getNamedQuery(e,t){return te.resolve(this.Yn.get(t))}saveNamedQuery(e,t){return this.Yn.set(t.name,function(e){return{name:e.name,query:yr(e.bundledQuery),readTime:is(e.readTime)}}(t)),te.resolve()}}class Si{constructor(){this.overlays=new ye(K.comparator),this.Xn=new Map}getOverlay(e,t){return te.resolve(this.overlays.get(t))}getOverlays(e,t){const n=Ln();return te.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){return n.forEach(((n,s)=>{this.ie(e,t,s)})),te.resolve()}removeOverlaysForBatchId(e,t,n){const s=this.Xn.get(n);return void 0!==s&&(s.forEach((e=>this.overlays=this.overlays.remove(e))),this.Xn.delete(n)),te.resolve()}getOverlaysForCollection(e,t,n){const s=Ln(),r=t.length+1,i=new K(t.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const e=o.getNext().value,i=e.getKey();if(!t.isPrefixOf(i.path))break;i.path.length===r&&e.largestBatchId>n&&s.set(e.getKey(),e)}return te.resolve(s)}getOverlaysForCollectionGroup(e,t,n,s){let r=new ye(((e,t)=>e-t));const i=this.overlays.getIterator();for(;i.hasNext();){const e=i.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=r.get(e.largestBatchId);null===t&&(t=Ln(),r=r.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}const o=Ln(),a=r.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((e,t)=>o.set(e,t))),!(o.size()>=s)););return te.resolve(o)}ie(e,t,n){const s=this.overlays.get(n.key);if(null!==s){const e=this.Xn.get(s.largestBatchId).delete(n.key);this.Xn.set(s.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new ar(t,n));let r=this.Xn.get(t);void 0===r&&(r=qn(),this.Xn.set(t,r)),this.Xn.set(t,r.add(n.key))}}class xi{constructor(){this.Zn=new Ie(Di.ts),this.es=new Ie(Di.ns)}isEmpty(){return this.Zn.isEmpty()}addReference(e,t){const n=new Di(e,t);this.Zn=this.Zn.add(n),this.es=this.es.add(n)}ss(e,t){e.forEach((e=>this.addReference(e,t)))}removeReference(e,t){this.rs(new Di(e,t))}os(e,t){e.forEach((e=>this.removeReference(e,t)))}us(e){const t=new K(new U([])),n=new Di(t,e),s=new Di(t,e+1),r=[];return this.es.forEachInRange([n,s],(e=>{this.rs(e),r.push(e.key)})),r}cs(){this.Zn.forEach((e=>this.rs(e)))}rs(e){this.Zn=this.Zn.delete(e),this.es=this.es.delete(e)}hs(e){const t=new K(new U([])),n=new Di(t,e),s=new Di(t,e+1);let r=qn();return this.es.forEachInRange([n,s],(e=>{r=r.add(e.key)})),r}containsKey(e){const t=new Di(e,0),n=this.Zn.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class Di{constructor(e,t){this.key=e,this.ls=t}static ts(e,t){return K.comparator(e.key,t.key)||M(e.ls,t.ls)}static ns(e,t){return M(e.ls,t.ls)||K.comparator(e.key,t.key)}}class Ni{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.fs=1,this.ds=new Ie(Di.ts)}checkEmpty(e){return te.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,s){const r=this.fs;this.fs++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const i=new ir(r,t,n,s);this.mutationQueue.push(i);for(const o of s)this.ds=this.ds.add(new Di(o.key,r)),this.indexManager.addToCollectionParentIndex(e,o.key.path.popLast());return te.resolve(i)}lookupMutationBatch(e,t){return te.resolve(this._s(t))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,s=this.ws(n),r=s<0?0:s;return te.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return te.resolve(0===this.mutationQueue.length?-1:this.fs-1)}getAllMutationBatches(e){return te.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new Di(t,0),s=new Di(t,Number.POSITIVE_INFINITY),r=[];return this.ds.forEachInRange([n,s],(e=>{const t=this._s(e.ls);r.push(t)})),te.resolve(r)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new Ie(M);return t.forEach((e=>{const t=new Di(e,0),s=new Di(e,Number.POSITIVE_INFINITY);this.ds.forEachInRange([t,s],(e=>{n=n.add(e.ls)}))})),te.resolve(this.gs(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,s=n.length+1;let r=n;K.isDocumentKey(r)||(r=r.child(""));const i=new Di(new K(r),0);let o=new Ie(M);return this.ds.forEachWhile((e=>{const t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===s&&(o=o.add(e.ls)),!0)}),i),te.resolve(this.gs(o))}gs(e){const t=[];return e.forEach((e=>{const n=this._s(e);null!==n&&t.push(n)})),t}removeMutationBatch(e,t){v(0===this.ys(t.batchId,"removed")),this.mutationQueue.shift();let n=this.ds;return te.forEach(t.mutations,(s=>{const r=new Di(s.key,t.batchId);return n=n.delete(r),this.referenceDelegate.markPotentiallyOrphaned(e,s.key)})).next((()=>{this.ds=n}))}In(e){}containsKey(e,t){const n=new Di(t,0),s=this.ds.firstAfterOrEqual(n);return te.resolve(t.isEqual(s&&s.key))}performConsistencyCheck(e){return this.mutationQueue.length,te.resolve()}ys(e,t){return this.ws(e)}ws(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}_s(e){const t=this.ws(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class Ai{constructor(e){this.ps=e,this.docs=new ye(K.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,s=this.docs.get(n),r=s?s.size:0,i=this.ps(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-r,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return te.resolve(n?n.document.mutableCopy():ot.newInvalidDocument(t))}getEntries(e,t){let n=Vn();return t.forEach((e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():ot.newInvalidDocument(e))})),te.resolve(n)}getAllFromCollection(e,t,n){let s=Vn();const r=new K(t.child("")),i=this.docs.getIteratorFrom(r);for(;i.hasNext();){const{key:e,value:{document:r}}=i.getNext();if(!t.isPrefixOf(e.path))break;e.path.length>t.length+1||Y(W(r),n)<=0||(s=s.insert(r.key,r.mutableCopy()))}return te.resolve(s)}getAllFromCollectionGroup(e,t,n,s){w()}Is(e,t){return te.forEach(this.docs,(e=>t(e)))}newChangeBuffer(e){return new Ci(this)}getSize(e){return te.resolve(this.size)}}class Ci extends di{constructor(e){super(),this.zn=e}applyChanges(e){const t=[];return this.changes.forEach(((n,s)=>{s.isValidDocument()?t.push(this.zn.addEntry(e,s)):this.zn.removeEntry(n)})),te.waitFor(t)}getFromCache(e,t){return this.zn.getEntry(e,t)}getAllFromCache(e,t){return this.zn.getEntries(e,t)}}class ki{constructor(e){this.persistence=e,this.Ts=new kn((e=>ct(e)),lt),this.lastRemoteSnapshotVersion=F.min(),this.highestTargetId=0,this.Es=0,this.As=new xi,this.targetCount=0,this.Rs=ti.An()}forEachTarget(e,t){return this.Ts.forEach(((e,n)=>t(n))),te.resolve()}getLastRemoteSnapshotVersion(e){return te.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return te.resolve(this.Es)}allocateTargetId(e){return this.highestTargetId=this.Rs.next(),te.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Es&&(this.Es=t),te.resolve()}vn(e){this.Ts.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.Rs=new ti(t),this.highestTargetId=t),e.sequenceNumber>this.Es&&(this.Es=e.sequenceNumber)}addTargetData(e,t){return this.vn(t),this.targetCount+=1,te.resolve()}updateTargetData(e,t){return this.vn(t),te.resolve()}removeTargetData(e,t){return this.Ts.delete(t.target),this.As.us(t.targetId),this.targetCount-=1,te.resolve()}removeTargets(e,t,n){let s=0;const r=[];return this.Ts.forEach(((i,o)=>{o.sequenceNumber<=t&&null===n.get(o.targetId)&&(this.Ts.delete(i),r.push(this.removeMatchingKeysForTargetId(e,o.targetId)),s++)})),te.waitFor(r).next((()=>s))}getTargetCount(e){return te.resolve(this.targetCount)}getTargetData(e,t){const n=this.Ts.get(t)||null;return te.resolve(n)}addMatchingKeys(e,t,n){return this.As.ss(t,n),te.resolve()}removeMatchingKeys(e,t,n){this.As.os(t,n);const s=this.persistence.referenceDelegate,r=[];return s&&t.forEach((t=>{r.push(s.markPotentiallyOrphaned(e,t))})),te.waitFor(r)}removeMatchingKeysForTargetId(e,t){return this.As.us(t),te.resolve()}getMatchingKeysForTargetId(e,t){const n=this.As.hs(t);return te.resolve(n)}containsKey(e,t){return te.resolve(this.As.containsKey(t))}}class _i{constructor(e,t){this.bs={},this.overlays={},this.Ps=new fe(0),this.vs=!1,this.vs=!0,this.referenceDelegate=e(this),this.Vs=new ki(this),this.indexManager=new Fr,this.remoteDocumentCache=function(e){return new Ai(e)}((e=>this.referenceDelegate.Ss(e))),this.wt=new cr(t),this.Ds=new Ti(this.wt)}start(){return Promise.resolve()}shutdown(){return this.vs=!1,Promise.resolve()}get started(){return this.vs}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Si,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.bs[e.toKey()];return n||(n=new Ni(t,this.referenceDelegate),this.bs[e.toKey()]=n),n}getTargetCache(){return this.Vs}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ds}runTransaction(e,t,n){m("MemoryPersistence","Starting transaction:",e);const s=new Vi(this.Ps.next());return this.referenceDelegate.Cs(),n(s).next((e=>this.referenceDelegate.xs(s).next((()=>e)))).toPromise().then((e=>(s.raiseOnCommittedEvent(),e)))}Ns(e,t){return te.or(Object.values(this.bs).map((n=>()=>n.containsKey(e,t))))}}class Vi extends Z{constructor(e){super(),this.currentSequenceNumber=e}}class Mi{constructor(e){this.persistence=e,this.ks=new xi,this.Ms=null}static Os(e){return new Mi(e)}get Fs(){if(this.Ms)return this.Ms;throw w()}addReference(e,t,n){return this.ks.addReference(n,t),this.Fs.delete(n.toString()),te.resolve()}removeReference(e,t,n){return this.ks.removeReference(n,t),this.Fs.add(n.toString()),te.resolve()}markPotentiallyOrphaned(e,t){return this.Fs.add(t.toString()),te.resolve()}removeTarget(e,t){this.ks.us(t.targetId).forEach((e=>this.Fs.add(e.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next((e=>{e.forEach((e=>this.Fs.add(e.toString())))})).next((()=>n.removeTargetData(e,t)))}Cs(){this.Ms=new Set}xs(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return te.forEach(this.Fs,(n=>{const s=K.fromPath(n);return this.$s(e,s).next((e=>{e||t.removeEntry(s,F.min())}))})).next((()=>(this.Ms=null,t.apply(e))))}updateLimboDocument(e,t){return this.$s(e,t).next((e=>{e?this.Fs.delete(t.toString()):this.Fs.add(t.toString())}))}Ss(e){return 0}$s(e,t){return te.or([()=>te.resolve(this.ks.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ns(e,t)])}}class Ri{constructor(e){this.wt=e}M(e,t,n,s){const r=new ne("createOrUpgrade",t);n<1&&s>=1&&(function(e){e.createObjectStore("owner")}(e),function(e){e.createObjectStore("mutationQueues",{keyPath:"userId"}),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Rs,{unique:!0}),e.createObjectStore("documentMutations")}(e),Oi(e),function(e){e.createObjectStore("remoteDocuments")}(e));let i=te.resolve();return n<3&&s>=3&&(0!==n&&(function(e){e.deleteObjectStore("targetDocuments"),e.deleteObjectStore("targets"),e.deleteObjectStore("targetGlobal")}(e),Oi(e)),i=i.next((()=>function(e){const t=e.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:F.min().toTimestamp(),targetCount:0};return t.put("targetGlobalKey",n)}(r)))),n<4&&s>=4&&(0!==n&&(i=i.next((()=>function(e,t){return t.store("mutations").K().next((n=>{e.deleteObjectStore("mutations"),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Rs,{unique:!0});const s=t.store("mutations"),r=n.map((e=>s.put(e)));return te.waitFor(r)}))}(e,r)))),i=i.next((()=>{!function(e){e.createObjectStore("clientMetadata",{keyPath:"clientId"})}(e)}))),n<5&&s>=5&&(i=i.next((()=>this.Bs(r)))),n<6&&s>=6&&(i=i.next((()=>(function(e){e.createObjectStore("remoteDocumentGlobal")}(e),this.Ls(r))))),n<7&&s>=7&&(i=i.next((()=>this.Us(r)))),n<8&&s>=8&&(i=i.next((()=>this.qs(e,r)))),n<9&&s>=9&&(i=i.next((()=>{!function(e){e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")}(e)}))),n<10&&s>=10&&(i=i.next((()=>this.Ks(r)))),n<11&&s>=11&&(i=i.next((()=>{!function(e){e.createObjectStore("bundles",{keyPath:"bundleId"})}(e),function(e){e.createObjectStore("namedQueries",{keyPath:"name"})}(e)}))),n<12&&s>=12&&(i=i.next((()=>{!function(e){const t=e.createObjectStore("documentOverlays",{keyPath:Ws});t.createIndex("collectionPathOverlayIndex",Js,{unique:!1}),t.createIndex("collectionGroupOverlayIndex",Ys,{unique:!1})}(e)}))),n<13&&s>=13&&(i=i.next((()=>function(e){const t=e.createObjectStore("remoteDocumentsV14",{keyPath:Ps});t.createIndex("documentKeyIndex",Us),t.createIndex("collectionGroupIndex",Bs)}(e))).next((()=>this.Gs(e,r))).next((()=>e.deleteObjectStore("remoteDocuments")))),n<14&&s>=14&&(i=i.next((()=>this.Qs(e,r)))),n<15&&s>=15&&(i=i.next((()=>function(e){e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:zs}).createIndex("sequenceNumberIndex",js,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:Qs}).createIndex("documentKeyIndex",Hs,{unique:!1})}(e)))),i}Ls(e){let t=0;return e.store("remoteDocuments").J(((e,n)=>{t+=Wr(n)})).next((()=>{const n={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}Bs(e){const t=e.store("mutationQueues"),n=e.store("mutations");return t.K().next((t=>te.forEach(t,(t=>{const s=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.K("userMutationsIndex",s).next((n=>te.forEach(n,(n=>{v(n.userId===t.userId);const s=mr(this.wt,n);return Hr(e,t.userId,s).next((()=>{}))}))))}))))}Us(e){const t=e.store("targetDocuments"),n=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next((e=>{const s=[];return n.J(((n,r)=>{const i=new U(n),o=function(e){return[0,ks(e)]}(i);s.push(t.get(o).next((n=>n?te.resolve():(n=>t.put({targetId:0,path:ks(n),sequenceNumber:e.highestListenSequenceNumber}))(i))))})).next((()=>te.waitFor(s)))}))}qs(e,t){e.createObjectStore("collectionParents",{keyPath:$s});const n=t.store("collectionParents"),s=new Pr,r=e=>{if(s.add(e)){const t=e.lastSegment(),s=e.popLast();return n.put({collectionId:t,parent:ks(s)})}};return t.store("remoteDocuments").J({H:!0},((e,t)=>{const n=new U(e);return r(n.popLast())})).next((()=>t.store("documentMutations").J({H:!0},(([e,t,n],s)=>{const i=Ms(t);return r(i.popLast())}))))}Ks(e){const t=e.store("targets");return t.J(((e,n)=>{const s=gr(n),r=pr(this.wt,s);return t.put(r)}))}Gs(e,t){const n=t.store("remoteDocuments"),s=[];return n.J(((e,n)=>{const r=t.store("remoteDocumentsV14"),i=(o=n,o.document?new K(U.fromString(o.document.name).popFirst(5)):o.noDocument?K.fromSegments(o.noDocument.path):o.unknownDocument?K.fromSegments(o.unknownDocument.path):w()).path.toArray();var o;const a={prefixPath:i.slice(0,i.length-2),collectionGroup:i[i.length-2],documentId:i[i.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};s.push(r.put(a))})).next((()=>te.waitFor(s)))}Qs(e,t){const n=t.store("mutations"),s=mi(this.wt),r=new _i(Mi.Os,this.wt.ne);return n.K().next((e=>{const n=new Map;return e.forEach((e=>{var t;let s=null!==(t=n.get(e.userId))&&void 0!==t?t:qn();mr(this.wt,e).keys().forEach((e=>s=s.add(e))),n.set(e.userId,s)})),te.forEach(n,((e,n)=>{const i=new l(n),o=Sr.se(this.wt,i),a=r.getIndexManager(i),u=Jr.se(i,this.wt,a,r.referenceDelegate);return new bi(s,u,o,a).recalculateAndSaveOverlaysForDocumentKeys(new sr(t,fe.ot),e).next()}))}))}}function Oi(e){e.createObjectStore("targetDocuments",{keyPath:Ks}).createIndex("documentTargetsIndex",Gs,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",qs,{unique:!0}),e.createObjectStore("targetGlobal")}const Li="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class Fi{constructor(e,t,n,s,r,i,o,a,u,c,l=15){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.js=r,this.window=i,this.document=o,this.Ws=u,this.zs=c,this.Hs=l,this.Ps=null,this.vs=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Js=null,this.inForeground=!1,this.Ys=null,this.Xs=null,this.Zs=Number.NEGATIVE_INFINITY,this.ti=e=>Promise.resolve(),!Fi.V())throw new b(E.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new li(this,s),this.ei=t+"main",this.wt=new cr(a),this.ni=new se(this.ei,this.Hs,new Ri(this.wt)),this.Vs=new ni(this.referenceDelegate,this.wt),this.remoteDocumentCache=mi(this.wt),this.Ds=new Er,this.window&&this.window.localStorage?this.si=this.window.localStorage:(this.si=null,!1===c&&g("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.ii().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new b(E.FAILED_PRECONDITION,Li);return this.ri(),this.oi(),this.ui(),this.runTransaction("getHighestListenSequenceNumber","readonly",(e=>this.Vs.getHighestSequenceNumber(e)))})).then((e=>{this.Ps=new fe(e,this.Ws)})).then((()=>{this.vs=!0})).catch((e=>(this.ni&&this.ni.close(),Promise.reject(e))))}ci(e){return this.ti=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.ni.F((async t=>{null===t.newVersion&&await e()}))}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.js.enqueueAndForget((async()=>{this.started&&await this.ii()})))}ii(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(e=>Ui(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.ai(e).next((e=>{e||(this.isPrimary=!1,this.js.enqueueRetryable((()=>this.ti(!1))))}))})).next((()=>this.hi(e))).next((t=>this.isPrimary&&!t?this.li(e).next((()=>!1)):!!t&&this.fi(e).next((()=>!0)))))).catch((e=>{if(oe(e))return m("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return m("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1})).then((e=>{this.isPrimary!==e&&this.js.enqueueRetryable((()=>this.ti(e))),this.isPrimary=e}))}ai(e){return Pi(e).get("owner").next((e=>te.resolve(this.di(e))))}_i(e){return Ui(e).delete(this.clientId)}async wi(){if(this.isPrimary&&!this.mi(this.Zs,18e5)){this.Zs=Date.now();const e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(e=>{const t=rr(e,"clientMetadata");return t.K().next((e=>{const n=this.gi(e,18e5),s=e.filter((e=>-1===n.indexOf(e)));return te.forEach(s,(e=>t.delete(e.clientId))).next((()=>s))}))})).catch((()=>[]));if(this.si)for(const t of e)this.si.removeItem(this.yi(t.clientId))}}ui(){this.Xs=this.js.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.ii().then((()=>this.wi())).then((()=>this.ui()))))}di(e){return!!e&&e.ownerId===this.clientId}hi(e){return this.zs?te.resolve(!0):Pi(e).get("owner").next((t=>{if(null!==t&&this.mi(t.leaseTimestampMs,5e3)&&!this.pi(t.ownerId)){if(this.di(t)&&this.networkEnabled)return!0;if(!this.di(t)){if(!t.allowTabSynchronization)throw new b(E.FAILED_PRECONDITION,Li);return!1}}return!(!this.networkEnabled||!this.inForeground)||Ui(e).K().next((e=>void 0===this.gi(e,5e3).find((e=>{if(this.clientId!==e.clientId){const t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,s=this.networkEnabled===e.networkEnabled;if(t||n&&s)return!0}return!1}))))})).next((e=>(this.isPrimary!==e&&m("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e)))}async shutdown(){this.vs=!1,this.Ii(),this.Xs&&(this.Xs.cancel(),this.Xs=null),this.Ti(),this.Ei(),await this.ni.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(e=>{const t=new sr(e,fe.ot);return this.li(t).next((()=>this._i(t)))})),this.ni.close(),this.Ai()}gi(e,t){return e.filter((e=>this.mi(e.updateTimeMs,t)&&!this.pi(e.clientId)))}Ri(){return this.runTransaction("getActiveClients","readonly",(e=>Ui(e).K().next((e=>this.gi(e,18e5).map((e=>e.clientId))))))}get started(){return this.vs}getMutationQueue(e,t){return Jr.se(e,this.wt,t,this.referenceDelegate)}getTargetCache(){return this.Vs}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new Br(e,this.wt.ne.databaseId)}getDocumentOverlayCache(e){return Sr.se(this.wt,e)}getBundleCache(){return this.Ds}runTransaction(e,t,n){m("IndexedDbPersistence","Starting transaction:",e);const s="readonly"===t?"readonly":"readwrite",r=15===(i=this.Hs)?nr:14===i?tr:13===i?er:12===i?Zs:11===i?Xs:void w();var i;let o;return this.ni.runTransaction(e,s,r,(s=>(o=new sr(s,this.Ps?this.Ps.next():fe.ot),"readwrite-primary"===t?this.ai(o).next((e=>!!e||this.hi(o))).next((t=>{if(!t)throw g(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.js.enqueueRetryable((()=>this.ti(!1))),new b(E.FAILED_PRECONDITION,X);return n(o)})).next((e=>this.fi(o).next((()=>e)))):this.bi(o).next((()=>n(o)))))).then((e=>(o.raiseOnCommittedEvent(),e)))}bi(e){return Pi(e).get("owner").next((e=>{if(null!==e&&this.mi(e.leaseTimestampMs,5e3)&&!this.pi(e.ownerId)&&!this.di(e)&&!(this.zs||this.allowTabSynchronization&&e.allowTabSynchronization))throw new b(E.FAILED_PRECONDITION,Li)}))}fi(e){const t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Pi(e).put("owner",t)}static V(){return se.V()}li(e){const t=Pi(e);return t.get("owner").next((e=>this.di(e)?(m("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):te.resolve()))}mi(e,t){const n=Date.now();return!(e<n-t)&&(!(e>n)||(g(`Detected an update time that is in the future: ${e} > ${n}`),!1))}ri(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ys=()=>{this.js.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.ii())))},this.document.addEventListener("visibilitychange",this.Ys),this.inForeground="visible"===this.document.visibilityState)}Ti(){this.Ys&&(this.document.removeEventListener("visibilitychange",this.Ys),this.Ys=null)}oi(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.Js=()=>{this.Ii(),(0,o.G6)()&&navigator.appVersion.match(/Version\/1[45]/)&&this.js.enterRestrictedMode(!0),this.js.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.Js))}Ei(){this.Js&&(this.window.removeEventListener("pagehide",this.Js),this.Js=null)}pi(e){var t;try{const n=null!==(null===(t=this.si)||void 0===t?void 0:t.getItem(this.yi(e)));return m("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return g("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}Ii(){if(this.si)try{this.si.setItem(this.yi(this.clientId),String(Date.now()))}catch(e){g("Failed to set zombie client id.",e)}}Ai(){if(this.si)try{this.si.removeItem(this.yi(this.clientId))}catch(e){}}yi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function Pi(e){return rr(e,"owner")}function Ui(e){return rr(e,"clientMetadata")}function Bi(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class qi{constructor(e,t,n,s){this.targetId=e,this.fromCache=t,this.Pi=n,this.vi=s}static Vi(e,t){let n=qn(),s=qn();for(const r of t.docChanges)switch(r.type){case 0:n=n.add(r.doc.key);break;case 1:s=s.add(r.doc.key)}return new qi(e,t.fromCache,n,s)}}class Ki{constructor(){this.Si=!1}initialize(e,t){this.Di=e,this.indexManager=t,this.Si=!0}getDocumentsMatchingQuery(e,t,n,s){return this.Ci(e,t).next((r=>r||this.xi(e,t,s,n))).next((n=>n||this.Ni(e,t)))}Ci(e,t){if(Vt(t))return te.resolve(null);let n=Ft(t);return this.indexManager.getIndexType(e,n).next((s=>0===s?null:(null!==t.limit&&1===s&&(t=Pt(t,null,"F"),n=Ft(t)),this.indexManager.getDocumentsMatchingTarget(e,n).next((s=>{const r=qn(...s);return this.Di.getDocuments(e,r).next((s=>this.indexManager.getMinOffset(e,n).next((n=>{const i=this.ki(t,s);return this.Mi(t,i,r,n.readTime)?this.Ci(e,Pt(t,null,"F")):this.Oi(e,i,t,n)}))))})))))}xi(e,t,n,s){return Vt(t)||s.isEqual(F.min())?this.Ni(e,t):this.Di.getDocuments(e,n).next((r=>{const o=this.ki(t,r);return this.Mi(t,o,n,s)?this.Ni(e,t):(f()<=i.in.DEBUG&&m("QueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),qt(t)),this.Oi(e,o,t,H(s,-1)))}))}ki(e,t){let n=new Ie($t(e));return t.forEach(((t,s)=>{Kt(e,s)&&(n=n.add(s))})),n}Mi(e,t,n,s){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const r="F"===e.limitType?t.last():t.first();return!!r&&(r.hasPendingWrites||r.version.compareTo(s)>0)}Ni(e,t){return f()<=i.in.DEBUG&&m("QueryEngine","Using full collection scan to execute query:",qt(t)),this.Di.getDocumentsMatchingQuery(e,t,J.min())}Oi(e,t,n,s){return this.Di.getDocumentsMatchingQuery(e,n,s).next((e=>(t.forEach((t=>{e=e.insert(t.key,t)})),e)))}}class Gi{constructor(e,t,n,s){this.persistence=e,this.Fi=t,this.wt=s,this.$i=new ye(M),this.Bi=new kn((e=>ct(e)),lt),this.Li=new Map,this.Ui=e.getRemoteDocumentCache(),this.Vs=e.getTargetCache(),this.Ds=e.getBundleCache(),this.qi(n)}qi(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new bi(this.Ui,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Ui.setIndexManager(this.indexManager),this.Fi.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(t=>e.collect(t,this.$i)))}}function $i(e,t,n,s){return new Gi(e,t,n,s)}async function zi(e,t){const n=I(e);return await n.persistence.runTransaction("Handle user change","readonly",(e=>{let s;return n.mutationQueue.getAllMutationBatches(e).next((r=>(s=r,n.qi(t),n.mutationQueue.getAllMutationBatches(e)))).next((t=>{const r=[],i=[];let o=qn();for(const e of s){r.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}for(const e of t){i.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}return n.localDocuments.getDocuments(e,o).next((e=>({Ki:e,removedBatchIds:r,addedBatchIds:i})))}))}))}function ji(e){const t=I(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",(e=>t.Vs.getLastRemoteSnapshotVersion(e)))}function Qi(e,t,n){let s=qn(),r=qn();return n.forEach((e=>s=s.add(e))),t.getEntries(e,s).next((e=>{let s=Vn();return n.forEach(((n,i)=>{const o=e.get(n);i.isFoundDocument()!==o.isFoundDocument()&&(r=r.add(n)),i.isNoDocument()&&i.version.isEqual(F.min())?(t.removeEntry(n,i.readTime),s=s.insert(n,i)):!o.isValidDocument()||i.version.compareTo(o.version)>0||0===i.version.compareTo(o.version)&&o.hasPendingWrites?(t.addEntry(i),s=s.insert(n,i)):m("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",i.version)})),{Gi:s,Qi:r}}))}function Hi(e,t){const n=I(e);return n.persistence.runTransaction("Get next mutation batch","readonly",(e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t))))}function Wi(e,t){const n=I(e);return n.persistence.runTransaction("Allocate target","readwrite",(e=>{let s;return n.Vs.getTargetData(e,t).next((r=>r?(s=r,te.resolve(s)):n.Vs.allocateTargetId(e).next((r=>(s=new ur(t,r,0,e.currentSequenceNumber),n.Vs.addTargetData(e,s).next((()=>s)))))))})).then((e=>{const s=n.$i.get(e.targetId);return(null===s||e.snapshotVersion.compareTo(s.snapshotVersion)>0)&&(n.$i=n.$i.insert(e.targetId,e),n.Bi.set(t,e.targetId)),e}))}async function Ji(e,t,n){const s=I(e),r=s.$i.get(t),i=n?"readwrite":"readwrite-primary";try{n||await s.persistence.runTransaction("Release target",i,(e=>s.persistence.referenceDelegate.removeTarget(e,r)))}catch(e){if(!oe(e))throw e;m("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}s.$i=s.$i.remove(t),s.Bi.delete(r.target)}function Yi(e,t,n){const s=I(e);let r=F.min(),i=qn();return s.persistence.runTransaction("Execute query","readonly",(e=>function(e,t,n){const s=I(e),r=s.Bi.get(n);return void 0!==r?te.resolve(s.$i.get(r)):s.Vs.getTargetData(t,n)}(s,e,Ft(t)).next((t=>{if(t)return r=t.lastLimboFreeSnapshotVersion,s.Vs.getMatchingKeysForTargetId(e,t.targetId).next((e=>{i=e}))})).next((()=>s.Fi.getDocumentsMatchingQuery(e,t,n?r:F.min(),n?i:qn()))).next((e=>(eo(s,Gt(t),e),{documents:e,ji:i})))))}function Xi(e,t){const n=I(e),s=I(n.Vs),r=n.$i.get(t);return r?Promise.resolve(r.target):n.persistence.runTransaction("Get target data","readonly",(e=>s.te(e,t).next((e=>e?e.target:null))))}function Zi(e,t){const n=I(e),s=n.Li.get(t)||F.min();return n.persistence.runTransaction("Get new document changes","readonly",(e=>n.Ui.getAllFromCollectionGroup(e,t,H(s,-1),Number.MAX_SAFE_INTEGER))).then((e=>(eo(n,t,e),e)))}function eo(e,t,n){let s=F.min();n.forEach(((e,t)=>{t.readTime.compareTo(s)>0&&(s=t.readTime)})),e.Li.set(t,s)}function to(e,t){return`firestore_clients_${e}_${t}`}function no(e,t,n){let s=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(s+=`_${t.uid}`),s}function so(e,t){return`firestore_targets_${e}_${t}`}class ro{constructor(e,t,n,s){this.user=e,this.batchId=t,this.state=n,this.error=s}static Ji(e,t,n){const s=JSON.parse(n);let r,i="object"==typeof s&&-1!==["pending","acknowledged","rejected"].indexOf(s.state)&&(void 0===s.error||"object"==typeof s.error);return i&&s.error&&(i="string"==typeof s.error.message&&"string"==typeof s.error.code,i&&(r=new b(s.error.code,s.error.message))),i?new ro(e,t,s.state,r):(g("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}Yi(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class io{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Ji(e,t){const n=JSON.parse(t);let s,r="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return r&&n.error&&(r="string"==typeof n.error.message&&"string"==typeof n.error.code,r&&(s=new b(n.error.code,n.error.message))),r?new io(e,n.state,s):(g("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}Yi(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class oo{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Ji(e,t){const n=JSON.parse(t);let s="object"==typeof n&&n.activeTargetIds instanceof Array,r=Gn();for(let i=0;s&&i<n.activeTargetIds.length;++i)s=Le(n.activeTargetIds[i]),r=r.add(n.activeTargetIds[i]);return s?new oo(e,r):(g("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class ao{constructor(e,t){this.clientId=e,this.onlineState=t}static Ji(e){const t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new ao(t.clientId,t.onlineState):(g("SharedClientState",`Failed to parse online state: ${e}`),null)}}class uo{constructor(){this.activeTargetIds=Gn()}Xi(e){this.activeTargetIds=this.activeTargetIds.add(e)}Zi(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Yi(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class co{constructor(e,t,n,s,r){this.window=e,this.js=t,this.persistenceKey=n,this.tr=s,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.er=this.nr.bind(this),this.sr=new ye(M),this.started=!1,this.ir=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=r,this.rr=to(this.persistenceKey,this.tr),this.ur=function(e){return`firestore_sequence_number_${e}`}(this.persistenceKey),this.sr=this.sr.insert(this.tr,new uo),this.cr=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.ar=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.hr=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.lr=function(e){return`firestore_online_state_${e}`}(this.persistenceKey),this.dr=function(e){return`firestore_bundle_loaded_v2_${e}`}(this.persistenceKey),this.window.addEventListener("storage",this.er)}static V(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.Ri();for(const n of e){if(n===this.tr)continue;const e=this.getItem(to(this.persistenceKey,n));if(e){const t=oo.Ji(n,e);t&&(this.sr=this.sr.insert(t.clientId,t))}}this._r();const t=this.storage.getItem(this.lr);if(t){const e=this.wr(t);e&&this.mr(e)}for(const n of this.ir)this.nr(n);this.ir=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(e){this.setItem(this.ur,JSON.stringify(e))}getAllActiveQueryTargets(){return this.gr(this.sr)}isActiveQueryTarget(e){let t=!1;return this.sr.forEach(((n,s)=>{s.activeTargetIds.has(e)&&(t=!0)})),t}addPendingMutation(e){this.yr(e,"pending")}updateMutationState(e,t,n){this.yr(e,t,n),this.pr(e)}addLocalQueryTarget(e){let t="not-current";if(this.isActiveQueryTarget(e)){const n=this.storage.getItem(so(this.persistenceKey,e));if(n){const s=io.Ji(e,n);s&&(t=s.state)}}return this.Ir.Xi(e),this._r(),t}removeLocalQueryTarget(e){this.Ir.Zi(e),this._r()}isLocalQueryTarget(e){return this.Ir.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(so(this.persistenceKey,e))}updateQueryState(e,t,n){this.Tr(e,t,n)}handleUserChange(e,t,n){t.forEach((e=>{this.pr(e)})),this.currentUser=e,n.forEach((e=>{this.addPendingMutation(e)}))}setOnlineState(e){this.Er(e)}notifyBundleLoaded(e){this.Ar(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.er),this.removeItem(this.rr),this.started=!1)}getItem(e){const t=this.storage.getItem(e);return m("SharedClientState","READ",e,t),t}setItem(e,t){m("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){m("SharedClientState","REMOVE",e),this.storage.removeItem(e)}nr(e){const t=e;if(t.storageArea===this.storage){if(m("SharedClientState","EVENT",t.key,t.newValue),t.key===this.rr)return void g("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.js.enqueueRetryable((async()=>{if(this.started){if(null!==t.key)if(this.cr.test(t.key)){if(null==t.newValue){const e=this.Rr(t.key);return this.br(e,null)}{const e=this.Pr(t.key,t.newValue);if(e)return this.br(e.clientId,e)}}else if(this.ar.test(t.key)){if(null!==t.newValue){const e=this.vr(t.key,t.newValue);if(e)return this.Vr(e)}}else if(this.hr.test(t.key)){if(null!==t.newValue){const e=this.Sr(t.key,t.newValue);if(e)return this.Dr(e)}}else if(t.key===this.lr){if(null!==t.newValue){const e=this.wr(t.newValue);if(e)return this.mr(e)}}else if(t.key===this.ur){const e=function(e){let t=fe.ot;if(null!=e)try{const n=JSON.parse(e);v("number"==typeof n),t=n}catch(e){g("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(t.newValue);e!==fe.ot&&this.sequenceNumberHandler(e)}else if(t.key===this.dr){const e=this.Cr(t.newValue);await Promise.all(e.map((e=>this.syncEngine.Nr(e))))}}else this.ir.push(t)}))}}get Ir(){return this.sr.get(this.tr)}_r(){this.setItem(this.rr,this.Ir.Yi())}yr(e,t,n){const s=new ro(this.currentUser,e,t,n),r=no(this.persistenceKey,this.currentUser,e);this.setItem(r,s.Yi())}pr(e){const t=no(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Er(e){const t={clientId:this.tr,onlineState:e};this.storage.setItem(this.lr,JSON.stringify(t))}Tr(e,t,n){const s=so(this.persistenceKey,e),r=new io(e,t,n);this.setItem(s,r.Yi())}Ar(e){const t=JSON.stringify(Array.from(e));this.setItem(this.dr,t)}Rr(e){const t=this.cr.exec(e);return t?t[1]:null}Pr(e,t){const n=this.Rr(e);return oo.Ji(n,t)}vr(e,t){const n=this.ar.exec(e),s=Number(n[1]),r=void 0!==n[2]?n[2]:null;return ro.Ji(new l(r),s,t)}Sr(e,t){const n=this.hr.exec(e),s=Number(n[1]);return io.Ji(s,t)}wr(e){return ao.Ji(e)}Cr(e){return JSON.parse(e)}async Vr(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.kr(e.batchId,e.state,e.error);m("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}Dr(e){return this.syncEngine.Mr(e.targetId,e.state,e.error)}br(e,t){const n=t?this.sr.insert(e,t):this.sr.remove(e),s=this.gr(this.sr),r=this.gr(n),i=[],o=[];return r.forEach((e=>{s.has(e)||i.push(e)})),s.forEach((e=>{r.has(e)||o.push(e)})),this.syncEngine.Or(i,o).then((()=>{this.sr=n}))}mr(e){this.sr.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}gr(e){let t=Gn();return e.forEach(((e,n)=>{t=t.unionWith(n.activeTargetIds)})),t}}class lo{constructor(){this.Fr=new uo,this.$r={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.Fr.Xi(e),this.$r[e]||"not-current"}updateQueryState(e,t,n){this.$r[e]=t}removeLocalQueryTarget(e){this.Fr.Zi(e)}isLocalQueryTarget(e){return this.Fr.activeTargetIds.has(e)}clearQueryState(e){delete this.$r[e]}getAllActiveQueryTargets(){return this.Fr.activeTargetIds}isActiveQueryTarget(e){return this.Fr.activeTargetIds.has(e)}start(){return this.Fr=new uo,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class ho{Br(e){}shutdown(){}}class fo{constructor(){this.Lr=()=>this.Ur(),this.qr=()=>this.Kr(),this.Gr=[],this.Qr()}Br(e){this.Gr.push(e)}shutdown(){window.removeEventListener("online",this.Lr),window.removeEventListener("offline",this.qr)}Qr(){window.addEventListener("online",this.Lr),window.addEventListener("offline",this.qr)}Ur(){m("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.Gr)e(0)}Kr(){m("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.Gr)e(1)}static V(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const mo={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};class go{constructor(e){this.jr=e.jr,this.Wr=e.Wr}zr(e){this.Hr=e}Jr(e){this.Yr=e}onMessage(e){this.Xr=e}close(){this.Wr()}send(e){this.jr(e)}Zr(){this.Hr()}eo(e){this.Yr(e)}no(e){this.Xr(e)}}class po extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;const t=e.ssl?"https":"http";this.so=t+"://"+e.host,this.io="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}ro(e,t,n,s,r){const i=this.oo(e,t);m("RestConnection","Sending: ",i,n);const o={};return this.uo(o,s,r),this.co(e,i,o,n).then((e=>(m("RestConnection","Received: ",e),e)),(t=>{throw p("RestConnection",`${e} failed with error: `,t,"url: ",i,"request:",n),t}))}ao(e,t,n,s,r,i){return this.ro(e,t,n,s,r)}uo(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+h,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach(((t,n)=>e[n]=t)),n&&n.headers.forEach(((t,n)=>e[n]=t))}oo(e,t){const n=mo[e];return`${this.so}/v1/${t}:${n}`}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams}co(e,t,n,s){return new Promise(((r,i)=>{const o=new a.JJ;o.listenOnce(a.tw.COMPLETE,(()=>{try{switch(o.getLastErrorCode()){case a.jK.NO_ERROR:const t=o.getResponseJson();m("Connection","XHR received:",JSON.stringify(t)),r(t);break;case a.jK.TIMEOUT:m("Connection",'RPC "'+e+'" timed out'),i(new b(E.DEADLINE_EXCEEDED,"Request time out"));break;case a.jK.HTTP_ERROR:const n=o.getStatus();if(m("Connection",'RPC "'+e+'" failed with status:',n,"response text:",o.getResponseText()),n>0){const e=o.getResponseJson().error;if(e&&e.status&&e.message){const t=function(e){const t=e.toLowerCase().replace(/_/g,"-");return Object.values(E).indexOf(t)>=0?t:E.UNKNOWN}(e.status);i(new b(t,e.message))}else i(new b(E.UNKNOWN,"Server responded with status "+o.getStatus()))}else i(new b(E.UNAVAILABLE,"Connection failed."));break;default:w()}}finally{m("Connection",'RPC "'+e+'" completed.')}}));const u=JSON.stringify(s);o.send(t,"POST",u,n,15)}))}ho(e,t,n){const s=[this.so,"/","google.firestore.v1.Firestore","/",e,"/channel"],r=(0,a.UE)(),i=(0,a.FJ)(),u={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(u.xmlHttpFactory=new a.zI({})),this.uo(u.initMessageHeaders,t,n),(0,o.uI)()||(0,o.b$)()||(0,o.d)()||(0,o.w1)()||(0,o.Mn)()||(0,o.ru)()||(u.httpHeadersOverwriteParam="$httpHeaders");const c=s.join("");m("Connection","Creating WebChannel: "+c,u);const l=r.createWebChannel(c,u);let h=!1,d=!1;const f=new go({jr:e=>{d?m("Connection","Not sending because WebChannel is closed:",e):(h||(m("Connection","Opening WebChannel transport."),l.open(),h=!0),m("Connection","WebChannel sending:",e),l.send(e))},Wr:()=>l.close()}),g=(e,t,n)=>{e.listen(t,(e=>{try{n(e)}catch(e){setTimeout((()=>{throw e}),0)}}))};return g(l,a.ii.EventType.OPEN,(()=>{d||m("Connection","WebChannel transport opened.")})),g(l,a.ii.EventType.CLOSE,(()=>{d||(d=!0,m("Connection","WebChannel transport closed"),f.eo())})),g(l,a.ii.EventType.ERROR,(e=>{d||(d=!0,p("Connection","WebChannel transport errored:",e),f.eo(new b(E.UNAVAILABLE,"The operation could not be completed")))})),g(l,a.ii.EventType.MESSAGE,(e=>{var t;if(!d){const n=e.data[0];v(!!n);const s=n,r=s.error||(null===(t=s[0])||void 0===t?void 0:t.error);if(r){m("Connection","WebChannel received error:",r);const e=r.status;let t=function(e){const t=Dn[e];if(void 0!==t)return Cn(t)}(e),n=r.message;void 0===t&&(t=E.INTERNAL,n="Unknown error status: "+e+" with message "+r.message),d=!0,f.eo(new b(t,n)),l.close()}else m("Connection","WebChannel received:",n),f.no(n)}})),g(i,a.ju.STAT_EVENT,(e=>{e.stat===a.kN.PROXY?m("Connection","Detected buffering proxy"):e.stat===a.kN.NOPROXY&&m("Connection","Detected no buffering proxy")})),setTimeout((()=>{f.Zr()}),0),f}}function yo(){return"undefined"!=typeof window?window:null}function wo(){return"undefined"!=typeof document?document:null}function vo(e){return new ts(e,!0)}class Io{constructor(e,t,n=1e3,s=1.5,r=6e4){this.js=e,this.timerId=t,this.lo=n,this.fo=s,this._o=r,this.wo=0,this.mo=null,this.yo=Date.now(),this.reset()}reset(){this.wo=0}po(){this.wo=this._o}Io(e){this.cancel();const t=Math.floor(this.wo+this.To()),n=Math.max(0,Date.now()-this.yo),s=Math.max(0,t-n);s>0&&m("ExponentialBackoff",`Backing off for ${s} ms (base delay: ${this.wo} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.mo=this.js.enqueueAfterDelay(this.timerId,s,(()=>(this.yo=Date.now(),e()))),this.wo*=this.fo,this.wo<this.lo&&(this.wo=this.lo),this.wo>this._o&&(this.wo=this._o)}Eo(){null!==this.mo&&(this.mo.skipDelay(),this.mo=null)}cancel(){null!==this.mo&&(this.mo.cancel(),this.mo=null)}To(){return(Math.random()-.5)*this.wo}}class Eo{constructor(e,t,n,s,r,i,o,a){this.js=e,this.Ao=n,this.Ro=s,this.bo=r,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.Po=0,this.vo=null,this.Vo=null,this.stream=null,this.So=new Io(e,t)}Do(){return 1===this.state||5===this.state||this.Co()}Co(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.xo()}async stop(){this.Do()&&await this.close(0)}No(){this.state=0,this.So.reset()}ko(){this.Co()&&null===this.vo&&(this.vo=this.js.enqueueAfterDelay(this.Ao,6e4,(()=>this.Mo())))}Oo(e){this.Fo(),this.stream.send(e)}async Mo(){if(this.Co())return this.close(0)}Fo(){this.vo&&(this.vo.cancel(),this.vo=null)}$o(){this.Vo&&(this.Vo.cancel(),this.Vo=null)}async close(e,t){this.Fo(),this.$o(),this.So.cancel(),this.Po++,4!==e?this.So.reset():t&&t.code===E.RESOURCE_EXHAUSTED?(g(t.toString()),g("Using maximum backoff delay to prevent overloading the backend."),this.So.po()):t&&t.code===E.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Bo(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Jr(t)}Bo(){}auth(){this.state=1;const e=this.Lo(this.Po),t=this.Po;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([e,n])=>{this.Po===t&&this.Uo(e,n)}),(t=>{e((()=>{const e=new b(E.UNKNOWN,"Fetching auth token failed: "+t.message);return this.qo(e)}))}))}Uo(e,t){const n=this.Lo(this.Po);this.stream=this.Ko(e,t),this.stream.zr((()=>{n((()=>(this.state=2,this.Vo=this.js.enqueueAfterDelay(this.Ro,1e4,(()=>(this.Co()&&(this.state=3),Promise.resolve()))),this.listener.zr())))})),this.stream.Jr((e=>{n((()=>this.qo(e)))})),this.stream.onMessage((e=>{n((()=>this.onMessage(e)))}))}xo(){this.state=5,this.So.Io((async()=>{this.state=0,this.start()}))}qo(e){return m("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}Lo(e){return t=>{this.js.enqueueAndForget((()=>this.Po===e?t():(m("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class bo extends Eo{constructor(e,t,n,s,r,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,s,i),this.wt=r}Ko(e,t){return this.bo.ho("Listen",e,t)}onMessage(e){this.So.reset();const t=function(e,t){let n;if("targetChange"in t){t.targetChange;const s=function(e){return"NO_CHANGE"===e?0:"ADD"===e?1:"REMOVE"===e?2:"CURRENT"===e?3:"RESET"===e?4:w()}(t.targetChange.targetChangeType||"NO_CHANGE"),r=t.targetChange.targetIds||[],i=function(e,t){return e.dt?(v(void 0===t||"string"==typeof t),Se.fromBase64String(t||"")):(v(void 0===t||t instanceof Uint8Array),Se.fromUint8Array(t||new Uint8Array))}(e,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(e){const t=void 0===e.code?E.UNKNOWN:Cn(e.code);return new b(t,e.message||"")}(o);n=new Hn(s,r,i,a||null)}else if("documentChange"in t){t.documentChange;const s=t.documentChange;s.document,s.document.name,s.document.updateTime;const r=cs(e,s.document.name),i=is(s.document.updateTime),o=new rt({mapValue:{fields:s.document.fields}}),a=ot.newFoundDocument(r,i,o),u=s.targetIds||[],c=s.removedTargetIds||[];n=new jn(u,c,a.key,a)}else if("documentDelete"in t){t.documentDelete;const s=t.documentDelete;s.document;const r=cs(e,s.document),i=s.readTime?is(s.readTime):F.min(),o=ot.newNoDocument(r,i),a=s.removedTargetIds||[];n=new jn([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const s=t.documentRemove;s.document;const r=cs(e,s.document),i=s.removedTargetIds||[];n=new jn([],i,r,null)}else{if(!("filter"in t))return w();{t.filter;const e=t.filter;e.targetId;const s=e.count||0,r=new xn(s),i=e.targetId;n=new Qn(i,r)}}return n}(this.wt,e),n=function(e){if(!("targetChange"in e))return F.min();const t=e.targetChange;return t.targetIds&&t.targetIds.length?F.min():t.readTime?is(t.readTime):F.min()}(e);return this.listener.Go(t,n)}Qo(e){const t={};t.database=ds(this.wt),t.addTarget=function(e,t){let n;const s=t.target;return n=ht(s)?{documents:ws(e,s)}:{query:vs(e,s)},n.targetId=t.targetId,t.resumeToken.approximateByteSize()>0?n.resumeToken=ss(e,t.resumeToken):t.snapshotVersion.compareTo(F.min())>0&&(n.readTime=ns(e,t.snapshotVersion.toTimestamp())),n}(this.wt,e);const n=function(e,t){const n=function(e,t){switch(t){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return w()}}(0,t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.wt,e);n&&(t.labels=n),this.Oo(t)}jo(e){const t={};t.database=ds(this.wt),t.removeTarget=e,this.Oo(t)}}class To extends Eo{constructor(e,t,n,s,r,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,s,i),this.wt=r,this.Wo=!1}get zo(){return this.Wo}start(){this.Wo=!1,this.lastStreamToken=void 0,super.start()}Bo(){this.Wo&&this.Ho([])}Ko(e,t){return this.bo.ho("Write",e,t)}onMessage(e){if(v(!!e.streamToken),this.lastStreamToken=e.streamToken,this.Wo){this.So.reset();const t=function(e,t){return e&&e.length>0?(v(void 0!==t),e.map((e=>function(e,t){let n=e.updateTime?is(e.updateTime):is(t);return n.isEqual(F.min())&&(n=is(t)),new cn(n,e.transformResults||[])}(e,t)))):[]}(e.writeResults,e.commitTime),n=is(e.commitTime);return this.listener.Jo(n,t)}return v(!e.writeResults||0===e.writeResults.length),this.Wo=!0,this.listener.Yo()}Xo(){const e={};e.database=ds(this.wt),this.Oo(e)}Ho(e){const t={streamToken:this.lastStreamToken,writes:e.map((e=>ps(this.wt,e)))};this.Oo(t)}}class So extends class{}{constructor(e,t,n,s){super(),this.authCredentials=e,this.appCheckCredentials=t,this.bo=n,this.wt=s,this.Zo=!1}tu(){if(this.Zo)throw new b(E.FAILED_PRECONDITION,"The client has already been terminated.")}ro(e,t,n){return this.tu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,r])=>this.bo.ro(e,t,n,s,r))).catch((e=>{throw"FirebaseError"===e.name?(e.code===E.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new b(E.UNKNOWN,e.toString())}))}ao(e,t,n,s){return this.tu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([r,i])=>this.bo.ao(e,t,n,r,i,s))).catch((e=>{throw"FirebaseError"===e.name?(e.code===E.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new b(E.UNKNOWN,e.toString())}))}terminate(){this.Zo=!0}}class xo{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.eu=0,this.nu=null,this.su=!0}iu(){0===this.eu&&(this.ru("Unknown"),this.nu=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.nu=null,this.ou("Backend didn't respond within 10 seconds."),this.ru("Offline"),Promise.resolve()))))}uu(e){"Online"===this.state?this.ru("Unknown"):(this.eu++,this.eu>=1&&(this.cu(),this.ou(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.ru("Offline")))}set(e){this.cu(),this.eu=0,"Online"===e&&(this.su=!1),this.ru(e)}ru(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}ou(e){const t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.su?(g(t),this.su=!1):m("OnlineStateTracker",t)}cu(){null!==this.nu&&(this.nu.cancel(),this.nu=null)}}class Do{constructor(e,t,n,s,r){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.au=[],this.hu=new Map,this.lu=new Set,this.fu=[],this.du=r,this.du.Br((e=>{n.enqueueAndForget((async()=>{Oo(this)&&(m("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=I(e);t.lu.add(4),await Ao(t),t._u.set("Unknown"),t.lu.delete(4),await No(t)}(this))}))})),this._u=new xo(n,s)}}async function No(e){if(Oo(e))for(const t of e.fu)await t(!0)}async function Ao(e){for(const t of e.fu)await t(!1)}function Co(e,t){const n=I(e);n.hu.has(t.targetId)||(n.hu.set(t.targetId,t),Ro(n)?Mo(n):Zo(n).Co()&&_o(n,t))}function ko(e,t){const n=I(e),s=Zo(n);n.hu.delete(t),s.Co()&&Vo(n,t),0===n.hu.size&&(s.Co()?s.ko():Oo(n)&&n._u.set("Unknown"))}function _o(e,t){e.wu.Nt(t.targetId),Zo(e).Qo(t)}function Vo(e,t){e.wu.Nt(t),Zo(e).jo(t)}function Mo(e){e.wu=new Jn({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),te:t=>e.hu.get(t)||null}),Zo(e).start(),e._u.iu()}function Ro(e){return Oo(e)&&!Zo(e).Do()&&e.hu.size>0}function Oo(e){return 0===I(e).lu.size}function Lo(e){e.wu=void 0}async function Fo(e){e.hu.forEach(((t,n)=>{_o(e,t)}))}async function Po(e,t){Lo(e),Ro(e)?(e._u.uu(t),Mo(e)):e._u.set("Unknown")}async function Uo(e,t,n){if(e._u.set("Online"),t instanceof Hn&&2===t.state&&t.cause)try{await async function(e,t){const n=t.cause;for(const s of t.targetIds)e.hu.has(s)&&(await e.remoteSyncer.rejectListen(s,n),e.hu.delete(s),e.wu.removeTarget(s))}(e,t)}catch(n){m("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await Bo(e,n)}else if(t instanceof jn?e.wu.Ut(t):t instanceof Qn?e.wu.zt(t):e.wu.Gt(t),!n.isEqual(F.min()))try{const t=await ji(e.localStore);n.compareTo(t)>=0&&await function(e,t){const n=e.wu.Yt(t);return n.targetChanges.forEach(((n,s)=>{if(n.resumeToken.approximateByteSize()>0){const r=e.hu.get(s);r&&e.hu.set(s,r.withResumeToken(n.resumeToken,t))}})),n.targetMismatches.forEach((t=>{const n=e.hu.get(t);if(!n)return;e.hu.set(t,n.withResumeToken(Se.EMPTY_BYTE_STRING,n.snapshotVersion)),Vo(e,t);const s=new ur(n.target,t,1,n.sequenceNumber);_o(e,s)})),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){m("RemoteStore","Failed to raise snapshot:",t),await Bo(e,t)}}async function Bo(e,t,n){if(!oe(t))throw t;e.lu.add(1),await Ao(e),e._u.set("Offline"),n||(n=()=>ji(e.localStore)),e.asyncQueue.enqueueRetryable((async()=>{m("RemoteStore","Retrying IndexedDB access"),await n(),e.lu.delete(1),await No(e)}))}function qo(e,t){return t().catch((n=>Bo(e,n,t)))}async function Ko(e){const t=I(e),n=ea(t);let s=t.au.length>0?t.au[t.au.length-1].batchId:-1;for(;Go(t);)try{const e=await Hi(t.localStore,s);if(null===e){0===t.au.length&&n.ko();break}s=e.batchId,$o(t,e)}catch(e){await Bo(t,e)}zo(t)&&jo(t)}function Go(e){return Oo(e)&&e.au.length<10}function $o(e,t){e.au.push(t);const n=ea(e);n.Co()&&n.zo&&n.Ho(t.mutations)}function zo(e){return Oo(e)&&!ea(e).Do()&&e.au.length>0}function jo(e){ea(e).start()}async function Qo(e){ea(e).Xo()}async function Ho(e){const t=ea(e);for(const n of e.au)t.Ho(n.mutations)}async function Wo(e,t,n){const s=e.au.shift(),r=or.from(s,t,n);await qo(e,(()=>e.remoteSyncer.applySuccessfulWrite(r))),await Ko(e)}async function Jo(e,t){t&&ea(e).zo&&await async function(e,t){if(An(n=t.code)&&n!==E.ABORTED){const n=e.au.shift();ea(e).No(),await qo(e,(()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t))),await Ko(e)}var n}(e,t),zo(e)&&jo(e)}async function Yo(e,t){const n=I(e);n.asyncQueue.verifyOperationInProgress(),m("RemoteStore","RemoteStore received new credentials");const s=Oo(n);n.lu.add(3),await Ao(n),s&&n._u.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.lu.delete(3),await No(n)}async function Xo(e,t){const n=I(e);t?(n.lu.delete(2),await No(n)):t||(n.lu.add(2),await Ao(n),n._u.set("Unknown"))}function Zo(e){return e.mu||(e.mu=function(e,t,n){const s=I(e);return s.tu(),new bo(t,s.bo,s.authCredentials,s.appCheckCredentials,s.wt,n)}(e.datastore,e.asyncQueue,{zr:Fo.bind(null,e),Jr:Po.bind(null,e),Go:Uo.bind(null,e)}),e.fu.push((async t=>{t?(e.mu.No(),Ro(e)?Mo(e):e._u.set("Unknown")):(await e.mu.stop(),Lo(e))}))),e.mu}function ea(e){return e.gu||(e.gu=function(e,t,n){const s=I(e);return s.tu(),new To(t,s.bo,s.authCredentials,s.appCheckCredentials,s.wt,n)}(e.datastore,e.asyncQueue,{zr:Qo.bind(null,e),Jr:Jo.bind(null,e),Yo:Ho.bind(null,e),Jo:Wo.bind(null,e)}),e.fu.push((async t=>{t?(e.gu.No(),await Ko(e)):(await e.gu.stop(),e.au.length>0&&(m("RemoteStore",`Stopping write stream with ${e.au.length} pending writes`),e.au=[]))}))),e.gu}class ta{constructor(e,t,n,s,r){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=s,this.removalCallback=r,this.deferred=new T,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((e=>{}))}static createAndSchedule(e,t,n,s,r){const i=Date.now()+n,o=new ta(e,t,i,s,r);return o.start(n),o}start(e){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new b(E.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((e=>this.deferred.resolve(e)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function na(e,t){if(g("AsyncQueue",`${t}: ${e}`),oe(e))return new b(E.UNAVAILABLE,`${t}: ${e}`);throw e}class sa{constructor(e){this.comparator=e?(t,n)=>e(t,n)||K.comparator(t.key,n.key):(e,t)=>K.comparator(e.key,t.key),this.keyedMap=Rn(),this.sortedSet=new ye(this.comparator)}static emptySet(e){return new sa(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal(((t,n)=>(e(t),!1)))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof sa))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,s=n.getNext().key;if(!e.isEqual(s))return!1}return!0}toString(){const e=[];return this.forEach((t=>{e.push(t.toString())})),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new sa;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class ra{constructor(){this.yu=new ye(K.comparator)}track(e){const t=e.doc.key,n=this.yu.get(t);n?0!==e.type&&3===n.type?this.yu=this.yu.insert(t,e):3===e.type&&1!==n.type?this.yu=this.yu.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.yu=this.yu.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.yu=this.yu.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.yu=this.yu.remove(t):1===e.type&&2===n.type?this.yu=this.yu.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.yu=this.yu.insert(t,{type:2,doc:e.doc}):w():this.yu=this.yu.insert(t,e)}pu(){const e=[];return this.yu.inorderTraversal(((t,n)=>{e.push(n)})),e}}class ia{constructor(e,t,n,s,r,i,o,a){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=s,this.mutatedKeys=r,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a}static fromInitialDocuments(e,t,n,s){const r=[];return t.forEach((e=>{r.push({type:0,doc:e})})),new ia(e,t,sa.emptySet(t),r,n,s,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Ut(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let s=0;s<t.length;s++)if(t[s].type!==n[s].type||!t[s].doc.isEqual(n[s].doc))return!1;return!0}}class oa{constructor(){this.Iu=void 0,this.listeners=[]}}class aa{constructor(){this.queries=new kn((e=>Bt(e)),Ut),this.onlineState="Unknown",this.Tu=new Set}}async function ua(e,t){const n=I(e),s=t.query;let r=!1,i=n.queries.get(s);if(i||(r=!0,i=new oa),r)try{i.Iu=await n.onListen(s)}catch(e){const n=na(e,`Initialization of query '${qt(t.query)}' failed`);return void t.onError(n)}n.queries.set(s,i),i.listeners.push(t),t.Eu(n.onlineState),i.Iu&&t.Au(i.Iu)&&da(n)}async function ca(e,t){const n=I(e),s=t.query;let r=!1;const i=n.queries.get(s);if(i){const e=i.listeners.indexOf(t);e>=0&&(i.listeners.splice(e,1),r=0===i.listeners.length)}if(r)return n.queries.delete(s),n.onUnlisten(s)}function la(e,t){const n=I(e);let s=!1;for(const r of t){const e=r.query,t=n.queries.get(e);if(t){for(const e of t.listeners)e.Au(r)&&(s=!0);t.Iu=r}}s&&da(n)}function ha(e,t,n){const s=I(e),r=s.queries.get(t);if(r)for(const i of r.listeners)i.onError(n);s.queries.delete(t)}function da(e){e.Tu.forEach((e=>{e.next()}))}class fa{constructor(e,t,n){this.query=e,this.Ru=t,this.bu=!1,this.Pu=null,this.onlineState="Unknown",this.options=n||{}}Au(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new ia(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0)}let t=!1;return this.bu?this.vu(e)&&(this.Ru.next(e),t=!0):this.Vu(e,this.onlineState)&&(this.Su(e),t=!0),this.Pu=e,t}onError(e){this.Ru.error(e)}Eu(e){this.onlineState=e;let t=!1;return this.Pu&&!this.bu&&this.Vu(this.Pu,e)&&(this.Su(this.Pu),t=!0),t}Vu(e,t){if(!e.fromCache)return!0;const n="Offline"!==t;return(!this.options.Du||!n)&&(!e.docs.isEmpty()||"Offline"===t)}vu(e){if(e.docChanges.length>0)return!0;const t=this.Pu&&this.Pu.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}Su(e){e=ia.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache),this.bu=!0,this.Ru.next(e)}}class ma{constructor(e){this.key=e}}class ga{constructor(e){this.key=e}}class pa{constructor(e,t){this.query=e,this.Fu=t,this.$u=null,this.current=!1,this.Bu=qn(),this.mutatedKeys=qn(),this.Lu=$t(e),this.Uu=new sa(this.Lu)}get qu(){return this.Fu}Ku(e,t){const n=t?t.Gu:new ra,s=t?t.Uu:this.Uu;let r=t?t.mutatedKeys:this.mutatedKeys,i=s,o=!1;const a="F"===this.query.limitType&&s.size===this.query.limit?s.last():null,u="L"===this.query.limitType&&s.size===this.query.limit?s.first():null;if(e.inorderTraversal(((e,t)=>{const c=s.get(e),l=Kt(this.query,t)?t:null,h=!!c&&this.mutatedKeys.has(c.key),d=!!l&&(l.hasLocalMutations||this.mutatedKeys.has(l.key)&&l.hasCommittedMutations);let f=!1;c&&l?c.data.isEqual(l.data)?h!==d&&(n.track({type:3,doc:l}),f=!0):this.Qu(c,l)||(n.track({type:2,doc:l}),f=!0,(a&&this.Lu(l,a)>0||u&&this.Lu(l,u)<0)&&(o=!0)):!c&&l?(n.track({type:0,doc:l}),f=!0):c&&!l&&(n.track({type:1,doc:c}),f=!0,(a||u)&&(o=!0)),f&&(l?(i=i.add(l),r=d?r.add(e):r.delete(e)):(i=i.delete(e),r=r.delete(e)))})),null!==this.query.limit)for(;i.size>this.query.limit;){const e="F"===this.query.limitType?i.last():i.first();i=i.delete(e.key),r=r.delete(e.key),n.track({type:1,doc:e})}return{Uu:i,Gu:n,Mi:o,mutatedKeys:r}}Qu(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){const s=this.Uu;this.Uu=e.Uu,this.mutatedKeys=e.mutatedKeys;const r=e.Gu.pu();r.sort(((e,t)=>function(e,t){const n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return w()}};return n(e)-n(t)}(e.type,t.type)||this.Lu(e.doc,t.doc))),this.ju(n);const i=t?this.Wu():[],o=0===this.Bu.size&&this.current?1:0,a=o!==this.$u;return this.$u=o,0!==r.length||a?{snapshot:new ia(this.query,e.Uu,s,r,e.mutatedKeys,0===o,a,!1),zu:i}:{zu:i}}Eu(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Uu:this.Uu,Gu:new ra,mutatedKeys:this.mutatedKeys,Mi:!1},!1)):{zu:[]}}Hu(e){return!this.Fu.has(e)&&!!this.Uu.has(e)&&!this.Uu.get(e).hasLocalMutations}ju(e){e&&(e.addedDocuments.forEach((e=>this.Fu=this.Fu.add(e))),e.modifiedDocuments.forEach((e=>{})),e.removedDocuments.forEach((e=>this.Fu=this.Fu.delete(e))),this.current=e.current)}Wu(){if(!this.current)return[];const e=this.Bu;this.Bu=qn(),this.Uu.forEach((e=>{this.Hu(e.key)&&(this.Bu=this.Bu.add(e.key))}));const t=[];return e.forEach((e=>{this.Bu.has(e)||t.push(new ga(e))})),this.Bu.forEach((n=>{e.has(n)||t.push(new ma(n))})),t}Ju(e){this.Fu=e.ji,this.Bu=qn();const t=this.Ku(e.documents);return this.applyChanges(t,!0)}Yu(){return ia.fromInitialDocuments(this.query,this.Uu,this.mutatedKeys,0===this.$u)}}class ya{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class wa{constructor(e){this.key=e,this.Xu=!1}}class va{constructor(e,t,n,s,r,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=s,this.currentUser=r,this.maxConcurrentLimboResolutions=i,this.Zu={},this.tc=new kn((e=>Bt(e)),Ut),this.ec=new Map,this.nc=new Set,this.sc=new ye(K.comparator),this.ic=new Map,this.rc=new xi,this.oc={},this.uc=new Map,this.cc=ti.Rn(),this.onlineState="Unknown",this.ac=void 0}get isPrimaryClient(){return!0===this.ac}}async function Ia(e,t){const n=ja(e);let s,r;const i=n.tc.get(t);if(i)s=i.targetId,n.sharedClientState.addLocalQueryTarget(s),r=i.view.Yu();else{const e=await Wi(n.localStore,Ft(t));n.isPrimaryClient&&Co(n.remoteStore,e);const i=n.sharedClientState.addLocalQueryTarget(e.targetId);s=e.targetId,r=await Ea(n,t,s,"current"===i)}return r}async function Ea(e,t,n,s){e.hc=(t,n,s)=>async function(e,t,n,s){let r=t.view.Ku(n);r.Mi&&(r=await Yi(e.localStore,t.query,!1).then((({documents:e})=>t.view.Ku(e,r))));const i=s&&s.targetChanges.get(t.targetId),o=t.view.applyChanges(r,e.isPrimaryClient,i);return Va(e,t.targetId,o.zu),o.snapshot}(e,t,n,s);const r=await Yi(e.localStore,t,!0),i=new pa(t,r.ji),o=i.Ku(r.documents),a=zn.createSynthesizedTargetChangeForCurrentChange(n,s&&"Offline"!==e.onlineState),u=i.applyChanges(o,e.isPrimaryClient,a);Va(e,n,u.zu);const c=new ya(t,n,i);return e.tc.set(t,c),e.ec.has(n)?e.ec.get(n).push(t):e.ec.set(n,[t]),u.snapshot}async function ba(e,t){const n=I(e),s=n.tc.get(t),r=n.ec.get(s.targetId);if(r.length>1)return n.ec.set(s.targetId,r.filter((e=>!Ut(e,t)))),void n.tc.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(s.targetId),n.sharedClientState.isActiveQueryTarget(s.targetId)||await Ji(n.localStore,s.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(s.targetId),ko(n.remoteStore,s.targetId),ka(n,s.targetId)})).catch(ee)):(ka(n,s.targetId),await Ji(n.localStore,s.targetId,!0))}async function Ta(e,t){const n=I(e);try{const e=await function(e,t){const n=I(e),s=t.snapshotVersion;let r=n.$i;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(e=>{const i=n.Ui.newChangeBuffer({trackRemovals:!0});r=n.$i;const o=[];t.targetChanges.forEach(((i,a)=>{const u=r.get(a);if(!u)return;o.push(n.Vs.removeMatchingKeys(e,i.removedDocuments,a).next((()=>n.Vs.addMatchingKeys(e,i.addedDocuments,a))));let c=u.withSequenceNumber(e.currentSequenceNumber);t.targetMismatches.has(a)?c=c.withResumeToken(Se.EMPTY_BYTE_STRING,F.min()).withLastLimboFreeSnapshotVersion(F.min()):i.resumeToken.approximateByteSize()>0&&(c=c.withResumeToken(i.resumeToken,s)),r=r.insert(a,c),function(e,t,n){return 0===e.resumeToken.approximateByteSize()||t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(u,c,i)&&o.push(n.Vs.updateTargetData(e,c))}));let a=Vn(),u=qn();if(t.documentUpdates.forEach((s=>{t.resolvedLimboDocuments.has(s)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(e,s))})),o.push(Qi(e,i,t.documentUpdates).next((e=>{a=e.Gi,u=e.Qi}))),!s.isEqual(F.min())){const t=n.Vs.getLastRemoteSnapshotVersion(e).next((t=>n.Vs.setTargetsMetadata(e,e.currentSequenceNumber,s)));o.push(t)}return te.waitFor(o).next((()=>i.apply(e))).next((()=>n.localDocuments.getLocalViewOfDocuments(e,a,u))).next((()=>a))})).then((e=>(n.$i=r,e)))}(n.localStore,t);t.targetChanges.forEach(((e,t)=>{const s=n.ic.get(t);s&&(v(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),e.addedDocuments.size>0?s.Xu=!0:e.modifiedDocuments.size>0?v(s.Xu):e.removedDocuments.size>0&&(v(s.Xu),s.Xu=!1))})),await Oa(n,e,t)}catch(e){await ee(e)}}function Sa(e,t,n){const s=I(e);if(s.isPrimaryClient&&0===n||!s.isPrimaryClient&&1===n){const e=[];s.tc.forEach(((n,s)=>{const r=s.view.Eu(t);r.snapshot&&e.push(r.snapshot)})),function(e,t){const n=I(e);n.onlineState=t;let s=!1;n.queries.forEach(((e,n)=>{for(const r of n.listeners)r.Eu(t)&&(s=!0)})),s&&da(n)}(s.eventManager,t),e.length&&s.Zu.Go(e),s.onlineState=t,s.isPrimaryClient&&s.sharedClientState.setOnlineState(t)}}async function xa(e,t,n){const s=I(e);s.sharedClientState.updateQueryState(t,"rejected",n);const r=s.ic.get(t),i=r&&r.key;if(i){let e=new ye(K.comparator);e=e.insert(i,ot.newNoDocument(i,F.min()));const n=qn().add(i),r=new $n(F.min(),new Map,new Ie(M),e,n);await Ta(s,r),s.sc=s.sc.remove(i),s.ic.delete(t),Ra(s)}else await Ji(s.localStore,t,!1).then((()=>ka(s,t,n))).catch(ee)}async function Da(e,t){const n=I(e),s=t.batch.batchId;try{const e=await function(e,t){const n=I(e);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(e=>{const s=t.batch.keys(),r=n.Ui.newChangeBuffer({trackRemovals:!0});return function(e,t,n,s){const r=n.batch,i=r.keys();let o=te.resolve();return i.forEach((e=>{o=o.next((()=>s.getEntry(t,e))).next((t=>{const i=n.docVersions.get(e);v(null!==i),t.version.compareTo(i)<0&&(r.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),s.addEntry(t)))}))})),o.next((()=>e.mutationQueue.removeMutationBatch(t,r)))}(n,e,t,r).next((()=>r.apply(e))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,s,t.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=qn();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t)))).next((()=>n.localDocuments.getDocuments(e,s)))}))}(n.localStore,t);Ca(n,s,null),Aa(n,s),n.sharedClientState.updateMutationState(s,"acknowledged"),await Oa(n,e)}catch(e){await ee(e)}}async function Na(e,t,n){const s=I(e);try{const e=await function(e,t){const n=I(e);return n.persistence.runTransaction("Reject batch","readwrite-primary",(e=>{let s;return n.mutationQueue.lookupMutationBatch(e,t).next((t=>(v(null!==t),s=t.keys(),n.mutationQueue.removeMutationBatch(e,t)))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,s,t))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,s))).next((()=>n.localDocuments.getDocuments(e,s)))}))}(s.localStore,t);Ca(s,t,n),Aa(s,t),s.sharedClientState.updateMutationState(t,"rejected",n),await Oa(s,e)}catch(n){await ee(n)}}function Aa(e,t){(e.uc.get(t)||[]).forEach((e=>{e.resolve()})),e.uc.delete(t)}function Ca(e,t,n){const s=I(e);let r=s.oc[s.currentUser.toKey()];if(r){const e=r.get(t);e&&(n?e.reject(n):e.resolve(),r=r.remove(t)),s.oc[s.currentUser.toKey()]=r}}function ka(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const s of e.ec.get(t))e.tc.delete(s),n&&e.Zu.lc(s,n);e.ec.delete(t),e.isPrimaryClient&&e.rc.us(t).forEach((t=>{e.rc.containsKey(t)||_a(e,t)}))}function _a(e,t){e.nc.delete(t.path.canonicalString());const n=e.sc.get(t);null!==n&&(ko(e.remoteStore,n),e.sc=e.sc.remove(t),e.ic.delete(n),Ra(e))}function Va(e,t,n){for(const s of n)s instanceof ma?(e.rc.addReference(s.key,t),Ma(e,s)):s instanceof ga?(m("SyncEngine","Document no longer in limbo: "+s.key),e.rc.removeReference(s.key,t),e.rc.containsKey(s.key)||_a(e,s.key)):w()}function Ma(e,t){const n=t.key,s=n.path.canonicalString();e.sc.get(n)||e.nc.has(s)||(m("SyncEngine","New document in limbo: "+n),e.nc.add(s),Ra(e))}function Ra(e){for(;e.nc.size>0&&e.sc.size<e.maxConcurrentLimboResolutions;){const t=e.nc.values().next().value;e.nc.delete(t);const n=new K(U.fromString(t)),s=e.cc.next();e.ic.set(s,new wa(n)),e.sc=e.sc.insert(n,s),Co(e.remoteStore,new ur(Ft(_t(n.path)),s,2,fe.ot))}}async function Oa(e,t,n){const s=I(e),r=[],i=[],o=[];s.tc.isEmpty()||(s.tc.forEach(((e,a)=>{o.push(s.hc(a,t,n).then((e=>{if(e){s.isPrimaryClient&&s.sharedClientState.updateQueryState(a.targetId,e.fromCache?"not-current":"current"),r.push(e);const t=qi.Vi(a.targetId,e);i.push(t)}})))})),await Promise.all(o),s.Zu.Go(r),await async function(e,t){const n=I(e);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(e=>te.forEach(t,(t=>te.forEach(t.Pi,(s=>n.persistence.referenceDelegate.addReference(e,t.targetId,s))).next((()=>te.forEach(t.vi,(s=>n.persistence.referenceDelegate.removeReference(e,t.targetId,s)))))))))}catch(e){if(!oe(e))throw e;m("LocalStore","Failed to update sequence numbers: "+e)}for(const s of t){const e=s.targetId;if(!s.fromCache){const t=n.$i.get(e),s=t.snapshotVersion,r=t.withLastLimboFreeSnapshotVersion(s);n.$i=n.$i.insert(e,r)}}}(s.localStore,i))}async function La(e,t){const n=I(e);if(!n.currentUser.isEqual(t)){m("SyncEngine","User change. New user:",t.toKey());const e=await zi(n.localStore,t);n.currentUser=t,function(e,t){e.uc.forEach((e=>{e.forEach((e=>{e.reject(new b(E.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),e.uc.clear()}(n),n.sharedClientState.handleUserChange(t,e.removedBatchIds,e.addedBatchIds),await Oa(n,e.Ki)}}function Fa(e,t){const n=I(e),s=n.ic.get(t);if(s&&s.Xu)return qn().add(s.key);{let e=qn();const s=n.ec.get(t);if(!s)return e;for(const t of s){const s=n.tc.get(t);e=e.unionWith(s.view.qu)}return e}}async function Pa(e,t){const n=I(e),s=await Yi(n.localStore,t.query,!0),r=t.view.Ju(s);return n.isPrimaryClient&&Va(n,t.targetId,r.zu),r}async function Ua(e,t){const n=I(e);return Zi(n.localStore,t).then((e=>Oa(n,e)))}async function Ba(e,t,n,s){const r=I(e),i=await function(e,t){const n=I(e),s=I(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",(e=>s.yn(e,t).next((t=>t?n.localDocuments.getDocuments(e,t):te.resolve(null)))))}(r.localStore,t);null!==i?("pending"===n?await Ko(r.remoteStore):"acknowledged"===n||"rejected"===n?(Ca(r,t,s||null),Aa(r,t),function(e,t){I(I(e).mutationQueue).In(t)}(r.localStore,t)):w(),await Oa(r,i)):m("SyncEngine","Cannot apply mutation batch with id: "+t)}async function qa(e,t,n){const s=I(e),r=[],i=[];for(const o of t){let e;const t=s.ec.get(o);if(t&&0!==t.length){e=await Wi(s.localStore,Ft(t[0]));for(const e of t){const t=s.tc.get(e),n=await Pa(s,t);n.snapshot&&i.push(n.snapshot)}}else{const t=await Xi(s.localStore,o);e=await Wi(s.localStore,t),await Ea(s,Ka(t),o,!1)}r.push(e)}return s.Zu.Go(i),r}function Ka(e){return kt(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function Ga(e){const t=I(e);return I(I(t.localStore).persistence).Ri()}async function $a(e,t,n,s){const r=I(e);if(r.ac)return void m("SyncEngine","Ignoring unexpected query state notification.");const i=r.ec.get(t);if(i&&i.length>0)switch(n){case"current":case"not-current":{const e=await Zi(r.localStore,Gt(i[0])),s=$n.createSynthesizedRemoteEventForCurrentChange(t,"current"===n);await Oa(r,e,s);break}case"rejected":await Ji(r.localStore,t,!0),ka(r,t,s);break;default:w()}}async function za(e,t,n){const s=ja(e);if(s.ac){for(const e of t){if(s.ec.has(e)){m("SyncEngine","Adding an already active target "+e);continue}const t=await Xi(s.localStore,e),n=await Wi(s.localStore,t);await Ea(s,Ka(t),n.targetId,!1),Co(s.remoteStore,n)}for(const e of n)s.ec.has(e)&&await Ji(s.localStore,e,!1).then((()=>{ko(s.remoteStore,e),ka(s,e)})).catch(ee)}}function ja(e){const t=I(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=Ta.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=Fa.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=xa.bind(null,t),t.Zu.Go=la.bind(null,t.eventManager),t.Zu.lc=ha.bind(null,t.eventManager),t}function Qa(e){const t=I(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=Da.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=Na.bind(null,t),t}class Ha{constructor(){this.synchronizeTabs=!1}async initialize(e){this.wt=vo(e.databaseInfo.databaseId),this.sharedClientState=this.dc(e),this.persistence=this._c(e),await this.persistence.start(),this.localStore=this.wc(e),this.gcScheduler=this.mc(e,this.localStore),this.indexBackfillerScheduler=this.gc(e,this.localStore)}mc(e,t){return null}gc(e,t){return null}wc(e){return $i(this.persistence,new Ki,e.initialUser,this.wt)}_c(e){return new _i(Mi.Os,this.wt)}dc(e){return new lo}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class Wa extends Ha{constructor(e,t,n){super(),this.yc=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.yc.initialize(this,e),await Qa(this.yc.syncEngine),await Ko(this.yc.remoteStore),await this.persistence.ci((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve())))}wc(e){return $i(this.persistence,new Ki,e.initialUser,this.wt)}mc(e,t){const n=this.persistence.referenceDelegate.garbageCollector;return new ui(n,e.asyncQueue,t)}gc(e,t){const n=new de(t,this.persistence);return new he(e.asyncQueue,n)}_c(e){const t=Bi(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Qr.withCacheSize(this.cacheSizeBytes):Qr.DEFAULT;return new Fi(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,yo(),wo(),this.wt,this.sharedClientState,!!this.forceOwnership)}dc(e){return new lo}}class Ja extends Wa{constructor(e,t){super(e,t,!1),this.yc=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);const t=this.yc.syncEngine;this.sharedClientState instanceof co&&(this.sharedClientState.syncEngine={kr:Ba.bind(null,t),Mr:$a.bind(null,t),Or:za.bind(null,t),Ri:Ga.bind(null,t),Nr:Ua.bind(null,t)},await this.sharedClientState.start()),await this.persistence.ci((async e=>{await async function(e,t){const n=I(e);if(ja(n),Qa(n),!0===t&&!0!==n.ac){const e=n.sharedClientState.getAllActiveQueryTargets(),t=await qa(n,e.toArray());n.ac=!0,await Xo(n.remoteStore,!0);for(const s of t)Co(n.remoteStore,s)}else if(!1===t&&!1!==n.ac){const e=[];let t=Promise.resolve();n.ec.forEach(((s,r)=>{n.sharedClientState.isLocalQueryTarget(r)?e.push(r):t=t.then((()=>(ka(n,r),Ji(n.localStore,r,!0)))),ko(n.remoteStore,r)})),await t,await qa(n,e),function(e){const t=I(e);t.ic.forEach(((e,n)=>{ko(t.remoteStore,n)})),t.rc.cs(),t.ic=new Map,t.sc=new ye(K.comparator)}(n),n.ac=!1,await Xo(n.remoteStore,!1)}}(this.yc.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())}))}dc(e){const t=yo();if(!co.V(t))throw new b(E.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=Bi(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new co(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class Ya{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Sa(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=La.bind(null,this.syncEngine),await Xo(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new aa}createDatastore(e){const t=vo(e.databaseInfo.databaseId),n=(s=e.databaseInfo,new po(s));var s;return function(e,t,n,s){return new So(e,t,n,s)}(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){return t=this.localStore,n=this.datastore,s=e.asyncQueue,r=e=>Sa(this.syncEngine,e,0),i=fo.V()?new fo:new ho,new Do(t,n,s,r,i);var t,n,s,r,i}createSyncEngine(e,t){return function(e,t,n,s,r,i,o){const a=new va(e,t,n,s,r,i);return o&&(a.ac=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return async function(e){const t=I(e);m("RemoteStore","RemoteStore shutting down."),t.lu.add(5),await Ao(t),t.du.shutdown(),t._u.set("Unknown")}(this.remoteStore)}}class Xa{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Ic(this.observer.next,e)}error(e){this.observer.error?this.Ic(this.observer.error,e):g("Uncaught Error in snapshot listener:",e)}Tc(){this.muted=!0}Ic(e,t){this.muted||setTimeout((()=>{this.muted||e(t)}),0)}}class Za{constructor(e,t,n,s){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=s,this.user=l.UNAUTHENTICATED,this.clientId=V.I(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async e=>{m("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e})),this.appCheckCredentials.start(n,(e=>(m("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user))))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new b(E.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const e=new T;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){const n=na(t,"Failed to shutdown persistence");e.reject(n)}})),e.promise}}async function eu(e,t){e.asyncQueue.verifyOperationInProgress(),m("FirestoreClient","Initializing OfflineComponentProvider");const n=await e.getConfiguration();await t.initialize(n);let s=n.initialUser;e.setCredentialChangeListener((async e=>{s.isEqual(e)||(await zi(t.localStore,e),s=e)})),t.persistence.setDatabaseDeletedListener((()=>e.terminate())),e.offlineComponents=t}async function tu(e,t){e.asyncQueue.verifyOperationInProgress();const n=await nu(e);m("FirestoreClient","Initializing OnlineComponentProvider");const s=await e.getConfiguration();await t.initialize(n,s),e.setCredentialChangeListener((e=>Yo(t.remoteStore,e))),e.setAppCheckTokenChangeListener(((e,n)=>Yo(t.remoteStore,n))),e.onlineComponents=t}async function nu(e){return e.offlineComponents||(m("FirestoreClient","Using default OfflineComponentProvider"),await eu(e,new Ha)),e.offlineComponents}async function su(e){return e.onlineComponents||(m("FirestoreClient","Using default OnlineComponentProvider"),await tu(e,new Ya)),e.onlineComponents}function ru(e){return nu(e).then((e=>e.localStore))}function iu(e){return su(e).then((e=>e.syncEngine))}async function ou(e){const t=await su(e),n=t.eventManager;return n.onListen=Ia.bind(null,t.syncEngine),n.onUnlisten=ba.bind(null,t.syncEngine),n}function au(e,t,n={}){const s=new T;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,s,r){const i=new Xa({next:n=>{t.enqueueAndForget((()=>ca(e,o))),n.fromCache&&"server"===s.source?r.reject(new b(E.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):r.resolve(n)},error:e=>r.reject(e)}),o=new fa(n,i,{includeMetadataChanges:!0,Du:!0});return ua(e,o)}(await ou(e),e.asyncQueue,t,n,s))),s.promise}const uu=new Map;function cu(e,t,n){if(!n)throw new b(E.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function lu(e){if(!K.isDocumentKey(e))throw new b(E.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function hu(e){if(K.isDocumentKey(e))throw new b(E.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function du(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{const t=function(e){return e.constructor?e.constructor.name:null}(e);return t?`a custom ${t} object`:"an object"}}return"function"==typeof e?"a function":w()}function fu(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new b(E.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=du(e);throw new b(E.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}function mu(e,t){if(t<=0)throw new b(E.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class gu{constructor(e){var t;if(void 0===e.host){if(void 0!==e.ssl)throw new b(E.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new b(E.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.useFetchStreams=!!e.useFetchStreams,function(e,t,n,s){if(!0===t&&!0===s)throw new b(E.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling)}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class pu{constructor(e,t,n){this._authCredentials=t,this._appCheckCredentials=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new gu({}),this._settingsFrozen=!1,e instanceof Me?this._databaseId=e:(this._app=e,this._databaseId=function(e){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new b(E.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Me(e.options.projectId)}(e))}get app(){if(!this._app)throw new b(E.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new b(E.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new gu(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new x;switch(e.type){case"gapi":const t=e.client;return v(!("object"!=typeof t||null===t||!t.auth||!t.auth.getAuthHeaderValueForFirstParty)),new A(t,e.sessionIndex||"0",e.iamToken||null);case"provider":return e.client;default:throw new b(E.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=uu.get(e);t&&(m("ComponentProvider","Removing Datastore"),uu.delete(e),t.terminate())}(this),Promise.resolve()}}class yu{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new vu(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new yu(this.firestore,e,this._key)}}class wu{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new wu(this.firestore,e,this._query)}}class vu extends wu{constructor(e,t,n){super(e,t,_t(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new yu(this.firestore,null,new K(e))}withConverter(e){return new vu(this.firestore,e,this._path)}}function Iu(e,t,...n){if(e=(0,o.m9)(e),cu("collection","path",t),e instanceof pu){const s=U.fromString(t,...n);return hu(s),new vu(e,null,s)}{if(!(e instanceof yu||e instanceof vu))throw new b(E.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=e._path.child(U.fromString(t,...n));return hu(s),new vu(e.firestore,null,s)}}function Eu(e,t,...n){if(e=(0,o.m9)(e),1===arguments.length&&(t=V.I()),cu("doc","path",t),e instanceof pu){const s=U.fromString(t,...n);return lu(s),new yu(e,null,new K(s))}{if(!(e instanceof yu||e instanceof vu))throw new b(E.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=e._path.child(U.fromString(t,...n));return lu(s),new yu(e.firestore,e instanceof vu?e.converter:null,new K(s))}}class bu{constructor(){this.Mc=Promise.resolve(),this.Oc=[],this.Fc=!1,this.$c=[],this.Bc=null,this.Lc=!1,this.Uc=!1,this.qc=[],this.So=new Io(this,"async_queue_retry"),this.Kc=()=>{const e=wo();e&&m("AsyncQueue","Visibility state changed to "+e.visibilityState),this.So.Eo()};const e=wo();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.Kc)}get isShuttingDown(){return this.Fc}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Gc(),this.Qc(e)}enterRestrictedMode(e){if(!this.Fc){this.Fc=!0,this.Uc=e||!1;const t=wo();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Kc)}}enqueue(e){if(this.Gc(),this.Fc)return new Promise((()=>{}));const t=new T;return this.Qc((()=>this.Fc&&this.Uc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise))).then((()=>t.promise))}enqueueRetryable(e){this.enqueueAndForget((()=>(this.Oc.push(e),this.jc())))}async jc(){if(0!==this.Oc.length){try{await this.Oc[0](),this.Oc.shift(),this.So.reset()}catch(e){if(!oe(e))throw e;m("AsyncQueue","Operation failed with retryable error: "+e)}this.Oc.length>0&&this.So.Io((()=>this.jc()))}}Qc(e){const t=this.Mc.then((()=>(this.Lc=!0,e().catch((e=>{this.Bc=e,this.Lc=!1;const t=function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e);throw g("INTERNAL UNHANDLED ERROR: ",t),e})).then((e=>(this.Lc=!1,e))))));return this.Mc=t,t}enqueueAfterDelay(e,t,n){this.Gc(),this.qc.indexOf(e)>-1&&(t=0);const s=ta.createAndSchedule(this,e,t,n,(e=>this.Wc(e)));return this.$c.push(s),s}Gc(){this.Bc&&w()}verifyOperationInProgress(){}async zc(){let e;do{e=this.Mc,await e}while(e!==this.Mc)}Hc(e){for(const t of this.$c)if(t.timerId===e)return!0;return!1}Jc(e){return this.zc().then((()=>{this.$c.sort(((e,t)=>e.targetTimeMs-t.targetTimeMs));for(const t of this.$c)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.zc()}))}Yc(e){this.qc.push(e)}Wc(e){const t=this.$c.indexOf(e);this.$c.splice(t,1)}}class Tu extends pu{constructor(e,t,n){super(e,t,n),this.type="firestore",this._queue=new bu,this._persistenceKey="name"in e?e.name:"[DEFAULT]"}_terminate(){return this._firestoreClient||Du(this),this._firestoreClient.terminate()}}function Su(e=(0,s.Mq)()){return(0,s.qX)(e,"firestore").getImmediate()}function xu(e){return e._firestoreClient||Du(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function Du(e){var t;const n=e._freezeSettings(),s=function(e,t,n,s){return new Ve(e,t,n,s.host,s.ssl,s.experimentalForceLongPolling,s.experimentalAutoDetectLongPolling,s.useFetchStreams)}(e._databaseId,(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",e._persistenceKey,n);e._firestoreClient=new Za(e._authCredentials,e._appCheckCredentials,e._queue,s)}function Nu(e){Cu(e=fu(e,Tu));const t=xu(e),n=e._freezeSettings(),s=new Ya;return Au(t,s,new Ja(s,n.cacheSizeBytes))}function Au(e,t,n){const s=new T;return e.asyncQueue.enqueue((async()=>{try{await eu(e,n),await tu(e,t),s.resolve()}catch(e){const n=e;if(!function(e){return"FirebaseError"===e.name?e.code===E.FAILED_PRECONDITION||e.code===E.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||(22===e.code||20===e.code||11===e.code)}(n))throw n;p("Error enabling offline persistence. Falling back to persistence disabled: "+n),s.reject(n)}})).then((()=>s.promise))}function Cu(e){if(e._initialized||e._terminated)throw new b(E.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class ku{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new b(E.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new q(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}function _u(){return new ku("__name__")}class Vu{constructor(e){this._byteString=e}static fromBase64String(e){try{return new Vu(Se.fromBase64String(e))}catch(e){throw new b(E.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new Vu(Se.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class Mu{constructor(e){this._methodName=e}}class Ru{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new b(E.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new b(E.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return M(this._lat,e._lat)||M(this._long,e._long)}}const Ou=/^__.*__$/;class Lu{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new vn(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function Fu(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw w()}}class Pu{constructor(e,t,n,s,r,i){this.settings=e,this.databaseId=t,this.wt=n,this.ignoreUndefinedProperties=s,void 0===r&&this.Xc(),this.fieldTransforms=r||[],this.fieldMask=i||[]}get path(){return this.settings.path}get Zc(){return this.settings.Zc}ta(e){return new Pu(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.wt,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}ea(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),s=this.ta({path:n,na:!1});return s.sa(e),s}ia(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),s=this.ta({path:n,na:!1});return s.Xc(),s}ra(e){return this.ta({path:void 0,na:!0})}oa(e){return Zu(e,this.settings.methodName,this.settings.ua||!1,this.path,this.settings.ca)}contains(e){return void 0!==this.fieldMask.find((t=>e.isPrefixOf(t)))||void 0!==this.fieldTransforms.find((t=>e.isPrefixOf(t.field)))}Xc(){if(this.path)for(let e=0;e<this.path.length;e++)this.sa(this.path.get(e))}sa(e){if(0===e.length)throw this.oa("Document fields must not be empty");if(Fu(this.Zc)&&Ou.test(e))throw this.oa('Document fields cannot begin and end with "__"')}}class Uu{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.wt=n||vo(e)}aa(e,t,n,s=!1){return new Pu({Zc:e,methodName:t,ca:n,path:q.emptyPath(),na:!1,ua:s},this.databaseId,this.wt,this.ignoreUndefinedProperties)}}function Bu(e){const t=e._freezeSettings(),n=vo(e._databaseId);return new Uu(e._databaseId,!!t.ignoreUndefinedProperties,n)}class qu extends Mu{_toFieldTransform(e){if(2!==e.Zc)throw 1===e.Zc?e.oa(`${this._methodName}() can only appear at the top level of your update data`):e.oa(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof qu}}class Ku extends Mu{constructor(e,t){super(e),this.la=t}_toFieldTransform(e){const t=new rn(e.wt,Ht(e.wt,this.la));return new un(e.path,t)}isEqual(e){return this===e}}function Gu(e,t,n,s){const r=e.aa(1,t,n);Wu("Data must be an object, but it was:",r,s);const i=[],a=rt.empty();ge(s,((e,s)=>{const u=Xu(t,e,n);s=(0,o.m9)(s);const c=r.ia(u);if(s instanceof qu)i.push(u);else{const e=ju(s,c);null!=e&&(i.push(u),a.set(u,e))}}));const u=new Te(i);return new Lu(a,u,r.fieldTransforms)}function $u(e,t,n,s,r,i){const a=e.aa(1,t,n),u=[Ju(t,s,n)],c=[r];if(i.length%2!=0)throw new b(E.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let o=0;o<i.length;o+=2)u.push(Ju(t,i[o])),c.push(i[o+1]);const l=[],h=rt.empty();for(let f=u.length-1;f>=0;--f)if(!ec(l,u[f])){const e=u[f];let t=c[f];t=(0,o.m9)(t);const n=a.ia(e);if(t instanceof qu)l.push(e);else{const s=ju(t,n);null!=s&&(l.push(e),h.set(e,s))}}const d=new Te(l);return new Lu(h,d,a.fieldTransforms)}function zu(e,t,n,s=!1){return ju(n,e.aa(s?4:3,t))}function ju(e,t){if(Hu(e=(0,o.m9)(e)))return Wu("Unsupported field value:",t,e),Qu(e,t);if(e instanceof Mu)return function(e,t){if(!Fu(t.Zc))throw t.oa(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.oa(`${e._methodName}() is not currently supported inside arrays`);const n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.na&&4!==t.Zc)throw t.oa("Nested arrays are not supported");return function(e,t){const n=[];let s=0;for(const r of e){let e=ju(r,t.ra(s));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),s++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=(0,o.m9)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return Ht(t.wt,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){const n=L.fromDate(e);return{timestampValue:ns(t.wt,n)}}if(e instanceof L){const n=new L(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:ns(t.wt,n)}}if(e instanceof Ru)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof Vu)return{bytesValue:ss(t.wt,e._byteString)};if(e instanceof yu){const n=t.databaseId,s=e.firestore._databaseId;if(!s.isEqual(n))throw t.oa(`Document reference is for database ${s.projectId}/${s.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:os(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.oa(`Unsupported field value: ${du(e)}`)}(e,t)}function Qu(e,t){const n={};return pe(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):ge(e,((e,s)=>{const r=ju(s,t.ea(e));null!=r&&(n[e]=r)})),{mapValue:{fields:n}}}function Hu(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof L||e instanceof Ru||e instanceof Vu||e instanceof yu||e instanceof Mu)}function Wu(e,t,n){if(!Hu(n)||!function(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}(n)){const s=du(n);throw"an object"===s?t.oa(e+" a custom object"):t.oa(e+" "+s)}}function Ju(e,t,n){if((t=(0,o.m9)(t))instanceof ku)return t._internalPath;if("string"==typeof t)return Xu(e,t);throw Zu("Field path arguments must be of type string or ",e,!1,void 0,n)}const Yu=new RegExp("[~\\*/\\[\\]]");function Xu(e,t,n){if(t.search(Yu)>=0)throw Zu(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new ku(...t.split("."))._internalPath}catch(s){throw Zu(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function Zu(e,t,n,s,r){const i=s&&!s.isEmpty(),o=void 0!==r;let a=`Function ${t}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let u="";return(i||o)&&(u+=" (found",i&&(u+=` in field ${s}`),o&&(u+=` in document ${r}`),u+=")"),new b(E.INVALID_ARGUMENT,a+e+u)}function ec(e,t){return e.some((e=>e.isEqual(t)))}class tc{constructor(e,t,n,s,r){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=s,this._converter=r}get id(){return this._key.path.lastSegment()}get ref(){return new yu(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new nc(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(sc("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class nc extends tc{data(){return super.data()}}function sc(e,t){return"string"==typeof t?Xu(e,t):t instanceof ku?t._internalPath:t._delegate._internalPath}class rc{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class ic extends tc{constructor(e,t,n,s,r,i){super(e,t,n,s,i),this._firestore=e,this._firestoreImpl=e,this.metadata=r}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new oc(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const n=this._document.data.field(sc("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class oc extends ic{data(e={}){return super.data(e)}}class ac{constructor(e,t,n,s){this._firestore=e,this._userDataWriter=t,this._snapshot=s,this.metadata=new rc(s.hasPendingWrites,s.fromCache),this.query=n}get docs(){const e=[];return this.forEach((t=>e.push(t))),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach((n=>{e.call(t,new oc(this._firestore,this._userDataWriter,n.key,n,new rc(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(e={}){const t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new b(E.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map((n=>({type:"added",doc:new oc(e._firestore,e._userDataWriter,n.doc.key,n.doc,new rc(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter),oldIndex:-1,newIndex:t++})))}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter((e=>t||3!==e.type)).map((t=>{const s=new oc(e._firestore,e._userDataWriter,t.doc.key,t.doc,new rc(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter);let r=-1,i=-1;return 0!==t.type&&(r=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(n=n.add(t.doc),i=n.indexOf(t.doc.key)),{type:uc(t.type),doc:s,oldIndex:r,newIndex:i}}))}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function uc(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return w()}}class cc{}function lc(e,...t){for(const n of t)e=n._apply(e);return e}class hc extends cc{constructor(e,t,n){super(),this.fa=e,this.da=t,this._a=n,this.type="where"}_apply(e){const t=Bu(e.firestore),n=function(e,t,n,s,r,i,o){let a;if(r.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new b(E.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){wc(o,i);const t=[];for(const n of o)t.push(yc(s,e,n));a={arrayValue:{values:t}}}else a=yc(s,e,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||wc(o,i),a=zu(n,"where",o,"in"===i||"not-in"===i);const u=gt.create(r,i,a);return function(e,t){if(t.ht()){const n=Rt(e);if(null!==n&&!n.isEqual(t.field))throw new b(E.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${n.toString()}' and '${t.field.toString()}'`);const s=Mt(e);null!==s&&vc(e,t.field,s)}const n=function(e,t){for(const n of e.filters)if(t.indexOf(n.op)>=0)return n.op;return null}(e,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new b(E.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new b(E.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}(e,u),u}(e._query,0,t,e.firestore._databaseId,this.fa,this.da,this._a);return new wu(e.firestore,e.converter,function(e,t){const n=e.filters.concat([t]);return new Ct(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}(e._query,n))}}function dc(e,t,n){const s=t,r=sc("where",e);return new hc(r,s,n)}class fc extends cc{constructor(e,t){super(),this.fa=e,this.wa=t,this.type="orderBy"}_apply(e){const t=function(e,t,n){if(null!==e.startAt)throw new b(E.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new b(E.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const s=new xt(t,n);return function(e,t){if(null===Mt(e)){const n=Rt(e);null!==n&&vc(e,n,t.field)}}(e,s),s}(e._query,this.fa,this.wa);return new wu(e.firestore,e.converter,function(e,t){const n=e.explicitOrderBy.concat([t]);return new Ct(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}function mc(e,t="asc"){const n=t,s=sc("orderBy",e);return new fc(s,n)}class gc extends cc{constructor(e,t,n){super(),this.type=e,this.ma=t,this.ga=n}_apply(e){return new wu(e.firestore,e.converter,Pt(e._query,this.ma,this.ga))}}function pc(e){return mu("limit",e),new gc("limit",e,"F")}function yc(e,t,n){if("string"==typeof(n=(0,o.m9)(n))){if(""===n)throw new b(E.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Ot(t)&&-1!==n.indexOf("/"))throw new b(E.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const s=t.path.child(U.fromString(n));if(!K.isDocumentKey(s))throw new b(E.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${s}' is not because it has an odd number of segments (${s.length}).`);return je(e,new K(s))}if(n instanceof yu)return je(e,n._key);throw new b(E.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${du(n)}.`)}function wc(e,t){if(!Array.isArray(e)||0===e.length)throw new b(E.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`);if(e.length>10)throw new b(E.INVALID_ARGUMENT,`Invalid Query. '${t.toString()}' filters support a maximum of 10 elements in the value array.`)}function vc(e,t,n){if(!n.isEqual(t))throw new b(E.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${t.toString()}' and so you must also use '${t.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class Ic{convertValue(e,t="none"){switch(Ue(e)){case 0:return null;case 1:return e.booleanValue;case 2:return Ne(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(Ae(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw w()}}convertObject(e,t){const n={};return ge(e.fields,((e,s)=>{n[e]=this.convertValue(s,t)})),n}convertGeoPoint(e){return new Ru(Ne(e.latitude),Ne(e.longitude))}convertArray(e,t){return(e.values||[]).map((e=>this.convertValue(e,t)))}convertServerTimestamp(e,t){switch(t){case"previous":const n=ke(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(_e(e));default:return null}}convertTimestamp(e){const t=De(e);return new L(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=U.fromString(e);v(Cs(n));const s=new Me(n.get(1),n.get(3)),r=new K(n.popFirst(5));return s.isEqual(t)||g(`Document ${r} contains a document reference within a different database (${s.projectId}/${s.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),r}}class Ec extends Ic{constructor(e){super(),this.firestore=e}convertBytes(e){return new Vu(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new yu(this.firestore,null,t)}}function bc(e){e=fu(e,wu);const t=fu(e.firestore,Tu),n=xu(t),s=new Ec(t);return function(e,t){const n=new T;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const s=await Yi(e,t,!0),r=new pa(t,s.ji),i=r.Ku(s.documents),o=r.applyChanges(i,!1);n.resolve(o.snapshot)}catch(e){const s=na(e,`Failed to execute query '${t} against cache`);n.reject(s)}}(await ru(e),t,n))),n.promise}(n,e._query).then((n=>new ac(t,s,e,n)))}function Tc(e){e=fu(e,wu);const t=fu(e.firestore,Tu),n=xu(t),s=new Ec(t);return au(n,e._query,{source:"server"}).then((n=>new ac(t,s,e,n)))}function Sc(e,t,n,...s){e=fu(e,yu);const r=fu(e.firestore,Tu),i=Bu(r);let a;return a="string"==typeof(t=(0,o.m9)(t))||t instanceof ku?$u(i,"updateDoc",e._key,t,n,s):Gu(i,"updateDoc",e._key,t),xc(r,[a.toMutation(e._key,ln.exists(!0))])}function xc(e,t){return function(e,t){const n=new T;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){const s=Qa(e);try{const e=await function(e,t){const n=I(e),s=L.now(),r=t.reduce(((e,t)=>e.add(t.key)),qn());let i,o;return n.persistence.runTransaction("Locally write mutations","readwrite",(e=>{let a=Vn(),u=qn();return n.Ui.getEntries(e,r).next((e=>{a=e,a.forEach(((e,t)=>{t.isValidDocument()||(u=u.add(e))}))})).next((()=>n.localDocuments.getOverlayedDocuments(e,a))).next((r=>{i=r;const o=[];for(const e of t){const t=pn(e,i.get(e.key).overlayedDocument);null!=t&&o.push(new vn(e.key,t,it(t.value.mapValue),ln.exists(!0)))}return n.mutationQueue.addMutationBatch(e,s,o,t)})).next((t=>{o=t;const s=t.applyToLocalDocumentSet(i,u);return n.documentOverlayCache.saveOverlays(e,t.batchId,s)}))})).then((()=>({batchId:o.batchId,changes:On(i)})))}(s.localStore,t);s.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let s=e.oc[e.currentUser.toKey()];s||(s=new ye(M)),s=s.insert(t,n),e.oc[e.currentUser.toKey()]=s}(s,e.batchId,n),await Oa(s,e.changes),await Ko(s.remoteStore)}catch(e){const t=na(e,"Failed to persist write");n.reject(t)}}(await iu(e),t,n))),n.promise}(xu(e),t)}function Dc(e){return new Ku("increment",e)}!function(e,t=!0){!function(e){h=e}(s.Jn),(0,s.Xd)(new r.wA("firestore",((e,{options:n})=>{const s=e.getProvider("app").getImmediate(),r=new Tu(s,new D(e.getProvider("auth-internal")),new k(e.getProvider("app-check-internal")));return n=Object.assign({useFetchStreams:t},n),r._setSettings(n),r}),"PUBLIC")),(0,s.KN)(c,"3.4.14",e),(0,s.KN)(c,"3.4.14","esm2017")}()}}]);